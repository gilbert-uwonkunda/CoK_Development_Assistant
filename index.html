<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>🌌 TerraNebular</title>
    
    <!-- ArcGIS CSS (using lightweight dark theme for faster rendering) -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css">
    
    <style>
        /* Optimized Cosmic Color Palette */
        :root {
            --nebular-deep-blue: #0F172A;
            --nebular-space-blue: #1E3A8A;
            --nebular-cosmic-purple: #6366F1;
            --nebular-stellar-gold: #F59E0B;
            --nebular-plasma-pink: #EC4899;
            --nebular-void-black: #000000;
            --nebular-stardust: #E2E8F0;
            --nebular-aurora-green: #10B981;
            --nebular-comet-white: #F8FAFC;
            --nebular-meteor-orange: #F97316;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--nebular-deep-blue); /* Simplified background for faster load */
            overflow: hidden;
        }
        
        #viewDiv {
            height: 100vh;
            width: 100%;
            position: relative;
        }
        
        /* Simplified Header */
        #mobileHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--nebular-deep-blue);
            color: var(--nebular-comet-white);
            padding: 8px 12px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.4);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }
        
        .control-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .location-btn, .api-btn {
            background: var(--nebular-stellar-gold);
            color: var(--nebular-comet-white);
            border: none;
            padding: 5px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease; /* Reduced animation complexity */
        }

        .api-btn {
            background: var(--nebular-cosmic-purple);
        }
        
        .location-btn:hover, .api-btn:hover {
            background: var(--nebular-meteor-orange);
        }

        .api-btn:hover {
            background: var(--nebular-plasma-pink);
        }
        
        .location-btn:disabled, .api-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-deep-blue);
            cursor: not-allowed;
        }
        
        .app-title {
            font-size: 14px;
            font-weight: 700;
            margin: 0;
        }
        
        .app-subtitle {
            font-size: 10px;
            opacity: 0.8;
            margin: 2px 0 0 0;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 9px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--nebular-stellar-gold);
        }
        
        .status-dot.ready {
            background: var(--nebular-aurora-green);
        }
        
        /* Simplified Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--nebular-comet-white);
            border-radius: 12px;
            padding: 16px;
            max-width: 360px;
            width: 85%;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.3);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--nebular-deep-blue);
            margin: 0 0 12px 0;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--nebular-stardust);
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
            outline: none;
        }

        .modal-input:focus {
            border-color: var(--nebular-cosmic-purple);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: var(--nebular-cosmic-purple);
            color: var(--nebular-comet-white);
        }

        .modal-btn.secondary {
            background: var(--nebular-stardust);
            color: var(--nebular-deep-blue);
        }
        
        /* Simplified Bottom Panel */
        #bottomPanel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--nebular-comet-white);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -4px 16px rgba(15, 23, 42, 0.2);
            z-index: 100;
            max-height: 50vh;
            transition: transform 0.2s ease;
            transform: translateY(100%);
        }
        
        #bottomPanel.show {
            transform: translateY(0);
        }
        
        .panel-handle {
            width: 30px;
            height: 3px;
            background: var(--nebular-cosmic-purple);
            border-radius: 1px;
            margin: 8px auto;
        }
        
        .panel-content {
            padding: 0 16px 16px;
            overflow-y: auto;
            max-height: 40vh;
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .zone-info {
            flex: 1;
        }
        
        .zone-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--nebular-deep-blue);
            margin: 0;
        }
        
        .zone-description {
            font-size: 11px;
            color: var(--nebular-space-blue);
            margin: 0;
        }
        
        .zone-color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid var(--nebular-comet-white);
        }
        
        /* Simplified Chat Interface */
        .chat-container {
            background: var(--nebular-comet-white);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            display: none;
        }
        
        .chat-container.show {
            display: block;
        }
        
        .ai-response {
            background: var(--nebular-stardust);
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid var(--nebular-cosmic-purple);
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            margin-bottom: 10px;
            color: var(--nebular-deep-blue);
        }
        
        .chat-input-container {
            display: flex;
            gap: 6px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--nebular-stardust);
            border-radius: 16px;
            font-size: 12px;
            resize: none;
            min-height: 36px;
            max-height: 72px;
            outline: none;
            background: var(--nebular-comet-white);
            color: var(--nebular-deep-blue);
        }
        
        .chat-input:focus {
            border-color: var(--nebular-cosmic-purple);
        }
        
        .chat-input::placeholder {
            color: var(--nebular-space-blue);
        }
        
        .send-btn {
            background: var(--nebular-cosmic-purple);
            color: var(--nebular-comet-white);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-space-blue);
        }
        
        /* Simplified Data Banner */
        .data-banner {
            position: absolute;
            top: 60px;
            left: 12px;
            right: 12px;
            background: var(--nebular-cosmic-purple);
            color: var(--nebular-comet-white);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            z-index: 99;
            cursor: pointer;
            transform: translateY(-100px);
            transition: transform 0.2s ease;
        }
        
        .data-banner.show {
            transform: translateY(0);
        }
        
        .data-banner.loaded {
            background: var(--nebular-aurora-green);
        }
        
        /* Simplified Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            flex-direction: column;
            gap: 16px;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid rgba(226, 232, 240, 0.3);
            border-top: 2px solid var(--nebular-cosmic-purple);
            border-radius: 50%;
            animation: cosmicSpin 0.8s linear infinite;
        }
        
        @keyframes cosmicSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--nebular-comet-white);
            font-weight: 600;
            font-size: 12px;
        }
        
        /* Simplified Response States */
        .response-success {
            border-left-color: var(--nebular-aurora-green);
            background: #ECFDF5;
        }
        
        .response-warning {
            border-left-color: var(--nebular-stellar-gold);
            background: #FFFBEB;
        }
        
        .response-error {
            border-left-color: var(--nebular-plasma-pink);
            background: #FDF2F8;
        }
        
        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .quick-actions .location-btn {
            font-size: 10px;
            padding: 5px 10px;
            background: var(--nebular-cosmic-purple);
        }
        
        /* Minimal Mobile Responsiveness */
        @media (max-width: 480px) {
            .panel-content {
                padding: 0 10px 12px;
            }
            
            .app-title {
                font-size: 13px;
            }
            
            .app-subtitle {
                font-size: 9px;
            }
            
            .location-btn, .api-btn {
                padding: 4px 6px;
                font-size: 8px;
            }
            
            .quick-actions .location-btn {
                font-size: 9px;
                padding: 4px 8px;
            }
            
            .zone-name {
                font-size: 13px;
            }
            
            .zone-description {
                font-size: 10px;
            }
            
            .ai-response {
                padding: 8px;
                font-size: 11px;
            }
            
            .chat-input {
                padding: 8px 10px;
                font-size: 11px;
                min-height: 34px;
            }
            
            .send-btn {
                width: 34px;
                height: 34px;
                border-radius: 17px;
            }
        }
    </style>
</head>
<body>
    <!-- Hidden file upload -->
    <input type="file" id="fileUpload" accept=".json,.geojson" />
    
    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal-content">
            <h3 class="modal-title">🚀 Claude API Configuration</h3>
            <input type="password" id="apiKeyInput" class="modal-input" 
                   placeholder="Enter your Claude API key" />
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeApiModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveApiKey()">Save Key</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Header -->
    <div id="mobileHeader">
        <div class="header-content">
            <div>
                <h1 class="app-title">🌌 TerraNebular</h1>
                <p class="app-subtitle">AI-Powered Zoning Insights</p>
            </div>
            <div class="header-controls">
                <div class="control-row">
                    <button class="api-btn" id="apiKeyBtn" onclick="showApiModal()">
                        🤖 Setup AI
                    </button>
                    <button class="location-btn" id="useLocationBtn" onclick="useCurrentLocation()">
                        📍 Use My Location
                    </button>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Status Banner -->
    <div class="data-banner" id="dataBanner" onclick="loadDataFile()">
        🌌 Tap to load zoning data
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading map...</div>
    </div>
    
    <!-- Map Container -->
    <div id="viewDiv"></div>
    
    <!-- Bottom Panel -->
    <div id="bottomPanel">
        <div class="panel-handle"></div>
        <div class="panel-content">
            <div class="location-header" id="locationHeader" style="display: none;">
                <div class="zone-color-indicator" id="zoneColorIndicator"></div>
                <div class="zone-info">
                    <h3 class="zone-name" id="zoneName">Select a location</h3>
                    <p class="zone-description" id="zoneDescription">Tap anywhere on the map</p>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="ai-response" id="aiResponse"></div>
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Ask about zoning: 'Can I build a restaurant?', 'Max height?', 'Investment potential?'" 
                              rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ArcGIS JavaScript API -->
    <script src="https://js.arcgis.com/4.28/"></script>
    
    <script>
    let currentLocation = null;
    let currentZoning = null;
    let view = null;
    let zoningFeatures = [];
    let spatialIndex = new Map();
    let conversationHistory = [];
    let claudeApiKey = null;

    // Simplified Zoning Regulations
    const KIGALI_ZONING_REGULATIONS = {
        'C1-Mixed use zone': {
            description: 'Mixed-use zone for commercial and residential activities',
            permitted: ['Commercial/Retail', 'Restaurants', 'Offices', 'Residential'],
            prohibited: ['Industrial Uses', 'Major Infrastructure'],
            conditional: ['Hotels', 'Petrol stations'],
            minLotSize: '500 m²',
            maxHeight: 'G+4',
            maxFAR: '1.6',
            coverage: '60%'
        },
        'C3-City commercial zone': {
            description: 'Zone for large-scale retail and commercial services',
            permitted: ['Shopping centres', 'Offices', 'Hotels'],
            prohibited: ['Major Industrial Uses'],
            conditional: ['Public Facilities'],
            minLotSize: '1,000 m²',
            maxHeight: 'G+10',
            maxFAR: '2.4',
            coverage: '70%'
        },
        'R1-Low density residential zone': {
            description: 'Zone for single-family homes and villas',
            permitted: ['Single family houses'],
            prohibited: ['Industrial uses'],
            conditional: ['Apartments', 'Guest houses'],
            minLotSize: '500 m²',
            maxHeight: 'G+1+P',
            maxFAR: '0.5',
            coverage: '40%'
        }
    };

    // Zone color mapping
    const ZONE_COLORS = {
        'C1-Mixed use zone': '#FFB6C1',
        'C3-City commercial zone': '#CD5626',
        'R1-Low density residential zone': '#FFFFE0'
    };

    // API Configuration Functions
    function showApiModal() {
        const modal = document.getElementById('apiKeyModal');
        modal.classList.add('show');
        document.getElementById('apiKeyInput').focus();
    }

    function closeApiModal() {
        document.getElementById('apiKeyModal').classList.remove('show');
    }

    function saveApiKey() {
        const input = document.getElementById('apiKeyInput');
        const key = input.value.trim();
        
        if (!key) {
            alert('Please enter a valid API key');
            return;
        }
        
        if (!key.startsWith('sk-ant-')) {
            alert('Invalid API key format');
            return;
        }
        
        claudeApiKey = key;
        sessionStorage.setItem('claude_api_key', key);
        document.getElementById('apiKeyBtn').innerHTML = '✅ AI Ready';
        closeApiModal();
    }

    // Simplified Claude API Integration
    async function callClaudeAPI(message, context = {}) {
        if (!claudeApiKey) throw new Error('No API key configured');
        
        const systemPrompt = `You are an expert in Kigali zoning regulations. Provide concise answers based on:
- Zone: ${context.zoneName || 'Unknown'}
- Coordinates: ${context.coordinates || 'Not specified'}
Always suggest contacting City of Kigali for official confirmation.`;
        
        try {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': claudeApiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-3-sonnet-20240229',
                    max_tokens: 500,
                    system: systemPrompt,
                    messages: [{ role: 'user', content: message }]
                })
            });
            
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();
            return data.content[0].text;
        } catch (error) {
            throw new Error(`Claude API Error: ${error.message}`);
        }
    }

    // Simplified Response Generation
    async function generateSmartResponse(question, zoning) {
        const zoneName = zoning.zoneName;
        const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
            description: 'Unknown zone',
            permitted: ['Check regulations'],
            prohibited: ['Check regulations'],
            conditional: ['Check regulations'],
            maxHeight: 'Check regulations',
            minLotSize: 'Check regulations',
            coverage: 'Check regulations'
        };

        if (claudeApiKey) {
            try {
                const context = {
                    zoneName,
                    zoneDescription: regulations.description,
                    coordinates: currentLocation ? `${currentLocation.latitude}, ${currentLocation.longitude}` : null
                };
                return await callClaudeAPI(question, context);
            } catch (error) {
                return `⚠️ AI unavailable: ${error.message}\n\n${generateLocalResponse(question, zoning)}`;
            }
        }
        return generateLocalResponse(question, zoning);
    }

    function generateLocalResponse(question, zoning) {
        const zoneName = zoning.zoneName;
        const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
            description: 'Unknown zone',
            permitted: ['Check regulations'],
            prohibited: ['Check regulations'],
            conditional: ['Check regulations'],
            maxHeight: 'Check regulations',
            minLotSize: 'Check regulations',
            coverage: 'Check regulations'
        };

        const buildingType = extractBuildingType(question);
        if (buildingType) {
            const isPermitted = regulations.permitted.some(item => item.toLowerCase().includes(buildingType));
            if (isPermitted) {
                return `✅ ${buildingType.toUpperCase()} allowed in ${zoneName}\nMax Height: ${regulations.maxHeight}\nContact City of Kigali for permits.`;
            }
            return `❌ ${buildingType.toUpperCase()} not allowed in ${zoneName}\nContact City of Kigali for alternatives.`;
        }
        return `📍 ${zoneName}\nPermitted: ${regulations.permitted.join(', ')}\nMax Height: ${regulations.maxHeight}\nContact City of Kigali for details.`;
    }

    function extractBuildingType(question) {
        const lowerQuestion = question.toLowerCase();
        const types = ['restaurant', 'hotel', 'house', 'shop', 'apartment', 'office'];
        return types.find(type => lowerQuestion.includes(type)) || null;
    }

    function useCurrentLocation() {
        if (!navigator.geolocation) {
            alert('Geolocation not supported');
            return;
        }
        
        const btn = document.getElementById('useLocationBtn');
        btn.disabled = true;
        btn.innerHTML = '🛰️ Scanning...';
        updateStatus('loading', 'Getting location...');
        
        navigator.geolocation.getCurrentPosition(
            position => {
                const { latitude, longitude } = position.coords;
                if (latitude < -2.2 || latitude > -1.7 || longitude < 29.8 || longitude > 30.3) {
                    alert('Location outside Kigali');
                    updateStatus('ready', 'Location outside Kigali');
                    btn.disabled = false;
                    btn.innerHTML = '📍 Use My Location';
                    return;
                }
                
                view.center = [longitude, latitude];
                view.zoom = 16;
                require(["esri/geometry/Point"], function(Point) {
                    handleMapClick({ mapPoint: new Point({ longitude, latitude, spatialReference: view.spatialReference }) });
                });
                
                btn.disabled = false;
                btn.innerHTML = '📍 Use My Location';
                updateStatus('ready', 'Location found');
            },
            error => {
                alert('Geolocation error: ' + error.message);
                updateStatus('ready', 'Location error');
                btn.disabled = false;
                btn.innerHTML = '📍 Use My Location';
            },
            { enableHighAccuracy: true, timeout: 5000 }
        );
    }

    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        updateStatus('loading', 'Initializing map...');
        showLoading(true, 'Loading map...');
        
        require([
            "esri/Map",
            "esri/views/MapView"
        ], function(Map, MapView) {
            const map = new Map({
                basemap: "streets-vector" // Lightweight vector basemap
            });
            
            view = new MapView({
                container: "viewDiv",
                map: map,
                center: [30.0619, -1.9441],
                zoom: 13,
                ui: { components: ["attribution"] }
            });
            
            view.on("click", handleMapClick);
            view.when(() => {
                showLoading(false);
                updateStatus('ready', 'Map ready');
            });
        });
        
        document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
        document.getElementById('chatInput').addEventListener('input', autoResizeTextarea);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        document.getElementById('apiKeyModal').addEventListener('click', function(e) {
            if (e.target === this) closeApiModal();
        });
        showDataBanner();
    }

    function autoResizeTextarea() {
        const textarea = document.getElementById('chatInput');
        textarea.style.height = 'auto';
        textarea.style.height = `${Math.min(textarea.scrollHeight, 72)}px`;
    }

    function addQuickActionButtons() {
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer.querySelector('.quick-actions')) return;
        
        const quickActions = document.createElement('div');
        quickActions.className = 'quick-actions';
        
        const actions = [
            { text: 'Restaurant?', question: 'Can I build a restaurant?' },
            { text: 'Max Height?', question: 'What is the maximum height?' }
        ];

        actions.forEach(action => {
            const button = document.createElement('button');
            button.className = 'location-btn';
            button.textContent = action.text;
            button.onclick = () => askQuestion(action.question);
            quickActions.appendChild(button);
        });

        chatContainer.insertBefore(quickActions, chatContainer.querySelector('.ai-response'));
    }

    function askQuestion(question) {
        const chatInput = document.getElementById('chatInput');
        chatInput.value = question;
        autoResizeTextarea();
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const question = input.value.trim();
        if (!question || !currentZoning) return;
        
        const sendBtn = document.getElementById('sendBtn');
        const aiResponse = document.getElementById('aiResponse');
        const chatContainer = document.getElementById('chatContainer');
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '⏳';
        aiResponse.innerHTML = 'Analyzing...';
        aiResponse.className = 'ai-response';
        chatContainer.classList.add('show');
        
        input.value = '';
        input.style.height = 'auto';
        
        try {
            const response = await generateSmartResponse(question, currentZoning);
            aiResponse.innerHTML = response;
            aiResponse.className = 'ai-response' + (response.includes('✅') ? ' response-success' : response.includes('❌') ? ' response-error' : '');
            addQuickActionButtons();
        } catch (error) {
            aiResponse.innerHTML = '❌ Error: ' + error.message;
            aiResponse.className = 'ai-response response-error';
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '➤';
        }
    }

    function displayLocationInfo(zoning) {
        const zoneName = zoning.zoneName;
        const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || { description: 'Unknown zone' };
        
        document.getElementById('zoneName').textContent = zoneName;
        document.getElementById('zoneDescription').textContent = regulations.description;
        document.getElementById('zoneColorIndicator').style.background = ZONE_COLORS[zoneName] || '#999999';
        document.getElementById('locationHeader').style.display = 'flex';
        
        const aiResponse = document.getElementById('aiResponse');
        const chatContainer = document.getElementById('chatContainer');
        aiResponse.innerHTML = `📍 Selected: ${zoneName}\nAsk about zoning regulations or building options!`;
        aiResponse.className = 'ai-response response-success';
        chatContainer.classList.add('show');
        
        addQuickActionButtons();
    }

    function addLocationPin(point) {
        require(["esri/Graphic", "esri/geometry/Point"], function(Graphic, Point) {
            view.graphics.removeAll();
            const pinGraphic = new Graphic({
                geometry: point,
                symbol: {
                    type: "simple-marker",
                    color: [236, 72, 153, 0.9],
                    size: 10,
                    outline: { color: [255, 255, 255], width: 1 }
                }
            });
            view.graphics.add(pinGraphic);
        });
    }

    function showBottomPanel() {
        document.getElementById('bottomPanel').classList.add('show');
    }

    function showNoDataMessage() {
        const aiResponse = document.getElementById('aiResponse');
        const chatContainer = document.getElementById('chatContainer');
        aiResponse.innerHTML = '🌌 No zoning data found.\nLoad zoning data using the banner above.';
        aiResponse.className = 'ai-response response-error';
        chatContainer.classList.add('show');
    }

    function showDataBanner(loaded = false) {
        const banner = document.getElementById('dataBanner');
        banner.innerHTML = loaded ? '✨ Zoning data loaded' : '🌌 Tap to load zoning data';
        banner.classList.toggle('loaded', loaded);
        banner.classList.add('show');
        if (loaded) setTimeout(() => banner.classList.remove('show'), 2000);
    }

    function updateStatus(status, text) {
        document.getElementById('statusDot').className = `status-dot ${status}`;
        document.getElementById('statusText').textContent = text;
    }

    function showLoading(show, text = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        document.getElementById('loadingText').textContent = text;
        overlay.classList.toggle('show', show);
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoading(true, 'Loading zoning data...');
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            await processZoningData(data);
            showLoading(false);
            showDataBanner(true);
            updateStatus('ready', `${zoningFeatures.length} zones loaded`);
        } catch (error) {
            showLoading(false);
            alert('❌ Error loading file: ' + error.message);
        }
    }

    async function processZoningData(data) {
        let features = data.type === 'FeatureCollection' ? data.features : data.features || data;
        zoningFeatures = [];
        spatialIndex = new Map();
        
        for (let i = 0; i < Math.min(features.length, 1000); i++) { // Limit processing for performance
            const feature = features[i];
            const props = feature.properties || feature.attributes || feature;
            const zoneName = extractZoneName(props);
            
            if (zoneName) {
                const processedFeature = {
                    id: i,
                    zoneName: zoneName,
                    properties: props,
                    bounds: calculateBounds(feature.geometry)
                };
                
                zoningFeatures.push(processedFeature);
                if (processedFeature.bounds) {
                    const gridKey = Math.floor(processedFeature.bounds.centerLat * 1000) + ',' + 
                                   Math.floor(processedFeature.bounds.centerLng * 1000);
                    spatialIndex.set(gridKey, spatialIndex.get(gridKey) || []).push(processedFeature);
                }
            }
        }
    }

    function extractZoneName(properties) {
        const fields = ['New_Zoning', 'zone_code', 'zoning', 'type'];
        for (const field of fields) {
            if (properties[field]) return properties[field].trim();
        }
        return null;
    }

    function calculateBounds(geometry) {
        if (!geometry || !geometry.coordinates) return null;
        try {
            let minLng = Infinity, maxLng = -Infinity, minLat = Infinity, maxLat = -Infinity;
            const processCoordinates = coords => {
                if (typeof coords[0] === 'number') {
                    minLng = Math.min(minLng, coords[0]);
                    maxLng = Math.max(maxLng, coords[0]);
                    minLat = Math.min(minLat, coords[1]);
                    maxLat = Math.max(maxLat, coords[1]);
                } else {
                    coords.forEach(processCoordinates);
                }
            };
            processCoordinates(geometry.coordinates);
            return { minLng, maxLng, minLat, maxLat, centerLng: (minLng + maxLng) / 2, centerLat: (minLat + maxLat) / 2 };
        } catch (error) {
            return null;
        }
    }

    async function handleMapClick(event) {
        if (zoningFeatures.length === 0) {
            showDataBanner();
            return;
        }
        
        currentLocation = event.mapPoint;
        const zoningResult = queryZoningData(event.mapPoint);
        
        if (zoningResult) {
            currentZoning = zoningResult;
            displayLocationInfo(zoningResult);
            showBottomPanel();
            addLocationPin(event.mapPoint);
        } else {
            showNoDataMessage();
        }
    }

    function queryZoningData(point) {
        const lat = point.latitude;
        const lng = point.longitude;
        const gridKey = Math.floor(lat * 1000) + ',' + Math.floor(lng * 1000);
        const nearbyFeatures = spatialIndex.get(gridKey) || [];
        
        for (const feature of nearbyFeatures) {
            if (feature.bounds && 
                lat >= feature.bounds.minLat && lat <= feature.bounds.maxLat &&
                lng >= feature.bounds.minLng && lng <= feature.bounds.maxLng) {
                return { zoneName: feature.zoneName, properties: feature.properties, source: 'official', featureId: feature.id };
            }
        }
        return null;
    }
    </script>
