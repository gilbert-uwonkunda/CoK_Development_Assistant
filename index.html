<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>🌌 TerraNebular</title>
    
    <!-- ArcGIS CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <style>
        :root {
            --nebular-deep-blue: #0F172A;
            --nebular-space-blue: #1E3A8A;
            --nebular-cosmic-purple: #6366F1;
            --nebular-stellar-gold: #F59E0B;
            --nebular-plasma-pink: #EC4899;
            --nebular-void-black: #000000;
            --nebular-stardust: #E2E8F0;
            --nebular-aurora-green: #10B981;
            --nebular-comet-white: #F8FAFC;
            --nebular-meteor-orange: #F97316;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            overflow: hidden;
        }
        
        #viewDiv {
            height: 100vh;
            width: 100%;
            position: relative;
        }
        
        #mobileHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            color: var(--nebular-comet-white);
            padding: 12px 16px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .location-btn {
            background: linear-gradient(135deg, var(--nebular-stellar-gold) 0%, var(--nebular-meteor-orange) 100%);
            color: var(--nebular-comet-white);
            border: none;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }
        
        .location-btn:active {
            transform: translateY(0);
        }
        
        .location-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-deep-blue);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .app-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }
        
        .app-subtitle {
            font-size: 11px;
            opacity: 0.9;
            margin: 2px 0 0 0;
            line-height: 1.3;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--nebular-stellar-gold);
            animation: cosmicPulse 2s infinite;
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
        }
        
        .status-dot.ready {
            background: var(--nebular-aurora-green);
            animation: none;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
        }
        
        @keyframes cosmicPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0წ

System: <xaiArtifact artifact_id="037fc075-89f9-4770-90f9-7a7f11f5f45c" artifact_version_id="65231e3a-5547-4abd-a143-1eb57acfffcb" title="index.html" contentType="text/html">
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>🌌 TerraNebular</title>
    
    <!-- ArcGIS CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <style>
        /* WCAG-compliant color adjustments */
        :root {
            --nebular-deep-blue: #0F172A;
            --nebular-space-blue: #1E3A8A;
            --nebular-cosmic-purple: #4F46E5; /* Adjusted for better contrast */
            --nebular-stellar-gold: #D97706;
            --nebular-plasma-pink: #DB2777; /* Adjusted for better contrast */
            --nebular-void-black: #000000;
            --nebular-stardust: #E2E8F0;
            --nebular-aurora-green: #059669;
            --nebular-comet-white: #F8FAFC;
            --nebular-meteor-orange: #EA580C;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            overflow: hidden;
        }
        
        #viewDiv {
            height: 100vh;
            width: 100%;
            position: relative;
        }
        
        #mobileHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            color: var(--nebular-comet-white);
            padding: 12px 16px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .location-btn {
            background: linear-gradient(135deg, var(--nebular-stellar-gold) 0%, var(--nebular-meteor-orange) 100%);
            color: var(--nebular-comet-white);
            border: none;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }
        
        .location-btn:active {
            transform: translateY(0);
        }
        
        .location-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-deep-blue);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .app-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }
        
        .app-subtitle {
            font-size: 11px;
            opacity: 0.9;
            margin: 2px 0 0 0;
            line-height: 1.3;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--nebular-stellar-gold);
            animation: cosmicPulse 2s infinite;
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
        }
        
        .status-dot.ready {
            background: var(--nebular-aurora-green);
            animation: none;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
        }
        
        @keyframes cosmicPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.1);
                box-shadow: 0 0 12px rgba(245, 158, 11, 0.8);
            }
        }
        
        #bottomPanel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -8px 32px rgba(15, 23, 42, 0.3);
            z-index: 100;
            max-height: 50vh;
            transition: transform 0.3s ease;
            transform: translateY(100%);
            backdrop-filter: blur(10px);
        }
        
        #bottomPanel.show {
            transform: translateY(0);
        }
        
        .panel-handle {
            width: 40px;
            height: 4px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            border-radius: 2px;
            margin: 12px auto 8px;
            opacity: 0.7;
        }
        
        .panel-content {
            padding: 0 20px 20px;
            overflow-y: auto;
            max-height: 40vh;
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .zone-info {
            flex: 1;
        }
        
        .zone-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--nebular-deep-blue);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }
        
        .zone-description {
            font-size: 12px;
            color: var(--nebular-space-blue);
            margin: 0;
            line-height: 1.4;
        }
        
        .zone-color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--nebular-comet-white);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.2);
            flex-shrink: 0;
        }
        
        .chat-container {
            background: linear-gradient(135deg, var(--nebular-stardust) 0%, var(--nebular-comet-white) 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            display: none;
            box-shadow: inset 0 1px 3px rgba(15, 23, 42, 0.1);
        }
        
        .chat-container.show {
            display: block;
        }
        
        .ai-response {
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            padding: 14px;
            border-radius: 12px;
            border-left: 4px solid var(--nebular-cosmic-purple);
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
            color: var(--nebular-deep-blue);
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid var(--nebular-stardust);
            border-radius: 20px;
            font-size: 13px;
            resize: none;
            min-height: 40px;
            max-height: 80px;
            outline: none;
            transition: all 0.3s ease;
            background: var(--nebular-comet-white);
            color: var(--nebular-deep-blue);
        }
        
        .chat-input:focus {
            border-color: var(--nebular-cosmic-purple);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .chat-input::placeholder {
            color: var(--nebular-space-blue);
            font-style: italic;
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: var(--nebular-comet-white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(99, 102, 241, 0.4);
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.6);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .send-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-space-blue);
            box-shadow: none;
            transform: none;
        }
        
        .data-banner {
            position: absolute;
            top: 70px;
            left: 16px;
            right: 16px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: var(--nebular-comet-white);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            z-index: 99;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: translateY(-100px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .data-banner.show {
            transform: translateY(0);
        }
        
        .data-banner.loaded {
            background: linear-gradient(135deg, var(--nebular-aurora-green) 0%, var(--nebular-stellar-gold) 100%);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 58, 138, 0.95) 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            flex-direction: column;
            gap: 20px;
            backdrop-filter: blur(10px);
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(226, 232, 240, 0.3);
            border-top: 3px solid var(--nebular-cosmic-purple);
            border-radius: 50%;
            animation: cosmicSpin 1s linear infinite;
        }
        
        @keyframes cosmicSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--nebular-comet-white);
            font-weight: 600;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .response-success {
            border-left-color: var(--nebular-aurora-green);
            background: linear-gradient(135deg, #ECFDF5 0%, #F0FDF4 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }
        
        .response-warning {
            border-left-color: var(--nebular-stellar-gold);
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.1);
        }
        
        .response-error {
            border-left-color: var(--nebular-plasma-pink);
            background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.1);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--nebular-deep-blue);
            color: var(--nebular-comet-white);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            background: var(--nebular-plasma-pink);
        }
        
        .toast.success {
            background: var(--nebular-aurora-green);
        }
        
        @media (max-width: 480px) {
            .panel-content {
                padding: 0 12px 16px;
            }
            
            .app-title {
                font-size: 14px;
            }
            
            .app-subtitle {
                font-size: 10px;
            }
            
            .location-btn {
                padding: 5px 8px;
                font-size: 9px;
            }
            
            .zone-name {
                font-size: 14px;
            }
            
            .zone-description {
                font-size: 11px;
            }
            
            .ai-response {
                padding: 12px;
                font-size: 12px;
            }
            
            .chat-input {
                padding: 10px 12px;
                font-size: 12px;
                min-height: 38px;
            }
            
            .send-btn {
                width: 38px;
                height: 38px;
                border-radius: 19px;
            }
            
            .chat-input::placeholder {
                font-size: 11px;
            }
        }
        
        @media (max-width: 360px) {
            .app-title {
                font-size: 13px;
            }
            
            .app-subtitle {
                font-size: 9px;
            }
            
            .location-btn {
                padding: 4px 6px;
                font-size: 8px;
            }
            
            .panel-content {
                padding: 0 10px 14px;
            }
            
            .zone-name {
                font-size: 13px;
            }
            
            .zone-description {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="mobileHeader" role="banner">
        <div class="header-content">
            <div>
                <h1 class="app-title">🌌 TerraNebular</h1>
                <p class="app-subtitle">Where Development Dreams Take Shape</p>
            </div>
            <div class="header-controls">
                <button class="location-btn" id="useLocationBtn" onclick="useCurrentLocation()" aria-label="Use current location">
                    📍 Use My Location
                </button>
                <div class="status-indicator" role="status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="data-banner" id="dataBanner" role="alert" aria-live="polite">
        🌌 Loading cosmic zoning database...
    </div>
    
    <div class="toast" id="toast" role="alert" aria-live="assertive"></div>
    
    <div class="loading-overlay" id="loadingOverlay" role="status">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading zoning data...</div>
    </div>
    
    <div id="viewDiv" role="main"></div>
    
    <div id="bottomPanel" role="dialog" aria-label="Zoning Information and Chat">
        <div class="panel-handle" role="button" aria-label="Toggle panel"></div>
        <div class="panel-content">
            <div class="location-header" id="locationHeader" style="display: none;">
                <div class="zone-color-indicator" id="zoneColorIndicator"></div>
                <div class="zone-info">
                    <h3 class="zone-name" id="zoneName">Select a location</h3>
                    <p class="zone-description" id="zoneDescription">Tap anywhere on the map</p>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="ai-response" id="aiResponse" role="log" aria-live="polite"></div>
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Ask TerraNebular: 'Can I build a restaurant here?', 'What's the maximum height?', 'Investment potential?'" 
                              rows="1" aria-label="Ask a zoning question"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" aria-label="Send message">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ArcGIS JavaScript API -->
    <script src="https://js.arcgis.com/4.28/"></script>
    <!-- RBush for spatial indexing -->
    <script src="https://unpkg.com/rbush@3.0.1/rbush.min.js"></script>
    <!-- TopoJSON for optimized data loading -->
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    
    <script>
        let currentLocation = null;
        let currentZoning = null;
        let view = null;
        let zoningLayer = null;
        let zoningFeatures = [];
        let spatialIndex = null;
        
        // Kigali Boundary Polygon (simplified GeoJSON for bounds checking)
        const KIGALI_BOUNDS = {
            type: "Feature",
            geometry: {
                type: "Polygon",
                coordinates: [[
                    [29.8, -2.2], [30.3, -2.2], [30.3, -1.7], [29.8, -1.7], [29.8, -2.2]
                ]]
            }
        };
        
        // Enhanced Zone Details
        const KIGALI_ZONING_REGULATIONS = {
            'C1-Mixed use zone': {
                description: 'Zone established to create high flexibility in the mix of uses and ensure continuity in ground level commercial activities',
                permitted: [
                    'Commercial/Retail', 'Restaurants and Recreational activities', 'Office use above 1st floor',
                    'Co-working spaces', 'Residential', 'Home Occupation'
                ],
                prohibited: [
                    'Large scale commercial complex', 'Industrial Uses', 'Major Infrastructure Installations'
                ],
                conditional: [
                    'Public Facilities', 'Transportation Terminals', 'Hotels', 'Petrol stations',
                    'Garages and Car Repair - Grade E as per RBS', 'Car Wash Services'
                ],
                minLotSize: '500 m²',
                maxHeight: 'G+4 maximum (Additional floors may be authorised along BRT, Wetland Front)',
                maxFAR: '1.6 maximum',
                coverage: '60% maximum',
                landscaping: '10% minimum'
            },
            // ... (rest of the regulations remain unchanged)
        };
        
        const ZONE_COLORS = {
            'A1-Agriculture zone': '#90EE90',
            'C1-Mixed use zone': '#FFB6C1',
            'C3-City commercial zone': '#CD5626',
            'I1-Light industrial zone': '#DDA0DD',
            'I2-General industrial zone': '#9370DB',
            'I3-Mining/ Extraction/Quarry': '#8B4513',
            'P1-Parks and open spaces zone': '#32CD32',
            'P2-Sport and Eco tourism zone': '#00FA9A',
            'P3B-Forest zone': '#006400',
            'P3C-Steep slopes (> 30%) zone': '#2E8B57',
            'PA-Public Administration zone': '#87CEEB',
            'PF1-Education and research facilities': '#4169E1',
            'PF2-Health facilities': '#0000FF',
            'PF3-Religious facilities': '#191970',
            'PF4-Cultural/ memorial sites': '#6495ED',
            'PF5-Cemetery/ crematoria': '#B0C4DE',
            'R1-Low density residential zone': '#FFFFE0',
            'R1A-Low density residential densification zone': '#FFFACD',
            'R1B-Rural residential zone': '#F0E68C',
            'R2-Medium density residential - Improvement zone': '#F59E0B',
            'R3-Medium density residential - Expansion zone': '#FF7F50',
            'R4-High density residential zone': '#FF6347',
            'T-Transportation zone': '#A9A9A9',
            'U-Utility zone': '#D3D3D3',
            'W2 - Rehabilitation': '#98FB98',
            'W3 - Sustainable Exploitation': '#90EE90',
            'W4 - Conservation': '#8FBC8F',
            'W5 - Recreational': '#87CEEB',
            'WR-Waterbody zone': '#87CEEB'
        };
        
        function useCurrentLocation() {
            const btn = document.getElementById('useLocationBtn');
            
            if (!navigator.geolocation) {
                showToast('🛸 Your device cannot detect cosmic coordinates', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '🛰️ Scanning...';
            updateStatus('loading', 'Getting your location...');
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    require(["esri/geometry/Point", "esri/geometry/support/geodesy"], function(Point, geodesy) {
                        const userPoint = new Point({
                            longitude: lng,
                            latitude: lat,
                            spatialReference: { wkid: 4326 }
                        });
                        
                        // Check if point is within Kigali bounds
                        require(["esri/geometry/geometryEngine"], function(geometryEngine) {
                            const kigaliPolygon = new esri.geometry.Polygon(KIGALI_BOUNDS.geometry);
                            if (!geometryEngine.contains(kigaliPolygon, userPoint)) {
                                btn.disabled = false;
                                btn.innerHTML = '📍 Use My Location';
                                updateStatus('ready', 'Location outside Kigali area');
                                showToast('🚀 Your cosmic coordinates are outside the Kigali development galaxy.\n\nTerraNebular is optimized for Kigali.', 'error');
                                return;
                            }
                            
                            view.center = [lng, lat];
                            view.zoom = 16;
                            handleMapClick({ mapPoint: userPoint });
                            
                            btn.disabled = false;
                            btn.innerHTML = '✨ Location Found';
                            updateStatus('ready', 'Analyzing your location...');
                            
                            setTimeout(() => {
                                btn.innerHTML = '📍 Use My Location';
                            }, 3000);
                        });
                    });
                },
                error => {
                    btn.disabled = false;
                    btn.innerHTML = '📍 Use My Location';
                    let errorMessage;
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '📡 TerraNebular needs access to your cosmic coordinates.\n\nPlease allow location access.';
                            updateStatus('ready', 'Location permission denied');
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '🛸 Unable to detect your cosmic position.\n\nCheck your GPS/internet connection.';
                            updateStatus('ready', 'Location unavailable');
                            break;
                        case error.TIMEOUT:
                            errorMessage = '⏰ Cosmic location scan timed out.\n\nTry again.';
                            updateStatus('ready', 'Location timeout');
                            break;
                        default:
                            errorMessage = '❌ Unknown cosmic navigation error.\n\nTry tapping on the map.';
                            updateStatus('ready', 'Location error');
                            break;
                    }
                    showToast(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            autoLoadZoningData();
        });
        
        function initializeApp() {
            updateStatus('loading', 'Initializing map...');
            
            require([
                "esri/Map",
                "esri/views/MapView",
                "esri/Graphic",
                "esri/geometry/Point",
                "esri/layers/GeoJSONLayer",
                "esri/geometry/geometryEngine"
            ], function(Map, MapView, Graphic, Point, GeoJSONLayer, geometryEngine) {
                const map = new Map({
                    basemap: "hybrid"
                });
                
                zoningLayer = new GeoJSONLayer({
                    url: "./Zoning.json",
                    renderer: {
                        type: "unique-value",
                        field: "New_Zoning",
                        uniqueValueInfos: Object.entries(ZONE_COLORS).map(([zone, color]) => ({
                            value: zone,
                            symbol: {
                                type: "simple-fill",
                                color: color,
                                outline: { color: [255, 255, 255, 0.5], width: 1 }
                            }
                        }))
                    },
                    opacity: 0.6
                });
                
                map.add(zoningLayer);
                
                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [30.0619, -1.9441],
                    zoom: 13,
                    ui: {
                        components: ["attribution"]
                    }
                });
                
                view.on("click", handleMapClick);
                view.popup.autoOpenEnabled = false;
                
                view.when(() => {
                    updateStatus('ready', 'Map ready');
                    showToast('✨ Map initialized successfully', 'success');
                });
            });
            
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', autoResizeTextarea);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        async function autoLoadZoningData() {
            updateStatus('loading', 'Loading cosmic zoning database...');
            const banner = document.getElementById('dataBanner');
            banner.innerHTML = '🌌 Loading cosmic zoning database...';
            banner.classList.add('show');
            
            try {
                const cached = await checkCachedData();
                if (cached) {
                    showToast('✨ Loaded zoning data from cache', 'success');
                    return;
                }
                
                console.log('📡 Fetching zoning data from GitHub...');
                const response = await fetch('./Zoning.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                showLoading(true, 'Processing zoning data...');
                
                const data = await response.json();
                const topoData = topojson.topology({ zoning: data });
                const geoData = topojson.feature(topoData, topoData.objects.zoning);
                
                await processZoningData(geoData);
                cacheZoningData();
                
                showLoading(false);
                updateStatus('ready', `${zoningFeatures.length} zones loaded`);
                
                banner.innerHTML = '✨ Cosmic zoning database loaded successfully';
                banner.classList.add('loaded');
                showToast('✨ Zoning data loaded successfully', 'success');
                
                setTimeout(() => {
                    banner.classList.remove('show');
                }, 3000);
                
            } catch (error) {
                showLoading(false);
                console.error('❌ Error loading zoning data:', error);
                banner.innerHTML = '❌ Failed to load cosmic database - using fallback data';
                banner.classList.remove('loaded');
                updateStatus('ready', 'Data load failed - using fallback');
                showToast('⚠️ Failed to load zoning data. Using fallback mode.', 'error');
                
                // Fallback to minimal dataset
                zoningFeatures = [];
                spatialIndex = new rbush();
            }
        }
        
        function generateSmartResponse(question, zoning) {
            const zoneName = zoning.zoneName;
            const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
                description: 'No detailed regulations available.',
                permitted: [],
                prohibited: [],
                conditional: [],
                minLotSize: 'N/A',
                maxHeight: 'N/A',
                coverage: 'N/A'
            };
            
            const lowerQuestion = question.toLowerCase();
            
            // Enhanced regex-based parsing
            const buildingTypes = {
                restaurant: /\b(restaurant|eatery|diner|cafe|food)\b/i,
                hotel: /\b(hotel|lodge|guest house|accommodation)\b/i,
                house: /\b(house|home|residence|dwelling)\b/i,
                shop: /\b(shop|store|retail|boutique)\b/i,
                apartment: /\b(apartment|flat|condo|residential building)\b/i,
                office: /\b(office|workspace|business center)\b/i,
                warehouse: /\b(warehouse|storage|depot)\b/i,
                factory: /\b(factory|manufacturing|industry|plant)\b/i,
                shopping_center: /\b(shopping center|mall|plaza|commercial center)\b/i,
                nightclub: /\b(nightclub|club|disco|bar)\b/i,
                supermarket: /\b(supermarket|grocery|market)\b/i,
                school: /\b(school|education|university|college)\b/i,
                hospital: /\b(hospital|clinic|medical|health center)\b/i
            };
            
            let buildingType = null;
            for (const [type, regex] of Object.entries(buildingTypes)) {
                if (regex.test(lowerQuestion)) {
                    buildingType = type;
                    break;
                }
            }
            
            if (!buildingType) {
                return `📍 Zone: ${zoneName}\n\nWhat you can build here:\n✅ PERMITTED: ${regulations.permitted.slice(0, 5).join(', ')}\n\n❌ PROHIBITED: ${regulations.prohibited.slice(0, 3).join(', ')}\n\n⚠️ CONDITIONAL: ${regulations.conditional.slice(0, 3).join(', ')}\n\n📏 Max Height: ${regulations.maxHeight}\n📐 Min Lot Size: ${regulations.minLotSize}\n🏗️ Max Coverage: ${regulations.coverage}`;
            }
            
            const isPermitted = regulations.permitted.some(item => 
                item.toLowerCase().includes(buildingType) || 
                buildingType.includes(item.toLowerCase().split(' ')[0])
            );
            
            const isProhibited = regulations.prohibited.some(item => 
                item.toLowerCase().includes(buildingType) || 
                buildingType.includes(item.toLowerCase().split(' ')[0])
            );
            
            const isConditional = regulations.conditional.some(item => 
                item.toLowerCase().includes(buildingType) || 
                buildingType.includes(item.toLowerCase().split(' ')[0])
            );
            
            if (isPermitted) {
                return `✅ YES - ${buildingType.toUpperCase()} IS PERMITTED\n\nZone: ${zoneName}\nStatus: FULLY ALLOWED\n\n📋 Requirements:\n• Min lot size: ${regulations.minLotSize}\n• Max height: ${regulations.maxHeight}\n• Max coverage: ${regulations.coverage}\n\n🚀 You can proceed with your ${buildingType} project!\n\n⚖️ Still need: Building permit from City of Kigali`;
            }
            
            if (isProhibited) {
                return `❌ NO - ${buildingType.toUpperCase()} IS PROHIBITED\n\nZone: ${zoneName}\nStatus: NOT ALLOWED\n\n🚫 Prohibited uses include:\n${regulations.prohibited.slice(0, 4).map(item => `• ${item}`).join('\n')}\n\n💡 Consider these zones instead:\n${getSuggestedZones(buildingType).join(', ')}`;
            }
            
            if (isConditional) {
                return `⚠️ MAYBE - ${buildingType.toUpperCase()} NEEDS APPROVAL\n\nZone: ${zoneName}\nStatus: CONDITIONAL USE\n\n📋 Conditional uses in this zone:\n${regulations.conditional.map(item => `• ${item}`).join('\n')}\n\n✅ Next steps:\n1. Apply for conditional use permit\n2. Submit detailed plans to City of Kigali\n3. Meet all specific requirements\n4. Get community consultation if required\n\n📞 Contact: City of Kigali Planning Office`;
            }
            
            return `❓ ${buildingType.toUpperCase()} - CHECK WITH AUTHORITIES\n\nZone: ${zoneName}\n\n✅ PERMITTED: ${regulations.permitted.slice(0, 3).join(', ')}\n❌ PROHIBITED: ${regulations.prohibited.slice(0, 3).join(', ')}\n⚠️ CONDITIONAL: ${regulations.conditional.slice(0, 3).join(', ')}\n\n📞 Contact City of Kigali Planning Office for clarification.`;
        }
        
        function getSuggestedZones(buildingType) {
            const suggestions = {
                restaurant: ['C1-Mixed use zone', 'C3-City commercial zone', 'R2-Medium density residential - Improvement zone'],
                hotel: ['C1-Mixed use zone', 'C3-City commercial zone', 'R4-High density residential zone'],
                house: ['R1-Low density residential zone', 'R2-Medium density residential - Improvement zone', 'R3-Medium density residential - Expansion zone'],
                shop: ['C1-Mixed use zone', 'C3-City commercial zone'],
                apartment: ['R2-Medium density residential - Improvement zone', 'R3-Medium density residential - Expansion zone', 'R4-High density residential zone'],
                office: ['C1-Mixed use zone', 'C3-City commercial zone', 'I1-Light industrial zone'],
                warehouse: ['I1-Light industrial zone', 'I2-General industrial zone'],
                factory: ['I1-Light industrial zone', 'I2-General industrial zone'],
                shopping_center: ['C3-City commercial zone'],
                nightclub: ['C1-Mixed use zone', 'C3-City commercial zone'],
                supermarket: ['C3-City commercial zone'],
                school: ['PF1-Education and research facilities'],
                hospital: ['PF2-Health facilities']
            };
            
            return suggestions[buildingType] || ['C1-Mixed use zone', 'C3-City commercial zone'];
        }
        
        const CACHE_KEY = 'kigali_zoning_data';
        const CACHE_VERSION = '1.0';
        
        async function checkCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (data.version === CACHE_VERSION && data.features) {
                        console.log('📦 Found cached zoning data');
                        await loadCachedData(data);
                        return true;
                    }
                }
            } catch (error) {
                console.warn('Cache check failed:', error);
            }
            return false;
        }
        
        async function loadCachedData(data) {
            updateStatus('loading', 'Loading cached data...');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            zoningFeatures = data.features;
            spatialIndex = new rbush();
            spatialIndex.load(zoningFeatures.map(feature => ({
                minX: feature.bounds.minLng,
                minY: feature.bounds.minLat,
                maxX: feature.bounds.maxLng,
                maxY: feature.bounds.maxLat,
                feature: feature
            })));
            
            updateStatus('ready', `${zoningFeatures.length} zones loaded`);
            const banner = document.getElementById('dataBanner');
            banner.innerHTML = '✨ Cosmic zoning data loaded from cache';
            banner.classList.add('loaded');
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 3000);
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 5000);
        }
        
        async function processZoningData(data) {
            let features = data.features || data;
            
            if (!features || features.length === 0) {
                throw new Error('No features found in JSON file');
            }
            
            zoningFeatures = [];
            spatialIndex = new rbush();
            
            const batchSize = 1000;
            for (let i = 0; i < features.length; i += batchSize) {
                const batch = features.slice(i, i + batchSize);
                for (const feature of batch) {
                    const props = feature.properties || feature.attributes || feature;
                    const zoneName = extractZoneName(props);
                    
                    if (zoneName) {
                        const bounds = calculateBounds(feature.geometry);
                        if (bounds) {
                            const processedFeature = {
                                id: zoningFeatures.length,
                                zoneName: zoneName,
                                properties: props,
                                bounds: bounds
                            };
                            zoningFeatures.push(processedFeature);
                            spatialIndex.insert({
                                minX: bounds.minLng,
                                minY: bounds.minLat,
                                maxX: bounds.maxLng,
                                maxY: bounds.maxLat,
                                feature: processedFeature
                            });
                        }
                    }
                }
                await new Promise(resolve => setTimeout(resolve, 0)); // Yield for responsiveness
            }
        }
        
        function cacheZoningData() {
            try {
                const cacheData = {
                    version: CACHE_VERSION,
                    timestamp: Date.now(),
                    features: zoningFeatures
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                console.log('💾 Zoning data cached successfully');
            } catch (error) {
                console.warn('Failed to cache data:', error);
            }
        }
        
        function extractZoneName(properties) {
            const possibleFields = [
                'New_Zoning', 'new_zoning', 'Zone_Code', 'zone_code',
                'zoning', 'ZONING', 'zone_name', 'type'
            ];
            
            for (const field of possibleFields) {
                if (properties[field] && typeof properties[field] === 'string') {
                    return properties[field].trim();
                }
            }
            return null;
        }
        
        function calculateBounds(geometry) {
            if (!geometry || !geometry.coordinates) return null;
            
            try {
                let minLng = Infinity, maxLng = -Infinity;
                let minLat = Infinity, maxLat = -Infinity;
                
                const processCoordinates = (coords) => {
                    if (typeof coords[0] === 'number') {
                        minLng = Math.min(minLng, coords[0]);
                        maxLng = Math.max(maxLng, coords[0]);
                        minLat = Math.min(minLat, coords[1]);
                        maxLat = Math.max(maxLat, coords[1]);
                    } else {
                        coords.forEach(processCoordinates);
                    }
                };
                
                processCoordinates(geometry.coordinates);
                
                return {
                    minLng, maxLng, minLat, maxLat,
                    centerLng: (minLng + maxLng) / 2,
                    centerLat: (minLat + maxLat) / 2
                };
            } catch (error) {
                return null;
            }
        }
        
        function showLoading(show, text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = text;
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }
        
        async function handleMapClick(event) {
            if (zoningFeatures.length === 0) {
                showDataBanner();
                showToast('⚠️ No zoning data available. Please refresh the page.', 'error');
                return;
            }
            
            currentLocation = event.mapPoint;
            const zoningResult = await queryZoningData(event.mapPoint);
            
            if (zoningResult) {
                currentZoning = zoningResult;
                displayLocationInfo(zoningResult);
                showBottomPanel();
                addLocationPin(event.mapPoint);
            } else {
                showNoDataMessage();
            }
        }
        
        async function queryZoningData(point) {
            const lat = point.latitude;
            const lng = point.longitude;
            
            require(["esri/geometry/Point", "esri/geometry/geometryEngine"], function(Point, geometryEngine) {
                const mapPoint = new Point({
                    longitude: lng,
                    latitude: lat,
                    spatialReference: point.spatialReference
                });
                
                const candidates = spatialIndex.search({
                    minX: lng - 0.005,
                    minY: lat - 0.005,
                    maxX: lng + 0.005,
                    maxY: lat + 0.005
                });
                
                for (const candidate of candidates) {
                    const feature = candidate.feature;
                    const geometry = zoningLayer.queryFeatures({
                        geometry: mapPoint,
                        spatialRelationship: "intersects",
                        returnGeometry: true
                    }).then(result => {
                        if (result.features.length > 0) {
                            const f = result.features[0];
                            return {
                                zoneName: extractZoneName(f.attributes),
                                properties: f.attributes,
                                source: 'official',
                                featureId: feature.id
                            };
                        }
                    });
                    
                    if (geometry) return geometry;
                }
                
                let nearest = null;
                let minDistance = Infinity;
                
                for (const feature of zoningFeatures.slice(0, 500)) {
                    if (!feature.bounds) continue;
                    const distance = Math.sqrt(
                        Math.pow(lat - feature.bounds.centerLat, 2) + 
                        Math.pow(lng - feature.bounds.centerLng, 2)
                    );
                    
                    if (distance < minDistance && distance < 0.005) {
                        minDistance = distance;
                        nearest = {
                            zoneName: feature.zoneName,
                            properties: feature.properties,
                            source: 'approximate',
                            distance: (distance * 111).toFixed(1),
                            featureId: feature.id
                        };
                    }
                }
                
                return nearest;
            });
        }
        
        function displayLocationInfo(zoning) {
            const zoneName = zoning.zoneName;
            const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
                description: 'Development zone per master plan',
                maxHeight: 'Check regulations',
                coverage: 'Per regulations'
            };
            
            document.getElementById('zoneName').textContent = zoneName;
            document.getElementById('zoneDescription').textContent = regulations.description;
            
            const colorIndicator = document.getElementById('zoneColorIndicator');
            const zoneColor = ZONE_COLORS[zoneName] || '#999999';
            colorIndicator.style.background = zoneColor;
            
            document.getElementById('locationHeader').style.display = 'flex';
            
            const chatContainer = document.getElementById('chatContainer');
            const aiResponse = document.getElementById('aiResponse');
            
            aiResponse.innerHTML = `🌌 Welcome to TerraNebular\n\n📍 You've selected: ${zoneName}\n\n✨ Ask about zoning regulations or development opportunities!`;
            aiResponse.className = 'ai-response response-success';
            chatContainer.classList.add('show');
        }
        
        function showBottomPanel() {
            const panel = document.getElementById('bottomPanel');
            panel.classList.add('show');
        }
        
        function hideBottomPanel() {
            const panel = document.getElementById('bottomPanel');
            panel.classList.remove('show');
            if (view) view.graphics.removeAll();
        }
        
        function showNoDataMessage() {
            const panel = document.getElementById('bottomPanel');
            document.getElementById('locationHeader').style.display = 'none';
            
            const chatContainer = document.getElementById('chatContainer');
            const aiResponse = document.getElementById('aiResponse');
            
            aiResponse.innerHTML = "🌌 No cosmic signals detected at this location.\n\nTry exploring developed areas of Kigali or refresh the page.";
            aiResponse.className = 'ai-response response-error';
            chatContainer.classList.add('show');
            panel.classList.add('show');
            showToast('⚠️ No zoning data found for this location.', 'error');
        }
        
        function addLocationPin(point) {
            if (!view) return;
            
            view.graphics.removeAll();
            
            require(["esri/Graphic"], function(Graphic) {
                const pointGraphic = new Graphic({
                    geometry: point,
                    symbol: {
                        type: "simple-marker",
                        color: [236, 72, 153],
                        size: 16,
                        outline: { 
                            color: [248, 250, 252],
                            width: 3 
                        }
                    }
                });
                view.graphics.add(pointGraphic);
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            
            if (!question) {
                showToast('Please enter a question.', 'error');
                return;
            }
            
            if (!currentZoning) {
                showToast('Please select a location on the map first!', 'error');
                return;
            }
            
            const sendBtn = document.getElementById('sendBtn');
            const aiResponse = document.getElementById('aiResponse');
            const chatContainer = document.getElementById('chatContainer');
            
            sendBtn.disabled = true;
            sendBtn.innerHTML = '⏳';
            
            aiResponse.innerHTML = '🌌 Analyzing cosmic development patterns...';
            aiResponse.className = 'ai-response';
            chatContainer.classList.add('show');
            
            input.value = '';
            input.style.height = 'auto';
            
            setTimeout(() => {
                const response = generateSmartResponse(question, currentZoning);
                
                let responseClass = 'ai-response';
                if (response.includes('✅ YES')) {
                    responseClass += ' response-success';
                    showToast('✅ Valid development option detected!', 'success');
                } else if (response.includes('❌ NO')) {
                    responseClass += ' response-error';
                    showToast('❌ Prohibited development option.', 'error');
                } else if (response.includes('⚠️ MAYBE')) {
                    responseClass += ' response-warning';
                    showToast('⚠️ Conditional approval required.', 'warning');
                }
                
                aiResponse.innerHTML = response;
                aiResponse.className = responseClass;
                
                sendBtn.disabled = false;
                sendBtn.innerHTML = '➤';
            }, 1000);
        }
        
        function autoResizeTextarea() {
            const textarea = document.getElementById('chatInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
        }
        
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        
        document.getElementById('bottomPanel').addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
            isDragging = true;
        });
        
        document.getElementById('bottomPanel').addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            
            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;
            
            if (deltaY > 50) {
                hideBottomPanel();
                isDragging = false;
            }
        });
        
        document.getElementById('bottomPanel').addEventListener('touchend', function() {
            isDragging = false;
        });
        
        document.addEventListener('touchend', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });
        
        window.addEventListener('load', function() {
            setTimeout(() => {
                const banner = document.getElementById('dataBanner');
                if (banner.classList.contains('loaded')) {
                    banner.style.transform = 'translateY(-100px)';
                }
            }, 5000);
        });
    </script>
</body>
</html>
