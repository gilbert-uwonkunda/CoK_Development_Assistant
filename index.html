<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0F172A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ZoneAgent - Zero Trips. Instant Compliance.</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --panel-bg: rgba(17, 17, 17, 0.95);
            --panel-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent: #ec4899;
            --accent-glow: rgba(236, 72, 153, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font); background: #000; color: var(--text-primary); }

        /* SPLASH */
        .splash { position: fixed; inset: 0; background: #111; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s, visibility 0.5s; }
        .splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .splash-content { max-width: 360px; padding: 24px; text-align: center; }
        .splash-logo { width: 64px; height: 64px; background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .splash-logo svg { width: 36px; height: 36px; fill: white; }
        .splash-title { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .splash-tagline { color: var(--text-secondary); margin-bottom: 32px; }
        .splash-steps { text-align: left; margin-bottom: 32px; }
        .splash-step { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: var(--radius); margin-bottom: 8px; }
        .step-num { width: 24px; height: 24px; background: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
        .step-text { font-size: 13px; }
        .enter-btn { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: var(--radius); color: white; font-family: var(--font); font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .enter-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px var(--accent-glow); }

        /* MAP */
        .app { position: fixed; inset: 0; display: none; }
        .app.active { display: block; }
        #map { width: 100%; height: 100%; }
        .leaflet-container { background: #1a1a2e; }
        .leaflet-control-attribution { background: var(--panel-bg) !important; color: var(--text-muted) !important; font-size: 10px !important; border-radius: 4px 0 0 0 !important; }
        .leaflet-control-attribution a { color: var(--accent) !important; }
        .leaflet-control-zoom { border: none !important; }
        .leaflet-control-zoom a { background: var(--panel-bg) !important; border: 1px solid var(--panel-border) !important; color: var(--text-primary) !important; width: 32px !important; height: 32px !important; line-height: 32px !important; }
        .leaflet-control-zoom a:hover { background: rgba(255,255,255,0.1) !important; }
        .leaflet-control-zoom-in { border-radius: var(--radius) var(--radius) 0 0 !important; }
        .leaflet-control-zoom-out { border-radius: 0 0 var(--radius) var(--radius) !important; border-top: none !important; }

        /* TOP-LEFT: Logo Badge (Felt style) */
        .logo-badge { position: absolute; top: 16px; left: 16px; z-index: 1000; display: flex; align-items: center; gap: 8px; padding: 8px 14px 8px 8px; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 100px; backdrop-filter: blur(10px); }
        .logo-badge-icon { width: 28px; height: 28px; background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-badge-icon svg { width: 16px; height: 16px; fill: white; }
        .logo-badge-text { font-size: 14px; font-weight: 600; }

        /* TOP-RIGHT: Actions (Felt style) */
        .top-actions { position: absolute; top: 16px; right: 16px; z-index: 1000; display: flex; gap: 8px; }
        .action-pill { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 100px; color: var(--text-primary); font-family: var(--font); font-size: 13px; font-weight: 500; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.2s; }
        .action-pill:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .action-pill svg { width: 16px; height: 16px; fill: currentColor; }
        .action-pill.primary { background: var(--accent); border-color: var(--accent); }
        .action-pill.primary:hover { background: #db2777; }
        .lang-pills { display: flex; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 100px; overflow: hidden; backdrop-filter: blur(10px); }
        .lang-pill { padding: 8px 12px; background: transparent; border: none; color: var(--text-muted); font-family: var(--font); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .lang-pill:hover { color: var(--text-primary); }
        .lang-pill.active { background: var(--accent); color: white; }

        /* LEFT: Legend Panel (Felt style) */
        .legend-panel { position: absolute; top: 70px; left: 16px; z-index: 1000; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: var(--radius-lg); padding: 12px; min-width: 200px; backdrop-filter: blur(10px); }
        .legend-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .legend-item.clickable { cursor: pointer; padding: 8px; margin: -4px -8px; border-radius: var(--radius); transition: background 0.2s; }
        .legend-item.clickable:hover { background: rgba(255,255,255,0.05); }

        /* BOTTOM-LEFT: Map hint */
        .map-hint { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 10px 18px; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 100px; font-size: 13px; color: var(--text-secondary); backdrop-filter: blur(10px); transition: opacity 0.3s, transform 0.3s; }
        .map-hint.hidden { opacity: 0; transform: translateX(-50%) translateY(10px); pointer-events: none; }

        /* RIGHT: Analysis Panel / Chat (Felt style) */
        .analysis-panel { position: absolute; top: 16px; right: 16px; bottom: 16px; width: 340px; z-index: 1000; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: var(--radius-lg); backdrop-filter: blur(10px); display: none; flex-direction: column; overflow: hidden; }
        .analysis-panel.active { display: flex; }
        .panel-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--panel-border); }
        .panel-title { font-size: 15px; font-weight: 600; }
        .panel-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; font-family: monospace; }
        .panel-close { width: 32px; height: 32px; background: transparent; border: 1px solid var(--panel-border); border-radius: var(--radius); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .panel-close:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .panel-close svg { width: 16px; height: 16px; fill: currentColor; }

        /* Zone Info Section */
        .zone-info { padding: 16px; border-bottom: 1px solid var(--panel-border); }
        .zone-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: var(--radius); margin-bottom: 12px; }
        .zone-color { width: 12px; height: 12px; border-radius: 4px; }
        .zone-name { font-size: 13px; font-weight: 500; }
        .zone-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-item { padding: 10px; background: rgba(255,255,255,0.03); border-radius: var(--radius); }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 14px; font-weight: 600; }

        /* Chat Messages */
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 95%; padding: 12px; border-radius: var(--radius); font-size: 13px; line-height: 1.6; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .message.assistant { background: rgba(255,255,255,0.05); align-self: flex-start; }
        .message.user { background: var(--accent); align-self: flex-end; }
        .message.system { background: transparent; border: 1px dashed var(--panel-border); color: var(--text-secondary); align-self: center; text-align: center; font-size: 12px; }
        .message-content { white-space: pre-wrap; }
        .message-content strong { font-weight: 600; }
        .message-content ul { margin: 8px 0; padding-left: 16px; }
        .message-content li { margin-bottom: 4px; }
        .typing-dots { display: flex; gap: 4px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: var(--radius); width: fit-content; }
        .typing-dots span { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); background: var(--accent); } }

        /* Chat Actions */
        .chat-actions { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--panel-border); }
        .chat-action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--panel-border); border-radius: var(--radius); color: var(--text-primary); font-family: var(--font); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .chat-action-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .chat-action-btn.primary { background: var(--success); border-color: var(--success); }
        .chat-action-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* Chat Input */
        .chat-input-area { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--panel-border); }
        .chat-input { flex: 1; padding: 10px 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--panel-border); border-radius: 100px; color: var(--text-primary); font-family: var(--font); font-size: 13px; outline: none; resize: none; min-height: 40px; max-height: 80px; transition: border-color 0.2s; }
        .chat-input:focus { border-color: var(--accent); }
        .chat-input::placeholder { color: var(--text-muted); }
        .send-btn { width: 40px; height: 40px; background: var(--accent); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; flex-shrink: 0; }
        .send-btn:hover { transform: scale(1.1); }
        .send-btn:disabled { background: var(--panel-border); cursor: not-allowed; transform: none; }
        .send-btn svg { width: 18px; height: 18px; fill: currentColor; }

        /* Floating Chat Toggle (when panel closed) */
        .chat-toggle { position: absolute; bottom: 24px; right: 24px; z-index: 1000; width: 56px; height: 56px; background: var(--accent); border: none; border-radius: 50%; color: white; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 20px var(--accent-glow); transition: transform 0.2s; }
        .chat-toggle:hover { transform: scale(1.1); }
        .chat-toggle.visible { display: flex; }
        .chat-toggle svg { width: 24px; height: 24px; fill: currentColor; }

        /* Map Tooltip (Felt style) */
        .map-tooltip { position: absolute; z-index: 1001; padding: 12px 16px; background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: var(--radius); font-size: 13px; max-width: 280px; pointer-events: none; backdrop-filter: blur(10px); box-shadow: var(--shadow); }
        .tooltip-title { font-weight: 600; margin-bottom: 8px; }
        .tooltip-row { display: flex; justify-content: space-between; padding: 4px 0; color: var(--text-secondary); }
        .tooltip-row span:last-child { color: var(--text-primary); font-weight: 500; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .legend-panel { display: none; }
            .top-actions { right: 12px; top: 12px; }
            .logo-badge { left: 12px; top: 12px; }
            .analysis-panel { top: 0; right: 0; bottom: 0; left: 0; width: 100%; border-radius: 0; }
            .analysis-panel.active { animation: slideUp 0.3s ease-out; }
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
            .chat-toggle { bottom: 16px; right: 16px; }
            .map-hint { bottom: 90px; font-size: 12px; }
        }

        @media (max-width: 400px) {
            .logo-badge-text { display: none; }
            .action-pill span { display: none; }
        }

        /* Safe areas */
        @supports (padding: env(safe-area-inset-top)) {
            .logo-badge { top: calc(16px + env(safe-area-inset-top)); }
            .top-actions { top: calc(16px + env(safe-area-inset-top)); }
            .panel-header { padding-top: calc(16px + env(safe-area-inset-top)); }
            .chat-input-area { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>
    <!-- SPLASH -->
    <div class="splash" id="splash">
        <div class="splash-content">
            <div class="splash-logo"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>
            <h1 class="splash-title">ZoneAgent</h1>
            <p class="splash-tagline">Zero Trips. Instant Compliance.</p>
            <div class="splash-steps">
                <div class="splash-step"><div class="step-num">1</div><div class="step-text">Tap any location on the map</div></div>
                <div class="splash-step"><div class="step-num">2</div><div class="step-text">Get instant zoning analysis</div></div>
                <div class="splash-step"><div class="step-num">3</div><div class="step-text">Download compliance report</div></div>
            </div>
            <button class="enter-btn" id="enterBtn">Enter ZoneAgent</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="app">
        <div id="map"></div>

        <!-- Top Left: Logo Badge -->
        <div class="logo-badge">
            <div class="logo-badge-icon"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>
            <span class="logo-badge-text">ZoneAgent</span>
        </div>

        <!-- Top Right: Actions -->
        <div class="top-actions">
            <div class="lang-pills">
                <button class="lang-pill active" data-lang="en">EN</button>
                <button class="lang-pill" data-lang="rw">RW</button>
                <button class="lang-pill" data-lang="fr">FR</button>
            </div>
            <button class="action-pill" id="searchBtn">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <span>Search</span>
            </button>
            <button class="action-pill" id="locationBtn">
                <svg viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
                <span>My Location</span>
            </button>
        </div>

        <!-- Left: Legend -->
        <div class="legend-panel" id="legendPanel">
            <div class="legend-title">Zoning Layers</div>
            <div class="legend-item clickable" data-zone="residential">
                <div class="legend-dot" style="background: #FF7F50;"></div>
                <span>Residential Zones</span>
            </div>
            <div class="legend-item clickable" data-zone="commercial">
                <div class="legend-dot" style="background: #FFB6C1;"></div>
                <span>Commercial Zones</span>
            </div>
            <div class="legend-item clickable" data-zone="industrial">
                <div class="legend-dot" style="background: #9370DB;"></div>
                <span>Industrial Zones</span>
            </div>
            <div class="legend-item clickable" data-zone="agriculture">
                <div class="legend-dot" style="background: #90EE90;"></div>
                <span>Agriculture Zones</span>
            </div>
        </div>

        <!-- Bottom: Hint -->
        <div class="map-hint" id="mapHint">Tap anywhere on the map to check zoning</div>

        <!-- Right: Analysis Panel (Chat) -->
        <div class="analysis-panel" id="analysisPanel">
            <div class="panel-header">
                <div>
                    <div class="panel-title" id="panelTitle">Zoning Analysis</div>
                    <div class="panel-subtitle" id="panelSubtitle">Select a location</div>
                </div>
                <button class="panel-close" id="panelClose">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>

            <div class="zone-info" id="zoneInfo" style="display: none;">
                <div class="zone-badge">
                    <div class="zone-color" id="zoneColor"></div>
                    <span class="zone-name" id="zoneName"></span>
                </div>
                <div class="zone-stats">
                    <div class="stat-item">
                        <div class="stat-label">Latitude</div>
                        <div class="stat-value" id="statLat">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Longitude</div>
                        <div class="stat-value" id="statLng">--</div>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages"></div>

            <div class="chat-actions" id="chatActions" style="display: none;">
                <button class="chat-action-btn primary" id="downloadBtn">
                    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    Download PDF
                </button>
                <button class="chat-action-btn" id="shareBtn">
                    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                    Share
                </button>
            </div>

            <div class="chat-input-area">
                <textarea class="chat-input" id="chatInput" placeholder="Ask about zoning, permits..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

        <!-- Floating Chat Toggle -->
        <button class="chat-toggle" id="chatToggle">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
    const API = 'https://cok-development-assistant.onrender.com/api';
    const sessionId = 'web_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let map, marker, location, zoning, response, connected = false, lang = 'en', hasContent = false;

    const COLORS = {
        'R1-Low density residential zone': '#FFFFE0', 'R2-Medium density residential - Improvement zone': '#F59E0B',
        'R3-Medium density residential - Expansion zone': '#FF7F50', 'R4-High density residential zone': '#FF6347',
        'C1-Mixed use zone': '#FFB6C1', 'C3-City commercial zone': '#CD5626',
        'I1-Light industrial zone': '#DDA0DD', 'I2-General industrial zone': '#9370DB',
        'A1-Agriculture zone': '#90EE90', 'PA-Public Administration zone': '#87CEEB'
    };

    const i18n = {
        en: { loading: 'Analyzing location...', welcome: z => `**${z}**\n\nWhat would you like to know?\n\n• Building types permitted\n• Height & setback requirements\n• Required permits\n• Commercial use eligibility`, error: 'Something went wrong. Try again.', noZone: 'No zoning data for this location.' },
        rw: { loading: 'Gusesengura aho hantu...', welcome: z => `**${z}**\n\nNi iki ushaka kumenya?\n\n• Ubwoko bw'inyubako bwemewe\n• Uburebure n'imipaka\n• Impushya zisabwa`, error: 'Habaye ikibazo. Ongera ugerageze.', noZone: 'Nta makuru y\'imiyoborere.' },
        fr: { loading: 'Analyse en cours...', welcome: z => `**${z}**\n\nQue voulez-vous savoir?\n\n• Types de bâtiments autorisés\n• Exigences de hauteur\n• Permis requis`, error: 'Une erreur s\'est produite.', noZone: 'Aucune donnée de zonage.' }
    };
    const t = (k, ...a) => { const v = i18n[lang][k] || i18n.en[k]; return typeof v === 'function' ? v(...a) : v; };

    // Init
    window.addEventListener('DOMContentLoaded', async () => {
        connected = await fetch(`${API}/health`).then(r => r.json()).then(d => d.status === 'healthy').catch(() => false);
        map = L.map('map', { center: [-1.9441, 30.0619], zoom: 13, zoomControl: false });
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
        // Google Hybrid - fast!
        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: '© Google', maxZoom: 20 }).addTo(map);
    });

    document.getElementById('enterBtn').onclick = () => {
        document.getElementById('splash').classList.add('hidden');
        document.getElementById('app').classList.add('active');
        setTimeout(() => map.invalidateSize(), 100);
        map.on('click', handleClick);
        setupUI();
    };

    function setupUI() {
        // Language
        document.querySelectorAll('.lang-pill').forEach(b => b.onclick = () => {
            document.querySelectorAll('.lang-pill').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            lang = b.dataset.lang;
        });
        // Location
        document.getElementById('locationBtn').onclick = () => {
            navigator.geolocation.getCurrentPosition(p => {
                map.setView([p.coords.latitude, p.coords.longitude], 16);
                handleClick({ latlng: L.latLng(p.coords.latitude, p.coords.longitude) });
            }, () => alert('Could not get location'), { enableHighAccuracy: true });
        };
        // Panel close
        document.getElementById('panelClose').onclick = closePanel;
        document.getElementById('chatToggle').onclick = openPanel;
        // Chat
        const input = document.getElementById('chatInput');
        input.oninput = () => { input.style.height = 'auto'; input.style.height = Math.min(input.scrollHeight, 80) + 'px'; };
        input.onkeypress = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('downloadBtn').onclick = downloadPDF;
        document.getElementById('shareBtn').onclick = shareReport;
        // Search (simple)
        document.getElementById('searchBtn').onclick = () => {
            const q = prompt('Search location in Kigali:');
            if (q) searchLocation(q);
        };
    }

    async function searchLocation(query) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)},Kigali,Rwanda&format=json&limit=1`);
            const data = await res.json();
            if (data[0]) {
                map.flyTo([data[0].lat, data[0].lon], 16);
                setTimeout(() => handleClick({ latlng: L.latLng(data[0].lat, data[0].lon) }), 1000);
            }
        } catch (e) { console.error(e); }
    }

    async function handleClick(e) {
        if (!connected) return;
        location = { lat: e.latlng.lat, lng: e.latlng.lng };
        document.getElementById('mapHint').classList.add('hidden');

        // Marker
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng, {
            icon: L.divIcon({
                className: '',
                html: `<div style="width:24px;height:24px;background:#ec4899;border:3px solid white;border-radius:50%;box-shadow:0 2px 10px rgba(236,72,153,0.5);"></div>`,
                iconSize: [24, 24], iconAnchor: [12, 12]
            })
        }).addTo(map);

        openPanel();
        clearChat();
        addMsg('system', t('loading'));

        try {
            const res = await fetch(`${API}/zoning/location?lat=${location.lat}&lng=${location.lng}`);
            const data = await res.json();
            if (data.success && data.data?.zoneData) {
                zoning = { name: data.data.zoneData.zone_name, props: data.data.zoneData };
                showZoneInfo();
                hasContent = true;
            } else {
                clearChat();
                addMsg('assistant', t('noZone'));
                hasContent = true;
            }
        } catch (e) {
            clearChat();
            addMsg('assistant', t('error'));
            hasContent = true;
        }
    }

    function openPanel() {
        document.getElementById('analysisPanel').classList.add('active');
        document.getElementById('chatToggle').classList.remove('visible');
        document.getElementById('top-actions')?.style.setProperty('right', '370px');
    }

    function closePanel() {
        document.getElementById('analysisPanel').classList.remove('active');
        if (hasContent) document.getElementById('chatToggle').classList.add('visible');
        if (!location) document.getElementById('mapHint').classList.remove('hidden');
    }

    function showZoneInfo() {
        document.getElementById('zoneInfo').style.display = 'block';
        document.getElementById('zoneName').textContent = zoning.name;
        document.getElementById('zoneColor').style.background = COLORS[zoning.name] || '#64748B';
        document.getElementById('statLat').textContent = location.lat.toFixed(5);
        document.getElementById('statLng').textContent = location.lng.toFixed(5);
        document.getElementById('panelTitle').textContent = 'Zoning Analysis';
        document.getElementById('panelSubtitle').textContent = `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`;
        clearChat();
        response = { text: t('welcome', zoning.name), question: null };
        addMsg('assistant', response.text, true);
    }

    function clearChat() {
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('chatActions').style.display = 'none';
    }

    function addMsg(type, text, animate = false) {
        const container = document.getElementById('chatMessages');
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.innerHTML = `<div class="message-content">${formatText(text)}</div>`;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
    }

    function formatText(text) {
        return text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/^[•\-]\s+(.+)$/gm, '<li>$1</li>')
            .replace(/((?:<li>.+<\/li>\s*)+)/g, '<ul>$1</ul>')
            .replace(/\n/g, '<br>');
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const q = input.value.trim();
        if (!q || !zoning) return;

        addMsg('user', q);
        input.value = '';
        input.style.height = 'auto';

        const dots = document.createElement('div');
        dots.className = 'typing-dots';
        dots.innerHTML = '<span></span><span></span><span></span>';
        document.getElementById('chatMessages').appendChild(dots);

        try {
            const res = await fetch(`${API}/ai/question`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: q, lat: location.lat, lng: location.lng, sessionId, language: lang })
            });
            const data = await res.json();
            dots.remove();
            if (data.success && data.data) {
                response = { text: data.data.response, question: q };
                addMsg('assistant', data.data.response);
                document.getElementById('chatActions').style.display = 'flex';
            } else {
                addMsg('assistant', t('error'));
            }
        } catch (e) {
            dots.remove();
            addMsg('assistant', t('error'));
        }
    }

    async function downloadPDF() {
        if (!zoning || !response) return;
        const btn = document.getElementById('downloadBtn');
        btn.disabled = true;
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const w = doc.internal.pageSize.getWidth(), m = 20;

            doc.setFillColor(17, 17, 17);
            doc.rect(0, 0, w, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('ZoneAgent Report', m, 22);

            doc.setFillColor(236, 72, 153);
            doc.rect(0, 35, w, 3, 'F');

            let y = 50;
            doc.setTextColor(17, 17, 17);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('LOCATION', m, y);
            y += 8;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Zone: ${zoning.name}`, m, y); y += 5;
            doc.text(`Coordinates: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`, m, y); y += 5;
            doc.text(`Date: ${new Date().toLocaleDateString()}`, m, y); y += 12;

            if (response.question) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('QUESTION', m, y); y += 8;
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(10);
                doc.text(doc.splitTextToSize(`"${response.question}"`, w - m * 2), m, y);
                y += 15;
            }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(12);
            doc.text('ANALYSIS', m, y); y += 8;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const lines = doc.splitTextToSize(response.text.replace(/[^\x00-\x7F]/g, ''), w - m * 2);
            lines.forEach(line => { if (y > 270) { doc.addPage(); y = 20; } doc.text(line, m, y); y += 5; });

            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Generated by ZoneAgent | City of Kigali: 3260', w / 2, 290, { align: 'center' });

            doc.save(`ZoneAgent_${zoning.name.replace(/[^a-zA-Z0-9]/g, '_').slice(0, 20)}.pdf`);
        } catch (e) { console.error(e); alert('Error generating PDF'); }
        btn.disabled = false;
    }

    function shareReport() {
        if (!zoning || !response) return;
        const text = `ZoneAgent Report\n\nZone: ${zoning.name}\nLocation: ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}\n\n${response.text.slice(0, 300)}...\n\nCity of Kigali: 3260`;
        if (navigator.share) navigator.share({ title: 'ZoneAgent', text }).catch(() => {});
        else navigator.clipboard.writeText(text).then(() => alert('Copied!')).catch(() => {});
    }
    </script>
</body>
</html>
