<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>üåå TerraNebular</title>
    
    <!-- ArcGIS CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* TerraNebular Cosmic Color Palette */
        :root {
            --nebular-deep-blue: #0F172A;
            --nebular-space-blue: #1E3A8A;
            --nebular-cosmic-purple: #6366F1;
            --nebular-stellar-gold: #F59E0B;
            --nebular-plasma-pink: #EC4899;
            --nebular-void-black: #000000;
            --nebular-stardust: #E2E8F0;
            --nebular-aurora-green: #10B981;
            --nebular-comet-white: #F8FAFC;
            --nebular-meteor-orange: #F97316;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            background-size: 400% 400%;
            animation: nebulaShift 20s ease-in-out infinite;
            overflow: hidden;
            height: 100vh;
            display: flex;
            position: relative;
        }

        /* Cosmic Background Particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(2px 2px at 20px 30px, rgba(255, 255, 255, 0.4), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(245, 158, 11, 0.3), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(99, 102, 241, 0.4), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(236, 72, 153, 0.3), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(16, 185, 129, 0.2), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: stardust 8s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
            position: relative;
            z-index: 2;
        }

        /* Left Panel */
        #leftPanel {
            width: 420px;
            min-width: 350px;
            max-width: 500px;
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            box-shadow: 4px 0 32px rgba(15, 23, 42, 0.2);
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            resize: horizontal;
            overflow: hidden;
        }

        /* Panel Header */
        .panel-header {
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            color: var(--nebular-comet-white);
            padding: 16px 20px;
            flex-shrink: 0;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo-small {
            font-size: 28px;
            animation: stellarFloat 3s ease-in-out infinite;
        }

        .app-title {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        /* Language Selector */
        .language-selector {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 8px;
        }

        .lang-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .lang-btn.active {
            background: var(--nebular-stellar-gold);
            color: var(--nebular-deep-blue);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .location-btn {
            background: linear-gradient(135deg, var(--nebular-stellar-gold) 0%, var(--nebular-meteor-orange) 100%);
            color: var(--nebular-comet-white);
            border: none;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }
        
        .location-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-deep-blue);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--nebular-stellar-gold);
            animation: cosmicPulse 2s infinite;
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
        }
        
        .status-dot.ready {
            background: var(--nebular-aurora-green);
            animation: none;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
        }

        .status-dot.error {
            background: var(--nebular-plasma-pink);
            animation: none;
            box-shadow: 0 0 6px rgba(236, 72, 153, 0.6);
        }

        /* Panel Content */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        /* Initial Guidance */
        .initial-guidance {
            color: var(--nebular-space-blue);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            text-align: center;
            margin-bottom: 12px;
            background: var(--nebular-stardust);
        }

        /* Location Header */
        .location-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 14px;
            background: linear-gradient(135deg, var(--nebular-stardust) 0%, var(--nebular-comet-white) 100%);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(15, 23, 42, 0.1);
        }
        
        .zone-info {
            flex: 1;
        }
        
        .zone-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--nebular-deep-blue);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }
        
        .zone-description {
            font-size: 12px;
            color: var(--nebular-space-blue);
            margin: 0;
            line-height: 1.4;
        }
        
        .zone-color-indicator {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            border: 2px solid var(--nebular-comet-white);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.2);
            flex-shrink: 0;
        }

        /* Chat Interface */
        .chat-container {
            background: transparent;
            border-radius: 0;
            padding: 0;
            display: none;
            box-shadow: none;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-container.show {
            display: flex;
        }
        
        .ai-response {
            background: var(--nebular-comet-white);
            padding: 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            color: var(--nebular-deep-blue);
            overflow-y: auto;
            flex: 1;
            position: relative;
        }

        /* Action Buttons Row */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .download-btn {
            background: linear-gradient(135deg, var(--nebular-aurora-green) 0%, #059669 100%);
            color: white;
        }

        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .download-btn:disabled {
            background: #CBD5E1;
            color: #94A3B8;
            cursor: not-allowed;
            transform: none;
        }

        .share-btn {
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: white;
        }

        .share-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex-shrink: 0;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #E2E8F0;
            border-radius: 20px;
            font-size: 13px;
            resize: none;
            min-height: 42px;
            max-height: 100px;
            outline: none;
            transition: all 0.2s ease;
            background: var(--nebular-comet-white);
            color: var(--nebular-deep-blue);
            font-family: inherit;
        }
        
        .chat-input:focus {
            border-color: var(--nebular-cosmic-purple);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }
        
        .send-btn {
            background: var(--nebular-cosmic-purple);
            color: var(--nebular-comet-white);
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 21px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 16px;
        }
        
        .send-btn:hover:not(:disabled) {
            background: var(--nebular-plasma-pink);
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            background: #CBD5E1;
            color: #94A3B8;
            cursor: not-allowed;
        }

        /* Map Container */
        #mapContainer {
            flex: 1;
            position: relative;
            background: var(--nebular-deep-blue);
        }
        
        #viewDiv {
            height: 100%;
            width: 100%;
        }

        /* Panel Resize Handle */
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: transparent;
            cursor: ew-resize;
            z-index: 101;
        }

        .resize-handle:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        /* SPLASH SCREEN */
        .persistent-splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--nebular-void-black) 0%, var(--nebular-deep-blue) 30%, var(--nebular-space-blue) 70%, var(--nebular-cosmic-purple) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow-y: auto;
        }

        .persistent-splash.hidden {
            display: none;
        }

        .splash-content-wrapper {
            position: relative;
            z-index: 10;
            max-width: 600px;
            width: 90%;
            text-align: center;
            padding: 40px 20px;
        }

        .app-logo-large {
            font-size: 64px;
            margin-bottom: 20px;
            animation: stellarFloat 3s ease-in-out infinite;
        }

        .splash-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--nebular-comet-white);
            margin: 0 0 12px 0;
        }

        .splash-subtitle {
            font-size: 16px;
            color: var(--nebular-stardust);
            margin: 0 0 30px 0;
            opacity: 0.9;
        }

        .splash-features {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .splash-feature {
            text-align: center;
            color: var(--nebular-stardust);
        }

        .splash-feature-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .splash-feature-text {
            font-size: 12px;
            opacity: 0.8;
        }

        .enter-btn {
            background: linear-gradient(135deg, var(--nebular-stellar-gold) 0%, var(--nebular-meteor-orange) 100%);
            color: var(--nebular-comet-white);
            border: none;
            padding: 16px 48px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
        }

        .enter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(245, 158, 11, 0.6);
        }

        /* Animations */
        @keyframes cosmicPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        @keyframes stellarFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        @keyframes nebulaShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes stardust {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            #leftPanel {
                width: 100%;
                max-width: none;
                height: 45vh;
                min-height: 320px;
                resize: vertical;
            }

            #mapContainer {
                height: 55vh;
            }

            .header-top {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .brand-section {
                justify-content: center;
            }

            .language-selector {
                justify-content: center;
            }

            .splash-features {
                gap: 20px;
            }
        }
    </style>
</head>
<body>    
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Left Panel -->
        <div id="leftPanel">
            <div class="resize-handle"></div>
            
            <!-- Panel Header -->
            <div class="panel-header">
                <div class="header-top">
                    <div class="brand-section">
                        <div class="app-logo-small">üåå</div>
                        <h1 class="app-title">TerraNebular</h1>
                    </div>
                    
                    <!-- Language Selector -->
                    <div class="language-selector">
                        <button class="lang-btn active" data-lang="en" onclick="setLanguage('en')">EN</button>
                        <button class="lang-btn" data-lang="rw" onclick="setLanguage('rw')">RW</button>
                        <button class="lang-btn" data-lang="fr" onclick="setLanguage('fr')">FR</button>
                    </div>
                </div>
                
                <div class="header-controls">
                    <button class="location-btn" id="useLocationBtn" onclick="useCurrentLocation()">
                        üìç <span data-i18n="useLocation">Use My Location</span>
                    </button>
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Panel Content -->
            <div class="panel-content">
                <!-- Initial Guidance -->
                <div class="initial-guidance" id="initialGuidance" data-i18n="initialGuidance">
                    Click anywhere on the map or use your location to get zoning insights powered by AI.
                </div>
                
                <!-- Location Header -->
                <div class="location-header" id="locationHeader" style="display: none;">
                    <div class="zone-color-indicator" id="zoneColorIndicator"></div>
                    <div class="zone-info">
                        <h3 class="zone-name" id="zoneName">Select a location</h3>
                        <p class="zone-description" id="zoneDescription">Click anywhere on the map</p>
                    </div>
                </div>
                
                <!-- Chat Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="ai-response" id="aiResponse"></div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons" id="actionButtons" style="display: none;">
                        <button class="action-btn download-btn" id="downloadBtn" onclick="downloadPDFReport()">
                            üìÑ <span data-i18n="downloadReport">Download Report</span>
                        </button>
                        <button class="action-btn share-btn" id="shareBtn" onclick="shareReport()">
                            üì§ <span data-i18n="share">Share</span>
                        </button>
                    </div>
                    
                    <div class="chat-input-container">
                        <textarea class="chat-input" id="chatInput" 
                                  data-i18n-placeholder="askPlaceholder"
                                  placeholder="Ask about zoning, permits, or building regulations..." 
                                  rows="1"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            ‚û§
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div id="mapContainer">
            <div id="viewDiv"></div>
        </div>
    </div>

    <!-- SPLASH SCREEN -->
    <div id="persistentSplash" class="persistent-splash">
        <div class="splash-content-wrapper">
            <div class="app-logo-large">üåå</div>
            <h1 class="splash-title">TerraNebular</h1>
            <p class="splash-subtitle">Kigali Zoning Intelligence Platform</p>
            
            <div class="splash-features">
                <div class="splash-feature">
                    <div class="splash-feature-icon">üó∫Ô∏è</div>
                    <div class="splash-feature-text">8,172 Zones</div>
                </div>
                <div class="splash-feature">
                    <div class="splash-feature-icon">ü§ñ</div>
                    <div class="splash-feature-text">AI Powered</div>
                </div>
                <div class="splash-feature">
                    <div class="splash-feature-icon">üåç</div>
                    <div class="splash-feature-text">EN ‚Ä¢ RW ‚Ä¢ FR</div>
                </div>
            </div>
            
            <button class="enter-btn" onclick="enterApplication()">
                ‚ú® Enter TerraNebular
            </button>
        </div>
    </div>

    <!-- ArcGIS JavaScript API -->
    <script src="https://js.arcgis.com/4.28/"></script>
    
    <script>
    // =============================================================================
    // GLOBAL STATE
    // =============================================================================

    let currentLocation = null;
    let currentZoning = null;
    let currentResponse = null;
    let view = null;
    let backendConnected = false;
    let sessionId = 'web_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let currentLanguage = 'en';

    // =============================================================================
    // INTERNATIONALIZATION (i18n)
    // =============================================================================

    const translations = {
        en: {
            useLocation: 'Use My Location',
            initialGuidance: 'Click anywhere on the map or use your location to get zoning insights powered by AI.',
            askPlaceholder: 'Ask about zoning, permits, or building regulations...',
            downloadReport: 'Download Report',
            share: 'Share',
            loading: 'Loading...',
            querying: 'Querying spatial database...',
            analyzing: 'AI is analyzing your question...',
            connected: 'Connected',
            offline: 'Offline',
            welcomeMessage: (zone) => `Welcome! You selected: ${zone}\n\nAsk me anything about development regulations, permits, or investment potential for this location.`,
            reportTitle: 'ZONING REPORT',
            generatedBy: 'Generated by TerraNebular',
            locationLabel: 'Location',
            zoneLabel: 'Zone',
            dateLabel: 'Date',
            questionLabel: 'Question',
            responseLabel: 'AI Analysis',
            contactLabel: 'Contact Information',
            disclaimerLabel: 'Disclaimer',
            disclaimer: 'This report is for informational purposes only. Please verify all information with City of Kigali authorities before making development decisions.'
        },
        rw: {
            useLocation: 'Koresha Aho Ndi',
            initialGuidance: 'Kanda ahantu kuri karita cyangwa ukoreshe aho uri kugira ubone amakuru y\'imiyoborere.',
            askPlaceholder: 'Baza ku miyoborere, uruhushya, cyangwa amategeko yo kubaka...',
            downloadReport: 'Kuramo Raporo',
            share: 'Sangiza',
            loading: 'Biratunganywa...',
            querying: 'Gushakisha amakuru...',
            analyzing: 'AI irimo gusesengura ikibazo cyawe...',
            connected: 'Byahujwe',
            offline: 'Ntibihari',
            welcomeMessage: (zone) => `Murakaza neza! Wahisemo: ${zone}\n\nMbaze ikibazo icyo ari cyo cyose ku miyoborere yo kubaka, uruhushya, cyangwa ubushobozi bwo gushora imari aha hantu.`,
            reportTitle: 'RAPORO Y\'IMIYOBORERE',
            generatedBy: 'Byakozwe na TerraNebular',
            locationLabel: 'Aho hantu',
            zoneLabel: 'Akarere',
            dateLabel: 'Itariki',
            questionLabel: 'Ikibazo',
            responseLabel: 'Isesengura rya AI',
            contactLabel: 'Aho Wakwiyambaza',
            disclaimerLabel: 'Itangazo',
            disclaimer: 'Iyi raporo ni iy\'amakuru gusa. Nyamuneka emeza amakuru yose n\'ubuyobozi bw\'Umujyi wa Kigali mbere yo gufata ibyemezo byo kubaka.'
        },
        fr: {
            useLocation: 'Utiliser Ma Position',
            initialGuidance: 'Cliquez n\'importe o√π sur la carte ou utilisez votre position pour obtenir des informations de zonage aliment√©es par l\'IA.',
            askPlaceholder: 'Posez des questions sur le zonage, les permis ou les r√®glements de construction...',
            downloadReport: 'T√©l√©charger le Rapport',
            share: 'Partager',
            loading: 'Chargement...',
            querying: 'Interrogation de la base de donn√©es spatiales...',
            analyzing: 'L\'IA analyse votre question...',
            connected: 'Connect√©',
            offline: 'Hors ligne',
            welcomeMessage: (zone) => `Bienvenue! Vous avez s√©lectionn√©: ${zone}\n\nPosez-moi n'importe quelle question sur les r√©glementations de d√©veloppement, les permis ou le potentiel d'investissement pour cet emplacement.`,
            reportTitle: 'RAPPORT DE ZONAGE',
            generatedBy: 'G√©n√©r√© par TerraNebular',
            locationLabel: 'Emplacement',
            zoneLabel: 'Zone',
            dateLabel: 'Date',
            questionLabel: 'Question',
            responseLabel: 'Analyse IA',
            contactLabel: 'Coordonn√©es',
            disclaimerLabel: 'Avertissement',
            disclaimer: 'Ce rapport est fourni √† titre informatif uniquement. Veuillez v√©rifier toutes les informations aupr√®s des autorit√©s de la Ville de Kigali avant de prendre des d√©cisions de d√©veloppement.'
        }
    };

    function t(key, ...args) {
        const translation = translations[currentLanguage][key];
        if (typeof translation === 'function') {
            return translation(...args);
        }
        return translation || translations.en[key] || key;
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        
        // Update button states
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === lang);
        });
        
        // Update all translatable elements
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.dataset.i18n;
            el.textContent = t(key);
        });
        
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            el.placeholder = t(key);
        });
        
        console.log(`Language changed to: ${lang}`);
    }

    // =============================================================================
    // TYPEWRITER CONTROLLER (Race Condition Fix)
    // =============================================================================
    
    const TypewriterController = {
        activeTimerId: null,
        currentSessionId: 0,
        
        stop() {
            if (this.activeTimerId !== null) {
                clearTimeout(this.activeTimerId);
                this.activeTimerId = null;
            }
            this.currentSessionId++;
        },
        
        typeText(element, text, speed = 20) {
            this.stop();
            element.textContent = '';
            const sessionId = ++this.currentSessionId;
            
            return new Promise((resolve) => {
                let charIndex = 0;
                const typeNextChar = () => {
                    if (sessionId !== this.currentSessionId) {
                        resolve(false);
                        return;
                    }
                    if (charIndex < text.length) {
                        element.textContent = text.substring(0, charIndex + 1);
                        charIndex++;
                        this.activeTimerId = setTimeout(typeNextChar, speed);
                    } else {
                        this.activeTimerId = null;
                        resolve(true);
                    }
                };
                typeNextChar();
            });
        },
        
        instant(element, text) {
            this.stop();
            element.textContent = text;
        }
    };

    // =============================================================================
    // REQUEST MANAGER (Debouncing & Cancellation)
    // =============================================================================
    
    const RequestManager = {
        currentRequestId: null,
        abortController: null,
        debounceTimer: null,
        DEBOUNCE_MS: 250,
        
        cancel() {
            if (this.debounceTimer) {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = null;
            }
            if (this.abortController) {
                this.abortController.abort();
                this.abortController = null;
            }
            this.currentRequestId = null;
        },
        
        async execute(requestFn) {
            this.cancel();
            const requestId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            this.currentRequestId = requestId;
            this.abortController = new AbortController();
            const signal = this.abortController.signal;
            
            return new Promise((resolve, reject) => {
                this.debounceTimer = setTimeout(async () => {
                    if (requestId !== this.currentRequestId) {
                        resolve(null);
                        return;
                    }
                    try {
                        const result = await requestFn(signal);
                        if (requestId === this.currentRequestId) {
                            resolve(result);
                        } else {
                            resolve(null);
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            resolve(null);
                        } else {
                            reject(error);
                        }
                    }
                }, this.DEBOUNCE_MS);
            });
        }
    };

    // =============================================================================
    // PDF REPORT GENERATION
    // =============================================================================

    async function downloadPDFReport() {
        if (!currentZoning || !currentResponse) {
            alert('Please select a location and ask a question first.');
            return;
        }

        const btn = document.getElementById('downloadBtn');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ ' + t('loading');

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            
            // Colors
            const primaryColor = [15, 23, 42];      // Deep blue
            const accentColor = [245, 158, 11];     // Gold
            const textColor = [30, 41, 59];         // Dark gray
            
            // Header Background
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, pageWidth, 45, 'F');
            
            // Header Text
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('üåå TerraNebular', margin, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(t('reportTitle'), margin, 32);
            
            // Date on right
            doc.setFontSize(10);
            const dateStr = new Date().toLocaleDateString(currentLanguage === 'rw' ? 'rw-RW' : currentLanguage === 'fr' ? 'fr-FR' : 'en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            doc.text(dateStr, pageWidth - margin, 20, { align: 'right' });
            
            // Gold accent line
            doc.setFillColor(...accentColor);
            doc.rect(0, 45, pageWidth, 3, 'F');
            
            let yPos = 60;
            
            // Location Section
            doc.setTextColor(...primaryColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(t('locationLabel').toUpperCase(), margin, yPos);
            yPos += 8;
            
            doc.setTextColor(...textColor);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(`${t('zoneLabel')}: ${currentZoning.zoneName}`, margin, yPos);
            yPos += 6;
            
            if (currentLocation) {
                doc.text(`Coordinates: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`, margin, yPos);
                yPos += 6;
            }
            
            yPos += 8;
            
            // Divider
            doc.setDrawColor(226, 232, 240);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 12;
            
            // Question Section
            if (currentResponse.question) {
                doc.setTextColor(...primaryColor);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(t('questionLabel').toUpperCase(), margin, yPos);
                yPos += 8;
                
                doc.setTextColor(...textColor);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'italic');
                const questionLines = doc.splitTextToSize(`"${currentResponse.question}"`, contentWidth);
                doc.text(questionLines, margin, yPos);
                yPos += (questionLines.length * 6) + 8;
                
                // Divider
                doc.setDrawColor(226, 232, 240);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 12;
            }
            
            // AI Response Section
            doc.setTextColor(...primaryColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(t('responseLabel').toUpperCase(), margin, yPos);
            yPos += 10;
            
            doc.setTextColor(...textColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Clean response text (remove emojis for PDF)
            let cleanResponse = currentResponse.response
                .replace(/[üìçüìûüåê‚ú®üèõÔ∏èüèóÔ∏è‚ö†Ô∏è‚úÖ‚ùå]/g, '')
                .replace(/\n{3,}/g, '\n\n')
                .trim();
            
            const responseLines = doc.splitTextToSize(cleanResponse, contentWidth);
            
            // Check if we need a new page
            responseLines.forEach(line => {
                if (yPos > 260) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.text(line, margin, yPos);
                yPos += 5;
            });
            
            yPos += 10;
            
            // Contact Section
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFillColor(241, 245, 249);
            doc.roundedRect(margin, yPos, contentWidth, 35, 3, 3, 'F');
            yPos += 8;
            
            doc.setTextColor(...primaryColor);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(t('contactLabel'), margin + 5, yPos);
            yPos += 7;
            
            doc.setTextColor(...textColor);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('City of Kigali Planning: +250 788 000 000', margin + 5, yPos);
            yPos += 5;
            doc.text('Website: kigalicity.gov.rw', margin + 5, yPos);
            yPos += 5;
            doc.text('Irembo Portal: irembo.gov.rw', margin + 5, yPos);
            
            yPos += 20;
            
            // Disclaimer
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setTextColor(148, 163, 184);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            const disclaimerLines = doc.splitTextToSize(t('disclaimer'), contentWidth);
            doc.text(disclaimerLines, margin, yPos);
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(148, 163, 184);
                doc.text(
                    `${t('generatedBy')} | Page ${i} of ${pageCount}`,
                    pageWidth / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }
            
            // Generate filename
            const zoneSafe = currentZoning.zoneName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
            const dateSafe = new Date().toISOString().split('T')[0];
            const filename = `TerraNebular_${zoneSafe}_${dateSafe}.pdf`;
            
            // Download
            doc.save(filename);
            
            console.log('PDF Report generated:', filename);
            
        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF. Please try again.');
        }
        
        btn.disabled = false;
        btn.innerHTML = 'üìÑ ' + t('downloadReport');
    }

    // =============================================================================
    // SHARE FUNCTIONALITY
    // =============================================================================

    async function shareReport() {
        if (!currentZoning || !currentResponse) {
            alert('Please select a location and ask a question first.');
            return;
        }

        const shareText = `üåå TerraNebular Zoning Report

üìç Zone: ${currentZoning.zoneName}
üìå Location: ${currentLocation?.latitude.toFixed(4)}, ${currentLocation?.longitude.toFixed(4)}

${currentResponse.response.substring(0, 500)}...

üîó Explore more at TerraNebular
üìû City of Kigali: +250 788 000 000`;

        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'TerraNebular Zoning Report',
                    text: shareText,
                });
            } catch (error) {
                if (error.name !== 'AbortError') {
                    fallbackShare(shareText);
                }
            }
        } else {
            fallbackShare(shareText);
        }
    }

    function fallbackShare(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Report copied to clipboard! You can now paste it anywhere.');
        }).catch(() => {
            // Create a temporary textarea for copying
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Report copied to clipboard!');
        });
    }

    // =============================================================================
    // APPLICATION INITIALIZATION
    // =============================================================================

    function enterApplication() {
        document.getElementById('persistentSplash').classList.add('hidden');
        document.getElementById('appContainer').style.display = 'flex';
        
        setTimeout(() => {
            if (view === null) {
                initializeApp();
            }
            setupPanelResize();
        }, 100);
    }

    const API_BASE_URL = 'https://cok-development-assistant.onrender.com/api';

    const ZONE_COLORS = {
        'A1-Agriculture zone': '#90EE90',
        'C1-Mixed use zone': '#FFB6C1',
        'C3-City commercial zone': '#CD5626',
        'I1-Light industrial zone': '#DDA0DD',
        'I2-General industrial zone': '#9370DB',
        'R1-Low density residential zone': '#FFFFE0',
        'R2-Medium density residential - Improvement zone': '#F59E0B',
        'R3-Medium density residential - Expansion zone': '#FF7F50',
        'R4-High density residential zone': '#FF6347',
        'T-Transportation zone': '#A9A9A9',
        'WR-Waterbody zone': '#87CEEB'
    };

    async function checkBackendHealth() {
        try {
            const response = await fetch(`${API_BASE_URL}/health`);
            const data = await response.json();
            return data.status === 'healthy';
        } catch (error) {
            return false;
        }
    }

    async function fetchZoningForLocation(lat, lng, signal) {
        const response = await fetch(`${API_BASE_URL}/zoning/location?lat=${lat}&lng=${lng}`, { signal });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (data.success && data.data?.zoneData) {
            return {
                zoneName: data.data.zoneData.zone_name,
                properties: data.data.zoneData
            };
        }
        return null;
    }

    async function askClaudeAI(question, lat, lng) {
        updateStatus('loading', t('analyzing'));
        
        const response = await fetch(`${API_BASE_URL}/ai/question`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question,
                lat,
                lng,
                sessionId,
                language: currentLanguage  // Send language to backend
            })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        if (data.success && data.data) {
            return {
                response: data.data.response,
                question: question,
                cached: data.data.cached || false
            };
        }
        throw new Error(data.error || 'Unknown error');
    }

    async function initializeApp() {
        updateStatus('loading', t('loading'));
        
        backendConnected = await checkBackendHealth();
        updateStatus(backendConnected ? 'ready' : 'error', backendConnected ? t('connected') : t('offline'));
        
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic"
        ], function(Map, MapView, Graphic) {
            const map = new Map({ basemap: "hybrid" });
            
            view = new MapView({
                container: "viewDiv",
                map: map,
                center: [30.0619, -1.9441],
                zoom: 13,
                ui: { components: ["attribution"] }
            });
            
            view.on("click", handleMapClick);
            view.popup.autoOpenEnabled = false;
        });
        
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', autoResizeTextarea);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    function updateStatus(status, text) {
        document.getElementById('statusDot').className = `status-dot ${status}`;
        document.getElementById('statusText').textContent = text;
    }

    async function handleMapClick(event) {
        if (!backendConnected) return;
        
        currentLocation = event.mapPoint;
        addLocationPin(event.mapPoint);
        
        const aiResponse = document.getElementById('aiResponse');
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.classList.add('show');
        TypewriterController.instant(aiResponse, t('querying'));
        updateStatus('loading', t('querying'));
        
        // Hide action buttons until we have a response
        document.getElementById('actionButtons').style.display = 'none';
        
        try {
            const result = await RequestManager.execute(async (signal) => {
                return await fetchZoningForLocation(
                    event.mapPoint.latitude,
                    event.mapPoint.longitude,
                    signal
                );
            });
            
            if (result === null) return;
            
            if (result) {
                currentZoning = result;
                displayLocationInfo(result);
                updateStatus('ready', result.zoneName);
            }
        } catch (error) {
            TypewriterController.instant(aiResponse, `Error: ${error.message}`);
            updateStatus('error', 'Error');
        }
    }

    function addLocationPin(point) {
        require(["esri/Graphic"], function(Graphic) {
            view.graphics.removeAll();
            view.graphics.add(new Graphic({
                geometry: point,
                symbol: {
                    type: "simple-marker",
                    color: [236, 72, 153, 0.9],
                    size: 12,
                    outline: { color: [255, 255, 255], width: 2 }
                }
            }));
        });
    }

    function useCurrentLocation() {
        if (!navigator.geolocation) {
            alert('Geolocation not supported');
            return;
        }
        
        const btn = document.getElementById('useLocationBtn');
        btn.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                
                if (latitude < -2.2 || latitude > -1.7 || longitude < 29.8 || longitude > 30.3) {
                    btn.disabled = false;
                    alert('Your location is outside Kigali area.');
                    return;
                }
                
                if (view) {
                    view.center = [longitude, latitude];
                    view.zoom = 16;
                    
                    require(["esri/geometry/Point"], function(Point) {
                        handleMapClick({
                            mapPoint: new Point({ longitude, latitude, spatialReference: view.spatialReference })
                        });
                    });
                }
                btn.disabled = false;
            },
            (error) => {
                btn.disabled = false;
                alert('Unable to get location');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const question = input.value.trim();
        
        if (!question || !currentZoning || !currentLocation) {
            if (!currentZoning) alert('Please select a location first.');
            return;
        }
        
        const sendBtn = document.getElementById('sendBtn');
        const aiResponse = document.getElementById('aiResponse');
        
        sendBtn.disabled = true;
        TypewriterController.instant(aiResponse, t('analyzing'));
        
        const questionToSend = question;
        input.value = '';
        input.style.height = 'auto';
        
        try {
            const result = await askClaudeAI(
                questionToSend,
                currentLocation.latitude,
                currentLocation.longitude
            );
            
            currentResponse = result;
            await TypewriterController.typeText(aiResponse, result.response);
            
            // Show action buttons after response
            document.getElementById('actionButtons').style.display = 'flex';
            
            updateStatus('ready', t('connected'));
        } catch (error) {
            TypewriterController.instant(aiResponse, `Error: ${error.message}`);
            updateStatus('error', 'Error');
        }
        
        sendBtn.disabled = false;
    }

    function displayLocationInfo(zoning) {
        document.getElementById('initialGuidance').style.display = 'none';
        document.getElementById('zoneName').textContent = zoning.zoneName;
        document.getElementById('zoneDescription').textContent = zoning.properties?.phase || 'Development zone';
        
        const colorIndicator = document.getElementById('zoneColorIndicator');
        const zoneColor = ZONE_COLORS[zoning.zoneName] || '#999999';
        colorIndicator.style.background = zoneColor;
        
        document.getElementById('locationHeader').style.display = 'flex';
        
        const aiResponse = document.getElementById('aiResponse');
        const welcomeMsg = t('welcomeMessage', zoning.zoneName);
        
        // Set up initial response object for PDF
        currentResponse = {
            response: welcomeMsg,
            question: null
        };
        
        TypewriterController.typeText(aiResponse, welcomeMsg);
        document.getElementById('chatContainer').classList.add('show');
    }

    function autoResizeTextarea() {
        const textarea = document.getElementById('chatInput');
        textarea.style.height = 'auto';
        textarea.style.height = `${Math.min(textarea.scrollHeight, 100)}px`;
    }

    function setupPanelResize() {
        const panel = document.getElementById('leftPanel');
        const handle = panel.querySelector('.resize-handle');
        let isResizing = false;

        handle.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
            e.preventDefault();
        });

        function resize(e) {
            if (!isResizing) return;
            const newWidth = e.clientX;
            if (newWidth >= 300 && newWidth <= 600) {
                panel.style.width = newWidth + 'px';
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
    }

    console.log('üåå TerraNebular v3.0 - Multi-language + PDF Reports');
    </script>
</body>
</html>
