<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>üåå TerraNebular</title>
    
    <!-- Leaflet CSS (more reliable than ArcGIS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* TerraNebular Cosmic Color Palette */
        :root {
            --nebular-deep-blue: #0F172A;
            --nebular-space-blue: #1E3A8A;
            --nebular-cosmic-purple: #6366F1;
            --nebular-stellar-gold: #F59E0B;
            --nebular-plasma-pink: #EC4899;
            --nebular-void-black: #000000;
            --nebular-stardust: #E2E8F0;
            --nebular-aurora-green: #10B981;
            --nebular-comet-white: #F8FAFC;
            --nebular-meteor-orange: #F97316;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            overflow: hidden;
        }
        
        #mapContainer {
            height: 100vh;
            width: 100%;
            position: relative;
        }
        
        /* Cosmic Header */
        #mobileHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            color: var(--nebular-comet-white);
            padding: 12px 16px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .control-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .location-btn, .api-btn {
            background: linear-gradient(135deg, var(--nebular-stellar-gold) 0%, var(--nebular-meteor-orange) 100%);
            color: var(--nebular-comet-white);
            border: none;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .api-btn {
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            box-shadow: 0 2px 12px rgba(99, 102, 241, 0.4);
        }
        
        .location-btn:hover, .api-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }

        .api-btn:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }
        
        .app-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }
        
        .app-subtitle {
            font-size: 11px;
            opacity: 0.9;
            margin: 2px 0 0 0;
            line-height: 1.3;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--nebular-stellar-gold);
            animation: cosmicPulse 2s infinite;
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
        }
        
        .status-dot.ready {
            background: var(--nebular-aurora-green);
            animation: none;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
        }
        
        @keyframes cosmicPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.1);
                box-shadow: 0 0 12px rgba(245, 158, 11, 0.8);
            }
        }
        
        /* API Key Input Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.5);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--nebular-deep-blue);
            margin: 0 0 16px 0;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--nebular-stardust);
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .modal-input:focus {
            border-color: var(--nebular-cosmic-purple);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: var(--nebular-comet-white);
        }

        .modal-btn.secondary {
            background: var(--nebular-stardust);
            color: var(--nebular-deep-blue);
        }
        
        /* Cosmic Bottom Panel */
        #bottomPanel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -8px 32px rgba(15, 23, 42, 0.3);
            z-index: 1000;
            max-height: 50vh;
            transition: transform 0.3s ease;
            transform: translateY(100%);
            backdrop-filter: blur(10px);
        }
        
        #bottomPanel.show {
            transform: translateY(0);
        }
        
        .panel-handle {
            width: 40px;
            height: 4px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            border-radius: 2px;
            margin: 12px auto 8px;
            opacity: 0.7;
        }
        
        .panel-content {
            padding: 0 20px 20px;
            overflow-y: auto;
            max-height: 40vh;
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .zone-info {
            flex: 1;
        }
        
        .zone-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--nebular-deep-blue);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }
        
        .zone-description {
            font-size: 12px;
            color: var(--nebular-space-blue);
            margin: 0;
            line-height: 1.4;
        }
        
        .zone-color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--nebular-comet-white);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.2);
            flex-shrink: 0;
        }
        
        /* Cosmic AI Chat Interface */
        .chat-container {
            background: linear-gradient(135deg, var(--nebular-stardust) 0%, var(--nebular-comet-white) 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            display: none;
            box-shadow: inset 0 1px 3px rgba(15, 23, 42, 0.1);
        }
        
        .chat-container.show {
            display: block;
        }
        
        .ai-response {
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            padding: 14px;
            border-radius: 12px;
            border-left: 4px solid var(--nebular-cosmic-purple);
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
            color: var(--nebular-deep-blue);
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid var(--nebular-stardust);
            border-radius: 20px;
            font-size: 13px;
            resize: none;
            min-height: 40px;
            max-height: 80px;
            outline: none;
            transition: all 0.3s ease;
            background: var(--nebular-comet-white);
            color: var(--nebular-deep-blue);
        }
        
        .chat-input:focus {
            border-color: var(--nebular-cosmic-purple);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: var(--nebular-comet-white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(99, 102, 241, 0.4);
            flex-shrink: 0;
        }
        
        /* Data Banner */
        .data-banner {
            position: absolute;
            top: 70px;
            left: 16px;
            right: 16px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: var(--nebular-comet-white);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            z-index: 999;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: translateY(-100px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .data-banner.show {
            transform: translateY(0);
        }

        /* Map specific styles */
        .leaflet-container {
            height: 100vh;
            width: 100%;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .quick-actions .location-btn {
            font-size: 11px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
        }

        /* Response states */
        .response-success {
            border-left-color: var(--nebular-aurora-green);
            background: linear-gradient(135deg, #ECFDF5 0%, #F0FDF4 100%);
        }
        
        .response-warning {
            border-left-color: var(--nebular-stellar-gold);
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
        }
        
        .response-error {
            border-left-color: var(--nebular-plasma-pink);
            background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%);
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal-content">
            <h3 class="modal-title">üöÄ Claude API Configuration</h3>
            <input type="password" id="apiKeyInput" class="modal-input" 
                   placeholder="Enter your Claude API key" />
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeApiModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveApiKey()">Save Key</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Header -->
    <div id="mobileHeader">
        <div class="header-content">
            <div>
                <h1 class="app-title">üåå TerraNebular</h1>
                <p class="app-subtitle">Where Development Dreams Take Shape with AI</p>
            </div>
            <div class="header-controls">
                <div class="control-row">
                    <button class="api-btn" id="apiKeyBtn" onclick="showApiModal()">
                        ü§ñ Setup AI
                    </button>
                    <button class="location-btn" id="useLocationBtn" onclick="useCurrentLocation()">
                        üìç Use My Location
                    </button>
                </div>
                <div class="status-indicator">
                    <div class="status-dot ready" id="statusDot"></div>
                    <span id="statusText">Map Ready!</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Status Banner -->
    <div class="data-banner show" id="dataBanner">
        üåå Click anywhere on the map to explore zoning information
    </div>
    
    <!-- Map Container -->
    <div id="mapContainer"></div>
    
    <!-- Bottom Panel -->
    <div id="bottomPanel">
        <div class="panel-handle"></div>
        <div class="panel-content">
            <div class="location-header" id="locationHeader" style="display: none;">
                <div class="zone-color-indicator" id="zoneColorIndicator"></div>
                <div class="zone-info">
                    <h3 class="zone-name" id="zoneName">Select a location</h3>
                    <p class="zone-description" id="zoneDescription">Tap anywhere on the map</p>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="ai-response" id="aiResponse"></div>
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Ask about zoning: 'Can I build a restaurant here?', 'What's the maximum height?'" 
                              rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
    let map = null;
    let currentLocation = null;
    let currentZoning = null;
    let claudeApiKey = null;
    let currentMarker = null;

    // Sample zoning data for Kigali (you can replace this with real data)
    const sampleZoningData = [
        {
            lat: -1.9441,
            lng: 30.0619,
            zone: "C3-City commercial zone",
            description: "Zone established to meet most retail, commercial and services needs for larger community"
        },
        {
            lat: -1.9461,
            lng: 30.0639,
            zone: "C1-Mixed use zone", 
            description: "Zone established to create high flexibility in the mix of uses"
        },
        {
            lat: -1.9481,
            lng: 30.0659,
            zone: "R4-High density residential zone",
            description: "Established to create well planned medium-rise housing and apartment complexes"
        },
        {
            lat: -1.9501,
            lng: 30.0679,
            zone: "R1-Low density residential zone",
            description: "Intended for villa and bungalow typology and complementary public facilities"
        }
    ];

    // Zone color mapping
    const ZONE_COLORS = {
        'C1-Mixed use zone': '#FFB6C1',
        'C3-City commercial zone': '#CD5626',
        'R1-Low density residential zone': '#FFFFE0',
        'R4-High density residential zone': '#FF6347',
        'I1-Light industrial zone': '#DDA0DD',
        'A1-Agriculture zone': '#90EE90',
        'P1-Parks and open spaces zone': '#32CD32'
    };

    // Zoning regulations
    const KIGALI_ZONING_REGULATIONS = {
        'C1-Mixed use zone': {
            description: 'Zone established to create high flexibility in the mix of uses and ensure continuity in ground level commercial activities',
            permitted: ['Commercial/Retail', 'Restaurants and Recreational activities', 'Office use above 1st floor', 'Co-working spaces', 'Residential', 'Home Occupation'],
            prohibited: ['Large scale commercial complex', 'Industrial Uses', 'Major Infrastructure Installations'],
            conditional: ['Public Facilities', 'Transportation Terminals', 'Hotels', 'Petrol stations'],
            maxHeight: 'G+4 maximum',
            minLotSize: '500 m¬≤',
            coverage: '60% maximum'
        },
        'C3-City commercial zone': {
            description: 'Zone established to meet most retail, commercial and services needs for larger community',
            permitted: ['Shopping centres', 'Offices', 'Hotels', 'Apartments', 'Leisure and entertainment centres'],
            prohibited: ['Major Industrial Uses', 'Major Infrastructure Installations'],
            conditional: ['Public Facilities', 'Petrol stations', 'Transport Interchange'],
            maxHeight: 'G+10 maximum',
            minLotSize: '1,000 m¬≤',
            coverage: '70% maximum'
        },
        'R1-Low density residential zone': {
            description: 'Intended for villa and bungalow typology and complementary public facilities',
            permitted: ['Single family houses', 'Home Occupation'],
            prohibited: ['Industrial uses', 'Major infrastructure'],
            conditional: ['Apartments exceeding G + 2', 'Semi-Detached', 'Restaurants, Guest houses'],
            maxHeight: 'G+1+P (Penthouse)',
            minLotSize: 'Max 500 m¬≤',
            coverage: '40% maximum'
        },
        'R4-High density residential zone': {
            description: 'Established to create well planned medium-rise housing and apartment complexes',
            permitted: ['High density residential', 'Home Occupation'],
            prohibited: ['Industrial uses', 'Major infrastructure'],
            conditional: ['Restaurants', 'Hotels, Guest house', 'Commercial retail'],
            maxHeight: 'G+4 maximum',
            minLotSize: '750 m¬≤',
            coverage: '50% maximum'
        }
    };

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
        initializeApiKey();
        
        // Set up event listeners
        document.getElementById('chatInput').addEventListener('input', autoResizeTextarea);
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Close modal when clicking outside
        document.getElementById('apiKeyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeApiModal();
            }
        });

        // Handle Enter key in API key input
        document.getElementById('apiKeyInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveApiKey();
            }
        });
    });

    function initializeMap() {
        try {
            // Initialize Leaflet map
            map = L.map('mapContainer').setView([-1.9441, 30.0619], 13);

            // Add OpenStreetMap tiles (reliable and free)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add click event to map
            map.on('click', handleMapClick);

            console.log('‚úÖ Map initialized successfully with Leaflet');
            updateStatus('ready', 'Map ready');

        } catch (error) {
            console.error('‚ùå Map initialization failed:', error);
            updateStatus('error', 'Map failed to load');
        }
    }

    function handleMapClick(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        currentLocation = { latitude: lat, longitude: lng };
        
        // Find nearest zone from sample data
        const nearestZone = findNearestZone(lat, lng);
        
        if (nearestZone) {
            currentZoning = {
                zoneName: nearestZone.zone,
                description: nearestZone.description
            };
            
            displayLocationInfo(currentZoning);
            showBottomPanel();
            addLocationPin(lat, lng);
        } else {
            showNoDataMessage();
        }
    }

    function findNearestZone(lat, lng) {
        let nearest = null;
        let minDistance = Infinity;
        
        for (const zone of sampleZoningData) {
            const distance = Math.sqrt(
                Math.pow(lat - zone.lat, 2) + 
                Math.pow(lng - zone.lng, 2)
            );
            
            if (distance < minDistance) {
                minDistance = distance;
                nearest = zone;
            }
        }
        
        // Return nearest zone if within reasonable distance (about 2km)
        return minDistance < 0.02 ? nearest : null;
    }

    function addLocationPin(lat, lng) {
        // Remove existing marker
        if (currentMarker) {
            map.removeLayer(currentMarker);
        }
        
        // Add new marker
        currentMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #EC4899; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                iconSize: [26, 26],
                iconAnchor: [13, 13]
            })
        }).addTo(map);
    }

    function displayLocationInfo(zoning) {
        const zoneName = zoning.zoneName;
        const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
            description: 'Development zone per master plan',
            maxHeight: 'Check regulations',
            coverage: 'Per regulations'
        };
        
        document.getElementById('zoneName').textContent = zoneName;
        document.getElementById('zoneDescription').textContent = regulations.description;
        
        const colorIndicator = document.getElementById('zoneColorIndicator');
        const zoneColor = ZONE_COLORS[zoneName] || '#999999';
        colorIndicator.style.background = zoneColor;
        
        document.getElementById('locationHeader').style.display = 'flex';
        
        const chatContainer = document.getElementById('chatContainer');
        const aiResponse = document.getElementById('aiResponse');
        
        const welcomeMsg = claudeApiKey ? 
            `ü§ñ Claude AI is ready to assist!\n\nüìç Selected: ${zoneName}\n\n‚ú® Ask me anything about development in this zone!` :
            `üåå Welcome to TerraNebular!\n\nüìç Selected: ${zoneName}\n\n‚ú® Ask questions about zoning regulations. Configure Claude AI for enhanced responses!`;
        
        aiResponse.innerHTML = welcomeMsg;
        aiResponse.className = 'ai-response response-success';
        chatContainer.classList.add('show');
        
        // Add quick action buttons
        addQuickActionButtons();
    }

    function addQuickActionButtons() {
        const chatContainer = document.getElementById('chatContainer');
        
        // Check if quick actions already exist
        if (chatContainer.querySelector('.quick-actions')) {
            return;
        }
        
        const quickActions = document.createElement('div');
        quickActions.className = 'quick-actions';
        
        const actions = [
            { text: 'Can I build a restaurant?', question: 'Can I build a restaurant here?' },
            { text: 'Max height?', question: 'What is the maximum height?' },
            { text: 'Investment potential?', question: 'What is the investment potential?' },
            { text: 'Permit process?', question: 'What is the process to get a permit?' }
        ];

        actions.forEach(action => {
            const button = document.createElement('button');
            button.className = 'location-btn';
            button.textContent = action.text;
            button.onclick = () => askQuestion(action.question);
            quickActions.appendChild(button);
        });

        chatContainer.insertBefore(quickActions, chatContainer.querySelector('.ai-response'));
    }

    function askQuestion(question) {
        const chatInput = document.getElementById('chatInput');
        chatInput.value = question;
        autoResizeTextarea();
        sendMessage();
    }

    function showBottomPanel() {
        const panel = document.getElementById('bottomPanel');
        panel.classList.add('show');
    }

    function showNoDataMessage() {
        const chatContainer = document.getElementById('chatContainer');
        const aiResponse = document.getElementById('aiResponse');
        
        aiResponse.innerHTML = `üåå No zoning data found for this location.\n\nTry clicking closer to central Kigali areas.`;
        aiResponse.className = 'ai-response response-warning';
        chatContainer.classList.add('show');
        showBottomPanel();
    }

    // API Key functions
    function showApiModal() {
        const modal = document.getElementById('apiKeyModal');
        const input = document.getElementById('apiKeyInput');
        
        if (claudeApiKey) {
            input.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        }
        
        modal.classList.add('show');
        input.focus();
    }

    function closeApiModal() {
        const modal = document.getElementById('apiKeyModal');
        modal.classList.remove('show');
    }

    function saveApiKey() {
        const input = document.getElementById('apiKeyInput');
        const key = input.value.trim();
        
        if (!key || key === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
            alert('Please enter a valid API key');
            return;
        }
        
        if (!key.startsWith('sk-ant-')) {
            alert('Invalid API key format. Claude API keys should start with "sk-ant-"');
            return;
        }
        
        claudeApiKey = key;
        sessionStorage.setItem('claude_api_key', key);
        
        const apiBtn = document.getElementById('apiKeyBtn');
        apiBtn.innerHTML = '‚úÖ AI Ready';
        apiBtn.style.background = 'linear-gradient(135deg, var(--nebular-aurora-green) 0%, var(--nebular-stellar-gold) 100%)';
        
        closeApiModal();
        
        const chatInput = document.getElementById('chatInput');
        chatInput.placeholder = 'Ask Claude: "Can I build a restaurant here?", "What\'s the maximum height?"';
        
        alert('üöÄ Claude AI is now ready to assist with your zoning questions!');
    }

    function initializeApiKey() {
        const storedKey = sessionStorage.getItem('claude_api_key');
        if (storedKey) {
            claudeApiKey = storedKey;
            const apiBtn = document.getElementById('apiKeyBtn');
            apiBtn.innerHTML = '‚úÖ AI Ready';
            apiBtn.style.background = 'linear-gradient(135deg, var(--nebular-aurora-green) 0%, var(--nebular-stellar-gold) 100%)';
        }
    }

    // Claude API Integration
    async function callClaudeAPI(message, context = {}) {
        if (!claudeApiKey) {
            throw new Error('Please configure your Claude API key first');
        }

        const systemPrompt = `You are TerraNebular's AI assistant, an expert in Kigali city zoning regulations and development guidance. You help users understand zoning laws, building permits, and development opportunities in Kigali, Rwanda.

Current context:
- Selected zone: ${context.zoneName || 'Unknown'}
- Zone description: ${context.zoneDescription || 'Not available'}
- Coordinates: ${context.coordinates || 'Not specified'}

Your responses should be:
- Accurate and based on official Kigali zoning regulations
- Helpful for developers, investors, and residents
- Include specific regulatory details when available
- Mention when users should contact City of Kigali for official confirmation
- Use emojis appropriately to make responses engaging
- Be concise but comprehensive

Always remind users that final decisions require official approval from City of Kigali planning authorities.`;

        const userMessage = `Zone: ${context.zoneName || 'Unknown'}
User Question: ${message}

Please provide expert guidance on this zoning question for Kigali city development.`;

        try {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': claudeApiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-3-sonnet-20240229',
                    max_tokens: 1000,
                    system: systemPrompt,
                    messages: [
                        {
                            role: 'user',
                            content: userMessage
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            return data.content[0].text;

        } catch (error) {
            console.error('Claude API Error:', error);
            throw error;
        }
    }

    // Message sending
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const question = input.value.trim();
        
        if (!question || !currentZoning) return;
        
        const sendBtn = document.getElementById('sendBtn');
        const aiResponse = document.getElementById('aiResponse');
        const chatContainer = document.getElementById('chatContainer');
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '‚è≥';
        
        const loadingMsg = claudeApiKey ? 
            'ü§ñ Claude is analyzing your zoning question...' : 
            'üåå Analyzing development patterns...';
        
        aiResponse.innerHTML = loadingMsg;
        aiResponse.className = 'ai-response';
        chatContainer.classList.add('show');
        
        input.value = '';
        input.style.height = 'auto';
        
        try {
            let response;
            
            if (claudeApiKey) {
                try {
                    const context = {
                        zoneName: currentZoning.zoneName,
                        zoneDescription: currentZoning.description,
                        coordinates: currentLocation ? `${currentLocation.latitude}, ${currentLocation.longitude}` : null
                    };
                    response = await callClaudeAPI(question, context);
                } catch (error) {
                    console.error('Claude API failed, falling back to local response:', error);
                    const errorMsg = error.message.includes('API Error: 401') ? 
                        'üîë Invalid API key. Please check your Claude API configuration.' :
                        '‚ö†Ô∏è AI service temporarily unavailable. Using local knowledge...';
                    response = errorMsg + '\n\n' + generateLocalResponse(question, currentZoning);
                }
            } else {
                response = generateLocalResponse(question, currentZoning);
            }
            
            let responseClass = 'ai-response';
            if (response.includes('‚úÖ YES')) {
                responseClass += ' response-success';
            } else if (response.includes('‚ùå NO')) {
                responseClass += ' response-error';
            } else if (response.includes('‚ö†Ô∏è MAYBE')) {
                responseClass += ' response-warning';
            }
            
            aiResponse.innerHTML = response;
            aiResponse.className = responseClass;
            
        } catch (error) {
            console.error('Error generating response:', error);
            aiResponse.innerHTML = '‚ùå Sorry, I encountered an error generating a response. Please try again.';
            aiResponse.className = 'ai-response response-error';
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '‚û§';
        }
    }

    // Local response generation
    function generateLocalResponse(question, zoning) {
        const zoneName = zoning.zoneName;
        const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
            description: 'Development zone per master plan',
            permitted: ['Check regulations'],
            prohibited: ['Check regulations'],
            conditional: ['Check regulations'],
            maxHeight: 'Check regulations',
            minLotSize: 'Check regulations',
            coverage: 'Check regulations'
        };

        const lowerQuestion = question.toLowerCase();
        
        // Building permission questions
        if (lowerQuestion.includes('can i build') || lowerQuestion.includes('restaurant')) {
            const buildingType = extractBuildingType(question);
            
            if (buildingType === 'restaurant') {
                const isPermitted = regulations.permitted.some(item => 
                    item.toLowerCase().includes('restaurant') || item.toLowerCase().includes('commercial')
                );
                const isConditional = regulations.conditional.some(item => 
                    item.toLowerCase().includes('restaurant')
                );
                
                if (isPermitted || isConditional) {
                    return `‚úÖ YES - RESTAURANT IS ${isPermitted ? 'PERMITTED' : 'CONDITIONALLY ALLOWED'}

Zone: ${zoneName}
Status: ${isPermitted ? 'FULLY ALLOWED' : 'NEEDS APPROVAL'}

üìã Requirements:
‚Ä¢ Min lot size: ${regulations.minLotSize}
‚Ä¢ Max height: ${regulations.maxHeight}
‚Ä¢ Max coverage: ${regulations.coverage}

üöÄ You can proceed with your restaurant project!

üìû Contact City of Kigali Planning Office for permits.`;
                } else {
                    return `‚ùå NO - RESTAURANT IS NOT EXPLICITLY PERMITTED

Zone: ${zoneName}

üí° Consider these zones instead:
‚Ä¢ C1-Mixed use zone
‚Ä¢ C3-City commercial zone

üìû Contact City of Kigali for clarification.`;
                }
            }
        }
        
        // Height questions
        if (lowerQuestion.includes('height') || lowerQuestion.includes('how tall')) {
            return `üìè Maximum Height in ${zoneName}

Maximum Height: ${regulations.maxHeight}

üìã Details:
‚Ä¢ Coverage: ${regulations.coverage}
‚Ä¢ Min Lot Size: ${regulations.minLotSize}

üìû Contact City of Kigali for height variance requests.`;
        }
        
        // Investment questions
        if (lowerQuestion.includes('investment') || lowerQuestion.includes('potential')) {
            const investmentScore = getInvestmentScore(zoneName);
            return `üìà Investment Potential for ${zoneName}

Score: ${investmentScore}/10

üí° This zone is ${getInvestmentCategory(investmentScore)} for development.

Key factors:
‚Ä¢ Permitted uses: ${regulations.permitted.slice(0, 3).join(', ')}
‚Ä¢ Max height: ${regulations.maxHeight}
‚Ä¢ Coverage: ${regulations.coverage}

üìû Contact City of Kigali for market studies.`;
        }
        
        // Process questions
        if (lowerQuestion.includes('process') || lowerQuestion.includes('permit')) {
            return `üìã Development Process in Kigali

1. Verify Zoning ‚úÖ (You're here!)
2. Feasibility Study
3. Prepare Plans
4. Apply for Permits
5. Environmental Assessment (if required)
6. Construction
7. Inspections

üìû Contact: City of Kigali Planning Office
üåê Visit: kigalicity.gov.rw`;
        }
        
        // Default response
        return `üåå General Information for ${zoneName}

Description: ${regulations.description}

‚úÖ PERMITTED: ${regulations.permitted.slice(0, 3).join(', ')}
‚ùå PROHIBITED: ${regulations.prohibited.slice(0, 2).join(', ')}
‚ö†Ô∏è CONDITIONAL: ${regulations.conditional.slice(0, 2).join(', ')}

üìè Key Regulations:
‚Ä¢ Max Height: ${regulations.maxHeight}
‚Ä¢ Min Lot Size: ${regulations.minLotSize}
‚Ä¢ Max Coverage: ${regulations.coverage}

üí° Ask specific questions like:
‚Ä¢ Can I build a restaurant here?
‚Ä¢ What's the maximum height?
‚Ä¢ What's the investment potential?

üìû Contact City of Kigali for detailed guidance.`;
    }

    function extractBuildingType(question) {
        const lowerQuestion = question.toLowerCase();
        const buildingTypes = {
            'restaurant': ['restaurant', 'eatery', 'diner', 'cafe'],
            'hotel': ['hotel', 'lodge', 'guest house'],
            'house': ['house', 'home', 'residence'],
            'shop': ['shop', 'store', 'retail'],
            'apartment': ['apartment', 'flat', 'residential building'],
            'office': ['office', 'workspace'],
            'warehouse': ['warehouse', 'storage']
        };
        
        for (const [type, keywords] of Object.entries(buildingTypes)) {
            for (const keyword of keywords) {
                if (lowerQuestion.includes(keyword)) {
                    return type;
                }
            }
        }
        return null;
    }

    function getInvestmentScore(zoneName) {
        const scores = {
            'C3-City commercial zone': 9,
            'C1-Mixed use zone': 8,
            'R4-High density residential zone': 7,
            'R1-Low density residential zone': 6,
            'I1-Light industrial zone': 6,
            'A1-Agriculture zone': 4
        };
        return scores[zoneName] || 5;
    }

    function getInvestmentCategory(score) {
        if (score >= 8) return 'excellent';
        if (score >= 6) return 'good';
        if (score >= 4) return 'moderate';
        return 'limited';
    }

    // Use current location
    function useCurrentLocation() {
        const btn = document.getElementById('useLocationBtn');
        
        if (!navigator.geolocation) {
            alert('üõ∏ Your device cannot detect cosmic coordinates');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = 'üõ∞Ô∏è Scanning...';
        updateStatus('loading', 'Getting your location...');
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Check if location is in Kigali area
                if (lat < -2.2 || lat > -1.7 || lng < 29.8 || lng > 30.3) {
                    btn.disabled = false;
                    btn.innerHTML = 'üìç Use My Location';
                    updateStatus('ready', 'Location outside Kigali area');
                    alert('üöÄ Your location is outside the Kigali area.\n\nTerraNebular is optimized for Kigali zoning.');
                    return;
                }
                
                // Center map on user location
                map.setView([lat, lng], 16);
                
                // Simulate map click at user location
                handleMapClick({ latlng: { lat: lat, lng: lng } });
                
                btn.disabled = false;
                btn.innerHTML = '‚ú® Location Found';
                updateStatus('ready', 'Analyzing your location...');
                
                setTimeout(() => {
                    btn.innerHTML = 'üìç Use My Location';
                }, 3000);
            },
            function(error) {
                btn.disabled = false;
                btn.innerHTML = 'üìç Use My Location';
                
                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'üì° TerraNebular needs location access.\n\nPlease allow and try again.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'üõ∏ Unable to detect position.\n\nCheck GPS/internet.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '‚è∞ Location scan timed out.\n\nTry again.';
                        break;
                    default:
                        errorMessage = '‚ùå Location error.\n\nTry clicking the map.';
                        break;
                }
                alert(errorMessage);
                updateStatus('ready', 'Location error');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }

    function updateStatus(status, text) {
        const dot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        if (!dot || !statusText) return;
        
        dot.className = `status-dot ${status}`;
        
        const cosmicMessages = {
            'loading': 'üåå Cosmic sensors active...',
            'ready': '‚ú® Ready to explore',
            'error': '‚ùå Navigation error',
            'Getting your location...': 'üõ∞Ô∏è Scanning coordinates...',
            'Analyzing your location...': 'üîç Analyzing potential...',
            'Location outside Kigali area': 'üöÄ Outside Kigali galaxy',
            'Location error': '‚ùå Location error'
        };
        
        statusText.textContent = cosmicMessages[text] || text;
    }

    // Auto-resize textarea
    function autoResizeTextarea() {
        const textarea = document.getElementById('chatInput');
        textarea.style.height = 'auto';
        textarea.style.height = `${Math.min(textarea.scrollHeight, 80)}px`;
    }
