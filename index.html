<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>üåå TerraNebular</title>
    
    <!-- ArcGIS CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <style>
        /* TerraNebular Cosmic Color Palette */
        :root {
            --nebular-deep-blue: #0F172A;
            --nebular-space-blue: #1E3A8A;
            --nebular-cosmic-purple: #6366F1;
            --nebular-stellar-gold: #F59E0B;
            --nebular-plasma-pink: #EC4899;
            --nebular-void-black: #000000;
            --nebular-stardust: #E2E8F0;
            --nebular-aurora-green: #10B981;
            --nebular-comet-white: #F8FAFC;
            --nebular-meteor-orange: #F97316;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            overflow: hidden;
        }
        
        #viewDiv {
            height: 100vh;
            width: 100%;
            position: relative;
        }
        
        /* Cosmic Header */
        #mobileHeader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--nebular-deep-blue) 0%, var(--nebular-space-blue) 50%, var(--nebular-cosmic-purple) 100%);
            color: var(--nebular-comet-white);
            padding: 12px 16px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .location-btn {
            background: linear-gradient(135deg, var(--nebular-stellar-gold) 0%, var(--nebular-meteor-orange) 100%);
            color: var(--nebular-comet-white);
            border: none;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.4);
            transition: all 0.3s ease;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }
        
        .location-btn:active {
            transform: translateY(0);
        }
        
        .location-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-deep-blue);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .app-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }
        
        .app-subtitle {
            font-size: 11px;
            opacity: 0.9;
            margin: 2px 0 0 0;
            line-height: 1.3;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--nebular-stellar-gold);
            animation: cosmicPulse 2s infinite;
            box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
        }
        
        .status-dot.ready {
            background: var(--nebular-aurora-green);
            animation: none;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
        }
        
        @keyframes cosmicPulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
                box-shadow: 0 0 6px rgba(245, 158, 11, 0.6);
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.1);
                box-shadow: 0 0 12px rgba(245, 158, 11, 0.8);
            }
        }
        
        /* Hidden file upload */
        #fileUpload {
            display: none;
        }
        
        /* Cosmic Bottom Panel */
        #bottomPanel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -8px 32px rgba(15, 23, 42, 0.3);
            z-index: 100;
            max-height: 50vh;
            transition: transform 0.3s ease;
            transform: translateY(100%);
            backdrop-filter: blur(10px);
        }
        
        #bottomPanel.show {
            transform: translateY(0);
        }
        
        .panel-handle {
            width: 40px;
            height: 4px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            border-radius: 2px;
            margin: 12px auto 8px;
            opacity: 0.7;
        }
        
        .panel-content {
            padding: 0 20px 20px;
            overflow-y: auto;
            max-height: 40vh;
        }
        
        .location-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .zone-info {
            flex: 1;
        }
        
        .zone-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--nebular-deep-blue);
            margin: 0 0 4px 0;
            line-height: 1.3;
        }
        
        .zone-description {
            font-size: 12px;
            color: var(--nebular-space-blue);
            margin: 0;
            line-height: 1.4;
        }
        
        .zone-color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--nebular-comet-white);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.2);
            flex-shrink: 0;
        }
        
        /* Cosmic AI Chat Interface */
        .chat-container {
            background: linear-gradient(135deg, var(--nebular-stardust) 0%, var(--nebular-comet-white) 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 8px;
            display: none;
            box-shadow: inset 0 1px 3px rgba(15, 23, 42, 0.1);
        }
        
        .chat-container.show {
            display: block;
        }
        
        .ai-response {
            background: linear-gradient(135deg, var(--nebular-comet-white) 0%, var(--nebular-stardust) 100%);
            padding: 14px;
            border-radius: 12px;
            border-left: 4px solid var(--nebular-cosmic-purple);
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
            color: var(--nebular-deep-blue);
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid var(--nebular-stardust);
            border-radius: 20px;
            font-size: 13px;
            resize: none;
            min-height: 40px;
            max-height: 80px;
            outline: none;
            transition: all 0.3s ease;
            background: var(--nebular-comet-white);
            color: var(--nebular-deep-blue);
        }
        
        .chat-input:focus {
            border-color: var(--nebular-cosmic-purple);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .chat-input::placeholder {
            color: var(--nebular-space-blue);
            font-style: italic;
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: var(--nebular-comet-white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(99, 102, 241, 0.4);
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.6);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .send-btn:disabled {
            background: var(--nebular-stardust);
            color: var(--nebular-space-blue);
            box-shadow: none;
            transform: none;
        }
        
        /* Cosmic Data Banner */
        .data-banner {
            position: absolute;
            top: 70px;
            left: 16px;
            right: 16px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
            color: var(--nebular-comet-white);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            z-index: 99;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: translateY(-100px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .data-banner.show {
            transform: translateY(0);
        }
        
        .data-banner.loaded {
            background: linear-gradient(135deg, var(--nebular-aurora-green) 0%, var(--nebular-stellar-gold) 100%);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }
        
        /* Cosmic Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 58, 138, 0.95) 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            flex-direction: column;
            gap: 20px;
            backdrop-filter: blur(10px);
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(226, 232, 240, 0.3);
            border-top: 3px solid var(--nebular-cosmic-purple);
            border-radius: 50%;
            animation: cosmicSpin 1s linear infinite;
        }
        
        @keyframes cosmicSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--nebular-comet-white);
            font-weight: 600;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Cosmic Response States */
        .response-success {
            border-left-color: var(--nebular-aurora-green);
            background: linear-gradient(135deg, #ECFDF5 0%, #F0FDF4 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }
        
        .response-warning {
            border-left-color: var(--nebular-stellar-gold);
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.1);
        }
        
        .response-error {
            border-left-color: var(--nebular-plasma-pink);
            background: linear-gradient(135deg, #FDF2F8 0%, #FCE7F3 100%);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.1);
        }
        
        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .quick-actions .location-btn {
            font-size: 11px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--nebular-cosmic-purple) 0%, var(--nebular-plasma-pink) 100%);
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 480px) {
            .panel-content {
                padding: 0 12px 16px;
            }
            
            .app-title {
                font-size: 14px;
            }
            
            .app-subtitle {
                font-size: 10px;
            }
            
            .location-btn {
                padding: 5px 8px;
                font-size: 9px;
            }
            
            .quick-actions .location-btn {
                font-size: 10px;
                padding: 5px 10px;
            }
            
            .zone-name {
                font-size: 14px;
            }
            
            .zone-description {
                font-size: 11px;
            }
            
            .ai-response {
                padding: 12px;
                font-size: 12px;
            }
            
            .chat-input {
                padding: 10px 12px;
                font-size: 12px;
                min-height: 38px;
            }
            
            .send-btn {
                width: 38px;
                height: 38px;
                border-radius: 19px;
            }
            
            .chat-input::placeholder {
                font-size: 11px;
            }
        }
        
        @media (max-width: 360px) {
            .app-title {
                font-size: 13px;
            }
            
            .app-subtitle {
                font-size: 9px;
            }
            
            .location-btn {
                padding: 4px 6px;
                font-size: 8px;
            }
            
            .panel-content {
                padding: 0 10px 14px;
            }
            
            .zone-name {
                font-size: 13px;
            }
            
            .zone-description {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Hidden file upload -->
    <input type="file" id="fileUpload" accept=".json,.geojson" />
    
    <!-- Mobile Header -->
    <div id="mobileHeader">
        <div class="header-content">
            <div>
                <h1 class="app-title">üåå TerraNebular</h1>
                <p class="app-subtitle">Where Development Dreams Take Shape</p>
            </div>
            <div class="header-controls">
                <button class="location-btn" id="useLocationBtn" onclick="useCurrentLocation()">
                    üìç Use My Location
                </button>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Status Banner -->
    <div class="data-banner" id="dataBanner" onclick="loadDataFile()">
        üåå Tap to load cosmic zoning data
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading zoning data...</div>
    </div>
    
    <!-- Map Container -->
    <div id="viewDiv"></div>
    
    <!-- Bottom Panel -->
    <div id="bottomPanel">
        <div class="panel-handle"></div>
        <div class="panel-content">
            <div class="location-header" id="locationHeader" style="display: none;">
                <div class="zone-color-indicator" id="zoneColorIndicator"></div>
                <div class="zone-info">
                    <h3 class="zone-name" id="zoneName">Select a location</h3>
                    <p class="zone-description" id="zoneDescription">Tap anywhere on the map</p>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="ai-response" id="aiResponse"></div>
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" 
                              placeholder="Ask TerraNebular: 'Can I build a restaurant here?', 'What's the maximum height?', 'Investment potential?'" 
                              rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ArcGIS JavaScript API -->
    <script src="https://js.arcgis.com/4.28/"></script>
    
    <script>
    let currentLocation = null;
    let currentZoning = null;
    let view = null;
    let zoningFeatures = [];
    let spatialIndex = null;
    let conversationHistory = [];

    // Enhanced Zone Details with Complete Official Kigali Regulations
    const KIGALI_ZONING_REGULATIONS = {
        'C1-Mixed use zone': {
            description: 'Zone established to create high flexibility in the mix of uses and ensure continuity in ground level commercial activities',
            permitted: [
                'Commercial/Retail', 'Restaurants and Recreational activities', 'Office use above 1st floor',
                'Co-working spaces', 'Residential', 'Home Occupation'
            ],
            prohibited: [
                'Large scale commercial complex', 'Industrial Uses', 'Major Infrastructure Installations'
            ],
            conditional: [
                'Public Facilities', 'Transportation Terminals', 'Hotels', 'Petrol stations',
                'Garages and Car Repair - Grade E as per RBS', 'Car Wash Services'
            ],
            minLotSize: '500 m¬≤',
            maxHeight: 'G+4 maximum (Additional floors may be authorised along BRT, Wetland Front)',
            maxFAR: '1.6 maximum',
            coverage: '60% maximum',
            landscaping: '10% minimum'
        },
        'C3-City commercial zone': {
            description: 'Zone established to meet most retail, commercial and services needs for larger community',
            permitted: [
                'Developments allowed in C1 zone', 'Shopping centres', 'Offices', 'Hotels',
                'Apartments', 'Leisure and entertainment centres', 'Galleries', 'Education Institutions',
                'Coworking spaces'
            ],
            prohibited: [
                'Major Industrial Uses', 'Major Infrastructure Installations'
            ],
            conditional: [
                'Public Facilities', 'Petrol stations', 'Transport Interchange',
                'Garages and Car Repair - Grade E as per RBS', 'Car Wash Services'
            ],
            minLotSize: '1,000 m¬≤',
            maxHeight: 'G+10 maximum',
            maxFAR: '2.4 maximum',
            coverage: '70% maximum',
            landscaping: '10% minimum'
        },
        'R1-Low density residential zone': {
            description: 'Intended for villa and bungalow typology and complementary public facilities',
            permitted: [
                'Single family houses', 'Home Occupation'
            ],
            prohibited: [
                'Industrial uses', 'Major infrastructure'
            ],
            conditional: [
                'Uses as per R1A regulations', 'Apartments exceeding G + 2', 'Semi-Detached',
                'Multifamily Houses', 'Restaurants, Guest houses, B&B, Hotels',
                'Public facilities when suggested by Public Facilities Overlay',
                'Commercial Retail Facilities when allowed by O-C2 Overlay',
                'Accessory Residential Units'
            ],
            minLotSize: 'Max 500 m¬≤ as per URBAN PLANNING CODE',
            maxHeight: 'G+1+P (Penthouse)',
            maxFAR: '0.5 maximum',
            coverage: '40% maximum',
            landscaping: '20% minimum'
        },
        'R1A-Low density residential densification zone': {
            description: 'Residential zone for semidetached houses, single family townhouses, multifamily Houses, and low-rise developments',
            permitted: [
                'Single family houses (all types)', 'Semi-detached houses', 'Multifamily Houses',
                'Townhouses', 'Row houses', 'Home Occupation', 'Accessory Residential Units'
            ],
            prohibited: [
                'Residential exceeding G + 2', 'Industrial uses', 'Major infrastructure'
            ],
            conditional: [
                'Restaurants, Hotels, Guest houses, B&B',
                'Public facilities as per Public Facilities overlay (Section 7.1)',
                'Commercial retail, office facilities when allowed by O-C2 Overlay (Section 6.2.2)'
            ],
            ancillary: [
                'Car parking garage', 'Store and Service rooms', 'Guard House'
            ],
            minLotSize: 'Max. 300 m¬≤',
            maxHeight: 'G+2',
            maxFAR: '1.0 maximum',
            coverage: '50% maximum',
            landscaping: '20% minimum'
        },
        'R1B-Rural residential zone': {
            description: 'Residential zone offering compact developments in rural areas as part of the farming community',
            permitted: [
                'Single family Houses', 'Row housing',
                'Multifamily residential (4 in 1, 8 in 1, etc) as per IDP model Villages',
                'Low-rise apartments', 'Home Occupation', 'Accessory Residential Units'
            ],
            prohibited: [
                'Industrial uses', 'Major infrastructure'
            ],
            conditional: [
                'Restaurants', 'Guest house',
                'Public facilities, when allowed by public facilities overlay (Section 7.1)',
                'Commercial retail, office facilities when allowed by O-C2 Overlay (Section 6.2.2)',
                'Micro - Enterprise'
            ],
            ancillary: [
                'Car parking garage', 'Outdoor kitchen', 'Store rooms'
            ],
            minLotSize: 'Max 100 m¬≤ for Row Housing or Single-Family Units',
            maxHeight: 'G + 1 for single family houses, G+2 for all other typologies',
            maxFAR: '1.2 maximum',
            coverage: '60% maximum',
            landscaping: 'N/A'
        },
        'R2-Medium density residential - Improvement zone': {
            description: 'Planned for upgradation of unplanned settlements or redevelopment of urban renewal areas',
            permitted: [
                'Row housing', 'Low Rise apartments', 'Home Occupation', 'Accessory Residential Units'
            ],
            prohibited: [
                'Major Industrial uses', 'Major infrastructure', 'Single Family Residential Developments'
            ],
            conditional: [
                'Restaurants', 'Hotels (incl. its ancillary uses), Guest house, B&B',
                'Public facilities, when allowed by public facilities overlay (Section 7.1)',
                'Commercial retail, office when allowed by O-C2 Overlay (Section 6.2.2)',
                'Micro Enterprise'
            ],
            ancillary: [
                'Store and Services rooms'
            ],
            minLotSize: 'Rowhouses: Max 200 m¬≤',
            maxHeight: 'G+3',
            maxFAR: '1.4 maximum',
            coverage: '60% maximum',
            landscaping: '20% minimum',
            specialNote: 'CoK at its discretion may accept affordable level of building and infrastructure provision standards for upgrading'
        },
        'R3-Medium density residential - Expansion zone': {
            description: 'Established to allow intensification and redevelopment of peri-urban and green field areas',
            permitted: [
                'Single family Residential', 'Rowhouses', 'Low-rise apartments', 'Multifamily Houses',
                'Accessory Residential units', 'Home Occupation'
            ],
            prohibited: [
                'Industrial uses', 'Major infrastructure',
                'Any development that does not meet affordability criteria'
            ],
            conditional: [
                'Restaurants', 'Hotels/Guest houses', 'Public facilities when allowed by overlay',
                'Commercial retail, office, when allowed by O-C2 Overlay', 'Micro Enterprise'
            ],
            minLotSize: 'Max 100m¬≤ for incremental Single-Family Housing, Max 150 m¬≤ for Row housing',
            maxHeight: 'G+2',
            maxFAR: '1.2 maximum',
            coverage: '60% maximum',
            landscaping: '20% minimum'
        },
        'R4-High density residential zone': {
            description: 'Established to create well planned medium-rise housing and apartment complexes',
            permitted: [
                'High density residential', 'Home Occupation', 'R2 typologies in case plot size is less than 750 m¬≤'
            ],
            prohibited: [
                'Industrial uses', 'Major infrastructure'
            ],
            conditional: [
                'Restaurants', 'Hotels, Guest house, B&B', 'Public facilities when allowed by overlay',
                'Commercial retail, office, Micro-Enterprise when allowed by O-C2 Overlay',
                'Micro - Enterprise'
            ],
            minLotSize: '750 m¬≤',
            maxHeight: 'G+4 (apartments) maximum',
            maxFAR: '1.8 maximum',
            coverage: '50% maximum',
            landscaping: '20% minimum'
        },
        'I1-Light industrial zone': {
            description: 'Specialised land areas for clean and light industrial environment that could blend with surrounding residential area',
            permitted: [
                'Agricultural processing plants', 'Industrial Bakeries', 'Building material and lumber storage',
                'Cabinetmaking and carpenter workshops', 'Petrol stations', 'Food processing',
                'Light manufacturing and assembly', 'Car wash', 'Machine shops',
                'Automotive repair shops', 'Wholesale and warehousing', 'Dry cleaning/laundry service',
                'Business Parks, Science Parks'
            ],
            prohibited: [
                'Residential Uses not related to other activities present on site',
                'Major Infrastructure Installations'
            ],
            conditional: [
                'Railroad yards and freight stations', 'Trucking yard or terminal',
                'Concrete or stone products manufacturing plants', 'Grain milling',
                'Higher Education Institutions', 'Co-working spaces and incubators',
                'Treatment of wastewater', 'Religious Facilities', 'Residential at service of other uses',
                'Grocery shop and small retail', 'Restaurants and food outlets', 'Hotels, B&B, Guesthouses',
                'Commercial Uses'
            ],
            minLotSize: '250 m¬≤',
            maxHeight: '10.00 m',
            maxFAR: '1.2 maximum',
            coverage: '60% maximum',
            landscaping: '10% minimum'
        },
        'I2-General industrial zone': {
            description: 'Specialised land areas strategically located close to expressways for easy access for heavy vehicles',
            permitted: [
                'All uses allowed in I1 ‚Äì Light Industrial Zone', 'Batching and mixing plants, asphalt, cement, and concrete',
                'Manufacturing', 'Brewing or distilling of liquor', 'Building wreckers and house mover storage yards',
                'Foundries', 'Manufacture of paper products', 'Storage of oil, gasoline or petroleum products',
                'Structural steel fabrication'
            ],
            prohibited: [
                'Residential Uses', 'Major Infrastructure Installations'
            ],
            conditional: [
                'All uses conditionally allowed in I1 ‚Äì Light Industrial Zone',
                'Heavy salvage, junk, and auto wrecking yards', 'Electric power generating plants',
                'Slaughterhouses', 'Workers Accommodation', 'Grocery shop', 'Restaurants'
            ],
            minLotSize: '1,000 m¬≤',
            maxHeight: 'N/A',
            maxFAR: 'N/A',
            coverage: '60% maximum',
            landscaping: '10% minimum',
            buffer: 'General Industries: 100m from nearest residential areas, Special Industries: 500m from nearest residential areas'
        },
        'PF1-Education and research facilities': {
            description: 'Educational institutions and research centers',
            permitted: [
                'All types of educational institutes', 'Research facilities'
            ],
            prohibited: [
                'Industrial uses and warehouses', 'Major commercial uses',
                'Public utility maintenance facilities with outdoor storage', 'Cemeteries/crematoriums'
            ],
            conditional: [
                'Canteens', 'Small commercial and retail use', 'Health centres and pharmacy',
                'Accommodations for teachers, workers', 'Hostels/Dormitories/Residences'
            ],
            minLotSize: 'N/A',
            maxHeight: 'N/A',
            coverage: 'N/A',
            landscaping: 'N/A'
        },
        'PF2-Health facilities': {
            description: 'Healthcare and medical facilities',
            permitted: [
                'All types of health facilities', 'Pharmacy'
            ],
            prohibited: [
                'Industrial uses and warehouses', 'Major commercial uses',
                'Public utility maintenance facilities with outdoor storage', 'Cemeteries/crematoriums'
            ],
            conditional: [
                'Restaurants', 'Small commercial and retail use', 'Accommodations for health workers'
            ],
            minLotSize: 'N/A',
            landscaping: '20% minimum'
        },
        'A1-Agriculture zone': {
            description: 'Strives to protect the viability of agriculture and prevent farmland conversion to non-farm uses',
            permitted: [
                'Crop farming', 'Agro-forestry', 'Livestock farming', 'Green houses', 'Bee Keeping', 'Fish farming'
            ],
            prohibited: [
                'All types of industrial uses not linked to Agro-Processing uses',
                'All types of residential uses not linked to farming activities',
                'All types of commercial uses not linked to temporary farm store',
                'All types of public facilities'
            ],
            conditional: [
                'Supporting Agricultural uses', 'Temporary Farm store', 'Infrastructure',
                'Rural Villages for agricultural plots larger than 5 ha after land assembly has been conducted',
                'Single family Houses on agricultural plots larger than 1 ha provided they are linked to farming activities',
                'Small scale Agro-processing facilities on agricultural land not less than 0.5 ha'
            ],
            ancillary: [
                'Storage barns', 'Parking', 'Store for agricultural equipment, cattle sheds'
            ],
            minLotSize: 'N/A',
            maxHeight: 'G (Ground floor only)',
            maxFAR: 'Single Family Houses: 0.01 up to 150 m¬≤ for plots above 1 ha, Agro-processing facilities: 0.02 up to 200 m¬≤ for plots above 0.5 Ha',
            coverage: 'N/A',
            landscaping: 'N/A'
        },
        'P1-Parks and open spaces zone': {
            description: 'Established to provide recreational and leisure facilities in areas with unique features',
            permitted: [
                'Botanical gardens, arboretums, and conservatories',
                'Outdoor recreational facilities such as hiking and bicycle trails',
                'Greens and commons, sitting areas and picnic areas',
                'Park related public facilities such as public toilet/changing room'
            ],
            prohibited: [
                'All types of industrial uses', 'All types of residential uses',
                'Commercial uses exceeding prescribed limits', 'All types of major public facilities',
                'Major infrastructure installations'
            ],
            conditional: [
                'Restaurants, kiosks, art and souvenirs shops and other commercial structures not exceeding 0.05 FAR up to 150 m¬≤'
            ],
            minLotSize: 'N/A',
            maxHeight: 'G+1 maximum',
            maxFAR: '0.05 up to 150 m¬≤',
            coverage: 'N/A',
            landscaping: 'N/A'
        },
        'T-Transportation zone': {
            description: 'Identify and locate major transport related areas including public transport services',
            permitted: [
                'All transport infrastructure', 'BRT stations and Terminals',
                'Parking area', 'Holding depots'
            ],
            prohibited: [
                'Major industrial uses', 'Major residential uses'
            ],
            conditional: [
                'Motor repair garage', 'Commercial Uses if developed with Transport Terminals',
                'Service station', 'Commercial and office spaces',
                'Hotels and Restaurants', 'Workers accommodation'
            ],
            minLotSize: 'N/A',
            maxHeight: 'N/A',
            maxFAR: 'N/A',
            coverage: 'N/A',
            landscaping: 'N/A'
        },
        'P3C-Steep slopes (> 30%) zone': {
            description: 'Hillsides and steep slopes prone to natural hazards that need protection from unsustainable encroachment',
            permitted: [
                'Forests', 'Agro-Forestry', 'Bee Keeping', 'Silviculture'
            ],
            prohibited: [
                'All types of developments except those conditionally allowed by Slope Overlay between 30-50% slope'
            ],
            conditional: [
                'Limited development on slopes 30-50% with detailed geotechnical assessment',
                'Strategic tourism developments with substantial community benefits',
                'Developments designed following highest environmental standards with EIA clearance',
                'Nature restoration projects'
            ],
            minLotSize: 'N/A',
            maxHeight: 'N/A - Subject to slope analysis and geotechnical assessment',
            coverage: 'N/A - Determined by slope stability requirements',
            landscaping: 'Maximum preservation of existing vegetation required',
            specialRequirements: [
                'Geotechnical evaluation mandatory',
                'Environmental Impact Assessment required',
                'Grading plan showing feasibility required',
                'Drainage management plan required',
                'Erosion control plan required',
                'Buffer distance of 300m from nearest residential areas for certain activities'
            ]
        }
    };

    // Zone color mapping
    const ZONE_COLORS = {
        'A1-Agriculture zone': '#90EE90',
        'C1-Mixed use zone': '#FFB6C1',
        'C3-City commercial zone': '#CD5626',
        'I1-Light industrial zone': '#DDA0DD',
        'I2-General industrial zone': '#9370DB',
        'I3-Mining/ Extraction/Quarry': '#8B4513',
        'P1-Parks and open spaces zone': '#32CD32',
        'P2-Sport and Eco tourism zone': '#00FA9A',
        'P3B-Forest zone': '#006400',
        'P3C-Steep slopes (> 30%) zone': '#2E8B57',
        'PA-Public Administration zone': '#87CEEB',
        'PF1-Education and research facilities': '#4169E1',
        'PF2-Health facilities': '#0000FF',
        'PF3-Religious facilities': '#191970',
        'PF4-Cultural/ memorial sites': '#6495ED',
        'PF5-Cemetery/ crematoria': '#B0C4DE',
        'R1-Low density residential zone': '#FFFFE0',
        'R1A-Low density residential densification zone': '#FFFACD',
        'R1B-Rural residential zone': '#F0E68C',
        'R2-Medium density residential - Improvement zone': '#F59E0B',
        'R3-Medium density residential - Expansion zone': '#FF7F50',
        'R4-High density residential zone': '#FF6347',
        'T-Transportation zone': '#A9A9A9',
        'U-Utility zone': '#D3D3D3',
        'W2 - Rehabilitation': '#98FB98',
        'W3 - Sustainable Exploitation': '#90EE90',
        'W4 - Conservation': '#8FBC8F',
        'W5 - Recreational': '#87CEEB',
        'WR-Waterbody zone': '#87CEEB'
    };

    // Enhanced building types with more keywords
    const buildingTypes = {
        'restaurant': ['restaurant', 'eatery', 'diner', 'cafe', 'food outlet', 'bistro', 'kitchen'],
        'hotel': ['hotel', 'lodge', 'guest house', 'accommodation', 'motel', 'inn', 'hostel'],
        'house': ['house', 'home', 'residence', 'dwelling', 'villa', 'bungalow', 'cottage'],
        'shop': ['shop', 'store', 'retail', 'boutique', 'market', 'grocery', 'supermarket'],
        'apartment': ['apartment', 'flat', 'condo', 'residential building', 'multi-family', 'high-rise'],
        'office': ['office', 'workspace', 'business center', 'co-working', 'commercial office'],
        'warehouse': ['warehouse', 'storage', 'depot', 'distribution center', 'logistics'],
        'factory': ['factory', 'manufacturing', 'industry', 'plant', 'production'],
        'shopping center': ['shopping center', 'mall', 'plaza', 'commercial center'],
        'nightclub': ['nightclub', 'club', 'disco', 'bar', 'lounge'],
        'supermarket': ['supermarket', 'grocery', 'market', 'food store'],
        'school': ['school', 'education', 'university', 'college', 'academy', 'institute'],
        'hospital': ['hospital', 'clinic', 'medical', 'health center', 'healthcare'],
        'farm': ['farm', 'agriculture', 'farming', 'ranch', 'plantation'],
        'greenhouse': ['greenhouse', 'agricultural structure', 'hydroponics'],
        'parking': ['parking', 'garage', 'car park', 'parking lot'],
        'transport': ['transport', 'terminal', 'station', 'transit hub'],
        'petrol station': ['petrol station', 'gas station', 'fuel station', 'service station'],
        'garage': ['garage', 'auto repair', 'car repair', 'mechanic']
    };

    // Use current location functionality
    function useCurrentLocation() {
        const btn = document.getElementById('useLocationBtn');
        
        if (!navigator.geolocation) {
            alert('üõ∏ Your device cannot detect cosmic coordinates');
            return;
        }
        
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = 'üõ∞Ô∏è Scanning...';
        updateStatus('loading', 'Getting your location...');
        
        navigator.geolocation.getCurrentPosition(
            // Success callback
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Check if location is in Kigali area (rough bounds)
                if (lat < -2.2 || lat > -1.7 || lng < 29.8 || lng > 30.3) {
                    btn.disabled = false;
                    btn.innerHTML = 'üìç Use My Location';
                    updateStatus('ready', 'Location outside Kigali area');
                    alert('üöÄ Your cosmic coordinates are outside the Kigali development galaxy.\n\nTerraNebular is currently optimized for Kigali\'s zoning universe.');
                    return;
                }
                
                // Center map on user location
                if (view) {
                    view.center = [lng, lat];
                    view.zoom = 16;
                    
                    // Create a point and simulate click
                    require(["esri/geometry/Point"], function(Point) {
                        const userPoint = new Point({
                            longitude: lng,
                            latitude: lat,
                            spatialReference: view.spatialReference
                        });
                        
                        // Simulate map click at user location
                        handleMapClick({ mapPoint: userPoint });
                    });
                }
                
                btn.disabled = false;
                btn.innerHTML = '‚ú® Location Found';
                updateStatus('ready', 'Analyzing your location...');
                
                // Reset button text after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = 'üìç Use My Location';
                }, 3000);
            },
            // Error callback
            function(error) {
                btn.disabled = false;
                btn.innerHTML = 'üìç Use My Location';
                
                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'üì° TerraNebular needs access to your cosmic coordinates.\n\nPlease allow location access and try again.';
                        updateStatus('ready', 'Location permission denied');
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'üõ∏ Unable to detect your cosmic position.\n\nPlease check your GPS/internet connection.';
                        updateStatus('ready', 'Location unavailable');
                        break;
                    case error.TIMEOUT:
                        errorMessage = '‚è∞ Cosmic location scan timed out.\n\nPlease try again.';
                        updateStatus('ready', 'Location timeout');
                        break;
                    default:
                        errorMessage = '‚ùå Unknown cosmic navigation error.\n\nPlease try tapping on the map instead.';
                        updateStatus('ready', 'Location error');
                        break;
                }
                alert(errorMessage);
            },
            // Options
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        checkCachedData();
    });

    function initializeApp() {
        updateStatus('loading', 'Initializing map...');
        
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/geometry/Point"
        ], function(Map, MapView, Graphic, Point) {
            
            const map = new Map({
                basemap: "hybrid"  // Keep satellite imagery for better context
            });
            
            view = new MapView({
                container: "viewDiv",
                map: map,
                center: [30.0619, -1.9441],
                zoom: 13,
                ui: {
                    components: ["attribution"]
                }
            });
            
            view.on("click", handleMapClick);
            view.popup.autoOpenEnabled = false;
            
            view.when(() => {
                updateStatus('ready', 'Map ready');
            });
        });
        
        document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
        
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', autoResizeTextarea);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // Auto-resize textarea
    function autoResizeTextarea() {
        const textarea = document.getElementById('chatInput');
        textarea.style.height = 'auto';
        textarea.style.height = `${Math.min(textarea.scrollHeight, 80)}px`;
    }

    // Question type detection
    function detectQuestionType(question) {
        const lowerQuestion = question.toLowerCase();
        
        if (lowerQuestion.includes('can i build') || lowerQuestion.includes('is it allowed') || 
            lowerQuestion.includes('permitted') || lowerQuestion.includes('prohibited')) {
            return 'permission';
        }
        if (lowerQuestion.includes('height') || lowerQuestion.includes('how tall') || 
            lowerQuestion.includes('maximum height')) {
            return 'height';
        }
        if (lowerQuestion.includes('lot size') || lowerQuestion.includes('land size') || 
            lowerQuestion.includes('minimum size')) {
            return 'lot_size';
        }
        if (lowerQuestion.includes('coverage') || lowerQuestion.includes('building coverage')) {
            return 'coverage';
        }
        if (lowerQuestion.includes('investment') || lowerQuestion.includes('potential') || 
            lowerQuestion.includes('opportunity') || lowerQuestion.includes('profitable')) {
            return 'investment';
        }
        if (lowerQuestion.includes('compare') || lowerQuestion.includes('difference') || 
            lowerQuestion.includes('vs')) {
            return 'comparison';
        }
        if (lowerQuestion.includes('process') || lowerQuestion.includes('how to') || 
            lowerQuestion.includes('steps') || lowerQuestion.includes('apply')) {
            return 'process';
        }
        return 'general';
    }

    // Extract building type from question
    function extractBuildingType(question) {
        const lowerQuestion = question.toLowerCase();
        for (const [type, keywords] of Object.entries(buildingTypes)) {
            for (const keyword of keywords) {
                if (lowerQuestion.includes(keyword)) {
                    return type;
                }
            }
        }
        return null;
    }

    // Generate investment potential analysis
    function generateInvestmentAnalysis(zoneName, regulations) {
        const investmentFactors = {
            'C1-Mixed use zone': {
                score: 8,
                pros: ['High flexibility for mixed uses', 'Strong commercial potential', 'Good accessibility'],
                cons: ['Higher land costs', 'Strict design regulations'],
                recommendation: 'Ideal for commercial ventures like restaurants or co-working spaces.'
            },
            'C3-City commercial zone': {
                score: 9,
                pros: ['Prime location for retail and offices', 'High foot traffic', 'Infrastructure support'],
                cons: ['High competition', 'Higher development costs'],
                recommendation: 'Perfect for large-scale commercial projects like shopping centers.'
            },
            'R1-Low density residential zone': {
                score: 6,
                pros: ['Quiet residential appeal', 'Lower density promotes exclusivity', 'Stable demand'],
                cons: ['Limited commercial use', 'Lower ROI for large projects'],
                recommendation: 'Suitable for luxury villas or small-scale residential projects.'
            },
            'R1A-Low density residential densification zone': {
                score: 7,
                pros: ['Supports diverse residential types', 'Good for small-scale developments', 'Growing demand'],
                cons: ['Limited commercial potential', 'Moderate development restrictions'],
                recommendation: 'Great for townhouses or small apartment complexes.'
            },
            'R1B-Rural residential zone': {
                score: 5,
                pros: ['Affordable land prices', 'Supports rural development', 'Flexible for small communities'],
                cons: ['Limited infrastructure', 'Restricted to rural settings'],
                recommendation: 'Ideal for rural housing or small-scale farming communities.'
            },
            'R2-Medium density residential - Improvement zone': {
                score: 7,
                pros: ['Supports urban renewal', 'Moderate density allows growth', 'Community-focused'],
                cons: ['Upgrading challenges', 'Regulatory flexibility needed'],
                recommendation: 'Suitable for redeveloping unplanned settlements.'
            },
            'R3-Medium density residential - Expansion zone': {
                score: 7,
                pros: ['Ideal for peri-urban growth', 'Supports affordable housing', 'Flexible regulations'],
                cons: ['Infrastructure may lag', 'Affordability criteria apply'],
                recommendation: 'Good for expanding residential areas with moderate density.'
            },
            'R4-High density residential zone': {
                score: 8,
                pros: ['High density maximizes land use', 'Strong rental market', 'Urban connectivity'],
                cons: ['Higher construction costs', 'Strict regulations'],
                recommendation: 'Perfect for apartment complexes in urban centers.'
            },
            'I1-Light industrial zone': {
                score: 6,
                pros: ['Supports clean industries', 'Blends with residential areas', 'Diverse permitted uses'],
                cons: ['Limited residential use', 'Moderate investment returns'],
                recommendation: 'Suitable for small-scale industrial or business parks.'
            },
            'I2-General industrial zone': {
                score: 5,
                pros: ['Ideal for heavy industries', 'Good transport access', 'Large plot sizes'],
                cons: ['Restricted residential use', 'Environmental regulations'],
                recommendation: 'Best for large-scale manufacturing or logistics.'
            },
            'PF1-Education and research facilities': {
                score: 7,
                pros: ['Stable demand for education', 'Supports community development', 'Long-term investment'],
                cons: ['Limited commercial use', 'High initial costs'],
                recommendation: 'Ideal for schools or research institutions.'
            },
            'PF2-Health facilities': {
                score: 7,
                pros: ['High community impact', 'Stable healthcare demand', 'Government support'],
                cons: ['Specialized regulations', 'High setup costs'],
                recommendation: 'Suitable for clinics or hospitals.'
            },
            'A1-Agriculture zone': {
                score: 4,
                pros: ['Low land costs', 'Supports food security', 'Sustainable practices'],
                cons: ['Limited development potential', 'Restricted to agricultural use'],
                recommendation: 'Best for farming or agro-processing ventures.'
            },
            'P1-Parks and open spaces zone': {
                score: 5,
                pros: ['Enhances community value', 'Low maintenance costs', 'Eco-friendly'],
                cons: ['Limited revenue potential', 'Restricted development'],
                recommendation: 'Ideal for recreational or eco-tourism projects.'
            },
            'T-Transportation zone': {
                score: 6,
                pros: ['Critical infrastructure support', 'High connectivity', 'Strategic location'],
                cons: ['Limited non-transport uses', 'Regulatory complexity'],
                recommendation: 'Suitable for transport-related developments like terminals.'
            },
            'P3C-Steep slopes (> 30%) zone': {
                score: 3,
                pros: ['Unique environmental appeal', 'Potential for eco-tourism', 'Low competition'],
                cons: ['Strict environmental regulations', 'High development costs'],
                recommendation: 'Best for conservation or specialized tourism projects.'
            },
            'default': {
                score: 5,
                pros: ['Standard zoning regulations', 'Potential for specific uses'],
                cons: ['Limited information available', 'May require additional permits'],
                recommendation: 'Consult City of Kigali for detailed investment analysis.'
            }
        };

        const factors = investmentFactors[zoneName] || investmentFactors['default'];
        
        return `üìà Investment Potential for ${zoneName}

Score: ${factors.score}/10

‚úÖ Pros:
${factors.pros.map(p => `‚Ä¢ ${p}`).join('\n')}

‚ùå Cons:
${factors.cons.map(p => `‚Ä¢ ${p}`).join('\n')}

üí° Recommendation: ${factors.recommendation}

üìû Contact City of Kigali for market studies and feasibility analysis.`;
    }

    // Compare two zones
    function compareZones(zone1, zone2) {
        const reg1 = KIGALI_ZONING_REGULATIONS[zone1] || { description: 'Unknown', maxHeight: 'N/A', coverage: 'N/A' };
        const reg2 = KIGALI_ZONING_REGULATIONS[zone2] || { description: 'Unknown', maxHeight: 'N/A', coverage: 'N/A' };
        
        return `üÜö Zone Comparison: ${zone1} vs ${zone2}

${zone1}:
‚Ä¢ Description: ${reg1.description}
‚Ä¢ Max Height: ${reg1.maxHeight || 'N/A'}
‚Ä¢ Coverage: ${reg1.coverage || 'N/A'}
‚Ä¢ Permitted Uses: ${reg1.permitted ? reg1.permitted.slice(0, 3).join(', ') : 'N/A'}

${zone2}:
‚Ä¢ Description: ${reg2.description}
‚Ä¢ Max Height: ${reg2.maxHeight || 'N/A'}
‚Ä¢ Coverage: ${reg2.coverage || 'N/A'}
‚Ä¢ Permitted Uses: ${reg2.permitted ? reg2.permitted.slice(0, 3).join(', ') : 'N/A'}

üí° Tip: Choose based on your project needs and consult City of Kigali for detailed regulations.`;
    }

    // Generate procedural guidance
    function generateProcessGuidance() {
        return `üìã Development Process in Kigali

1. Verify Zoning: Confirm zoning regulations using TerraNebular.
2. Feasibility Study: Conduct market and technical feasibility analysis.
3. Submit Plans: Prepare architectural and engineering plans.
4. Apply for Permits: Submit to City of Kigali Planning Office.
5. Environmental Assessment: Complete EIA if required.
6. Community Consultation: Engage stakeholders if needed.
7. Construction: Follow approved plans and regulations.
8. Inspection: Schedule inspections during and after construction.

üìû Contact: City of Kigali Planning Office for assistance.
üåê More info: https://www.kigalicity.gov.rw/services/planning-and-construction`;
    }

    // Enhanced response generation
    function generateSmartResponse(question, zoning) {
        const zoneName = zoning.zoneName;
        const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
            description: 'Development zone per master plan',
            permitted: ['Check regulations'],
            prohibited: ['Check regulations'],
            conditional: ['Check regulations'],
            maxHeight: 'Check regulations',
            minLotSize: 'Check regulations',
            coverage: 'Check regulations'
        };
        const questionType = detectQuestionType(question);
        const buildingType = extractBuildingType(question);

        // Store question in conversation history
        conversationHistory.push({ question, zoneName });
        if (conversationHistory.length > 5) {
            conversationHistory.shift(); // Keep only last 5 for context
        }

        // Handle different question types
        switch (questionType) {
            case 'permission':
                if (!buildingType) {
                    return `üìç Zone: ${zoneName}

What you can build here:
‚úÖ PERMITTED: ${regulations.permitted.slice(0, 5).join(', ')}
‚ùå PROHIBITED: ${regulations.prohibited.slice(0, 3).join(', ')}
‚ö†Ô∏è CONDITIONAL: ${regulations.conditional.slice(0, 3).join(', ')}

üìè Max Height: ${regulations.maxHeight}
üìê Min Lot Size: ${regulations.minLotSize}
üèóÔ∏è Max Coverage: ${regulations.coverage}

üí° Specify a building type (e.g., restaurant, house) for detailed guidance.`;
                }

                const isPermitted = regulations.permitted.some(item => 
                    item.toLowerCase().includes(buildingType) || 
                    buildingType.includes(item.toLowerCase().split(' ')[0])
                );
                const isProhibited = regulations.prohibited.some(item => 
                    item.toLowerCase().includes(buildingType) || 
                    buildingType.includes(item.toLowerCase().split(' ')[0])
                );
                const isConditional = regulations.conditional.some(item => 
                    item.toLowerCase().includes(buildingType) || 
                    buildingType.includes(item.toLowerCase().split(' ')[0])
                );

                if (isPermitted) {
                    return `‚úÖ YES - ${buildingType.toUpperCase()} IS PERMITTED

Zone: ${zoneName}
Status: FULLY ALLOWED

üìã Requirements:
‚Ä¢ Min lot size: ${regulations.minLotSize}
‚Ä¢ Max height: ${regulations.maxHeight}
‚Ä¢ Max coverage: ${regulations.coverage}

üöÄ You can proceed with your ${buildingType} project!

‚öñÔ∏è Still need: Building permit from City of Kigali`;
                }
                if (isProhibited) {
                    return `‚ùå NO - ${buildingType.toUpperCase()} IS PROHIBITED

Zone: ${zoneName}
Status: NOT ALLOWED

üö´ Prohibited uses include:
${regulations.prohibited.slice(0, 4).map(item => `‚Ä¢ ${item}`).join('\n')}

üí° Consider these zones instead:
${getSuggestedZones(buildingType).join(', ')}

üìû Contact City of Kigali for alternative options.`;
                }
                if (isConditional) {
                    return `‚ö†Ô∏è MAYBE - ${buildingType.toUpperCase()} NEEDS APPROVAL

Zone: ${zoneName}
Status: CONDITIONAL USE

üìã Conditional uses in this zone:
${regulations.conditional.map(item => `‚Ä¢ ${item}`).join('\n')}

‚úÖ Next steps:
1. Apply for conditional use permit
2. Submit detailed plans to City of Kigali
3. Meet all specific requirements
4. Get community consultation if required

üìû Contact: City of Kigali Planning Office`;
                }

                return `‚ùì ${buildingType.toUpperCase()} - CHECK WITH AUTHORITIES

Zone: ${zoneName}

‚úÖ PERMITTED: ${regulations.permitted.slice(0, 3).join(', ')}
‚ùå PROHIBITED: ${regulations.prohibited.slice(0, 3).join(', ')}
‚ö†Ô∏è CONDITIONAL: ${regulations.conditional.slice(0, 3).join(', ')}

üìû Contact City of Kigali Planning Office for clarification.`;

            case 'height':
                return `üìè Maximum Height in ${zoneName}

Maximum Height: ${regulations.maxHeight}

üìã Details:
‚Ä¢ Description: ${regulations.description}
‚Ä¢ Coverage: ${regulations.coverage}
‚Ä¢ Additional Notes: ${regulations.specialNote || 'Follow City of Kigali building codes.'}

üìû Contact City of Kigali for height variance requests.`;

            case 'lot_size':
                return `üìê Minimum Lot Size in ${zoneName}

Minimum Lot Size: ${regulations.minLotSize}

üìã Details:
‚Ä¢ Description: ${regulations.description}
‚Ä¢ Coverage: ${regulations.coverage}
‚Ä¢ Additional Notes: ${regulations.specialNote || 'Consult City of Kigali for lot subdivision rules.'}

üìû Contact City of Kigali for lot size clarifications.`;

            case 'coverage':
                return `üèóÔ∏è Building Coverage in ${zoneName}

Maximum Coverage: ${regulations.coverage}

üìã Details:
‚Ä¢ Description: ${regulations.description}
‚Ä¢ Min Lot Size: ${regulations.minLotSize}
‚Ä¢ Additional Notes: ${regulations.specialNote || 'Ensure compliance with landscaping requirements.'}

üìû Contact City of Kigali for coverage regulations.`;

            case 'investment':
                return generateInvestmentAnalysis(zoneName, regulations);

            case 'comparison':
                const otherZoneMatch = question.match(/compare.*?(C1|C3|R1|R1A|R1B|R2|R3|R4|I1|I2|PF1|PF2|A1|P1|T|P3C)/i);
                const otherZone = otherZoneMatch ? `${otherZoneMatch[1]}-` + 
                    Object.keys(KIGALI_ZONING_REGULATIONS).find(z => z.startsWith(otherZoneMatch[1])) : null;
                
                if (otherZone) {
                    return compareZones(zoneName, otherZone);
                }
                return `üÜö Comparison Request

Please specify another zone to compare with ${zoneName} (e.g., "Compare with C3-City commercial zone").

üí° Available zones:
${Object.keys(KIGALI_ZONING_REGULATIONS).slice(0, 5).join(', ')}...`;

            case 'process':
                return generateProcessGuidance();

            default:
                // Check for follow-up questions based on history
                if (conversationHistory.length > 1) {
                    const prevQuestion = conversationHistory[conversationHistory.length - 2].question.toLowerCase();
                    if (prevQuestion.includes('build') && question.toLowerCase().includes('more details')) {
                        return `üìã Additional Details for ${zoneName}

Zone Description: ${regulations.description}

‚úÖ Permitted Uses:
${regulations.permitted.map(p => `‚Ä¢ ${p}`).join('\n')}

‚ùå Prohibited Uses:
${regulations.prohibited.map(p => `‚Ä¢ ${p}`).join('\n')}

‚ö†Ô∏è Conditional Uses:
${regulations.conditional.map(p => `‚Ä¢ ${p}`).join('\n')}

üìè Regulations:
‚Ä¢ Max Height: ${regulations.maxHeight}
‚Ä¢ Min Lot Size: ${regulations.minLotSize}
‚Ä¢ Max Coverage: ${regulations.coverage}
‚Ä¢ Landscaping: ${regulations.landscaping || 'N/A'}

üìû Contact City of Kigali for full regulatory details.`;
                    }
                }

                return `üåå General Information for ${zoneName}

Description: ${regulations.description}

‚úÖ PERMITTED: ${regulations.permitted.slice(0, 5).join(', ')}
‚ùå PROHIBITED: ${regulations.prohibited.slice(0, 3).join(', ')}
‚ö†Ô∏è CONDITIONAL: ${regulations.conditional.slice(0, 3).join(', ')}

üìè Key Regulations:
‚Ä¢ Max Height: ${regulations.maxHeight}
‚Ä¢ Min Lot Size: ${regulations.minLotSize}
‚Ä¢ Max Coverage: ${regulations.coverage}

üí° Ask specific questions like:
‚Ä¢ Can I build a restaurant here?
‚Ä¢ What's the maximum height?
‚Ä¢ What's the investment potential?

üìû Contact City of Kigali for detailed guidance.`;
        }
    }

    // Suggest alternative zones for a building type
    function getSuggestedZones(buildingType) {
        const suggestions = {
            'restaurant': ['C1-Mixed use zone', 'C3-City commercial zone', 'R2-Medium density residential - Improvement zone'],
            'hotel': ['C1-Mixed use zone', 'C3-City commercial zone', 'R4-High density residential zone'],
            'house': ['R1-Low density residential zone', 'R2-Medium density residential - Improvement zone', 'R3-Medium density residential - Expansion zone'],
            'shop': ['C1-Mixed use zone', 'C3-City commercial zone'],
            'apartment': ['R2-Medium density residential - Improvement zone', 'R3-Medium density residential - Expansion zone', 'R4-High density residential zone'],
            'office': ['C1-Mixed use zone', 'C3-City commercial zone', 'I1-Light industrial zone'],
            'warehouse': ['I1-Light industrial zone', 'I2-General industrial zone'],
            'factory': ['I1-Light industrial zone', 'I2-General industrial zone'],
            'shopping center': ['C3-City commercial zone'],
            'nightclub': ['C1-Mixed use zone', 'C3-City commercial zone'],
            'supermarket': ['C3-City commercial zone'],
            'school': ['PF1-Education and research facilities'],
            'hospital': ['PF2-Health facilities'],
            'farm': ['A1-Agriculture zone'],
            'greenhouse': ['A1-Agriculture zone'],
            'parking': ['T-Transportation zone', 'C1-Mixed use zone'],
            'transport': ['T-Transportation zone'],
            'petrol station': ['I1-Light industrial zone', 'C1-Mixed use zone'],
            'garage': ['I1-Light industrial zone']
        };
        
        return suggestions[buildingType] || ['C1-Mixed use zone', 'C3-City commercial zone'];
    }

    // Quick action buttons for common questions
    function addQuickActionButtons() {
        const chatContainer = document.getElementById('chatContainer');
        const quickActions = document.createElement('div');
        quickActions.className = 'quick-actions';
        quickActions.style.cssText = `
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        `;
        
        const actions = [
            { text: 'Can I build a restaurant?', question: 'Can I build a restaurant here?' },
            { text: 'Max height?', question: 'What is the maximum height?' },
            { text: 'Investment potential?', question: 'What is the investment potential?' },
            { text: 'Permit process?', question: 'What is the process to get a permit?' }
        ];

        actions.forEach(action => {
            const button = document.createElement('button');
            button.className = 'location-btn';
            button.textContent = action.text;
            button.onclick = () => askQuestion(action.question);
            quickActions.appendChild(button);
        });

        chatContainer.insertBefore(quickActions, chatContainer.querySelector('.ai-response'));
    }

    // Simulate asking a question
    function askQuestion(question) {
        const chatInput = document.getElementById('chatInput');
        chatInput.value = question;
        autoResizeTextarea();
        sendMessage();
    }

    // Update sendMessage to include quick action buttons
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const question = input.value.trim();
        
        if (!question || !currentZoning) return;
        
        const sendBtn = document.getElementById('sendBtn');
        const aiResponse = document.getElementById('aiResponse');
        const chatContainer = document.getElementById('chatContainer');
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '‚è≥';
        
        aiResponse.innerHTML = 'üåå Analyzing cosmic development patterns...';
        aiResponse.className = 'ai-response';
        chatContainer.classList.add('show');
        
        input.value = '';
        input.style.height = 'auto';
        
        setTimeout(() => {
            const response = generateSmartResponse(question, currentZoning);
            
            let responseClass = 'ai-response';
            if (response.includes('‚úÖ YES')) {
                responseClass += ' response-success';
            } else if (response.includes('‚ùå NO')) {
                responseClass += ' response-error';
            } else if (response.includes('‚ö†Ô∏è MAYBE')) {
                responseClass += ' response-warning';
            }
            
            aiResponse.innerHTML = response;
            aiResponse.className = responseClass;
            
            sendBtn.disabled = false;
            sendBtn.innerHTML = '‚û§';
            
            // Add quick action buttons after first response
            if (!chatContainer.querySelector('.quick-actions')) {
                addQuickActionButtons();
            }
        }, 1000);
    }

    // Update displayLocationInfo to initialize chat with quick actions
    function displayLocationInfo(zoning) {
        const zoneName = zoning.zoneName;
        const regulations = KIGALI_ZONING_REGULATIONS[zoneName] || {
            description: 'Development zone per master plan',
            maxHeight: 'Check regulations',
            coverage: 'Per regulations'
        };
        
        document.getElementById('zoneName').textContent = zoneName;
        document.getElementById('zoneDescription').textContent = regulations.description;
        
        const colorIndicator = document.getElementById('zoneColorIndicator');
        const zoneColor = ZONE_COLORS[zoneName] || '#999999';
        colorIndicator.style.background = zoneColor;
        
        document.getElementById('locationHeader').style.display = 'flex';
        
        const chatContainer = document.getElementById('chatContainer');
        const aiResponse = document.getElementById('aiResponse');
        
        aiResponse.innerHTML = `üåå Welcome to TerraNebular - where development dreams take shape.\n\nüìç You've selected: ${zoneName}\n\n‚ú® I'm your intelligent assistant for navigating Kigali's zoning regulations, building requirements, and development opportunities. What would you like to explore?`;
        aiResponse.className = 'ai-response response-success';
        chatContainer.classList.add('show');
        
        // Add quick action buttons
        if (!chatContainer.querySelector('.quick-actions')) {
            addQuickActionButtons();
        }
    }

    // Add location pin on map
    function addLocationPin(point) {
        require(["esri/Graphic", "esri/geometry/Point"], function(Graphic, Point) {
            view.graphics.removeAll();
            
            const pinSymbol = {
                type: "simple-marker",
                color: [236, 72, 153, 0.9],
                size: 12,
                outline: {
                    color: [255, 255, 255],
                    width: 2
                }
            };
            
            const pinGraphic = new Graphic({
                geometry: point,
                symbol: pinSymbol
            });
            
            view.graphics.add(pinGraphic);
        });
    }

    // Show bottom panel
    function showBottomPanel() {
        const panel = document.getElementById('bottomPanel');
        panel.classList.add('show');
    }

    // Show no data message
    function showNoDataMessage() {
        const chatContainer = document.getElementById('chatContainer');
        const aiResponse = document.getElementById('aiResponse');
        
        aiResponse.innerHTML = `üåå No zoning data found for this location.\n\nPlease try another location or load zoning data using the banner above.`;
        aiResponse.className = 'ai-response response-error';
        chatContainer.classList.add('show');
    }

    // Cache management functions
    const CACHE_KEY = 'kigali_zoning_data';
    const CACHE_VERSION = '1.0';

    function checkCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                if (data.version === CACHE_VERSION && data.features) {
                    console.log('üì¶ Found cached zoning data');
                    loadCachedData(data);
                    return;
                }
            }
        } catch (error) {
            console.warn('Cache check failed:', error);
        }
        
        showDataBanner();
    }

    function loadCachedData(data) {
        updateStatus('loading', 'Loading cached data...');
        
        setTimeout(() => {
            zoningFeatures = data.features;
            spatialIndex = new Map(data.index);
            
            updateStatus('ready', `${zoningFeatures.length} zones loaded`);
            showDataBanner(true);
            
            console.log('‚úÖ Cached data loaded successfully');
        }, 500);
    }

    function showDataBanner(loaded = false) {
        const banner = document.getElementById('dataBanner');
        
        if (loaded) {
            banner.innerHTML = '‚ú® Cosmic zoning data loaded successfully';
            banner.classList.add('loaded');
            banner.onclick = null;
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 3000);
        } else {
            banner.innerHTML = 'üåå Tap to load cosmic zoning data';
            banner.classList.remove('loaded');
            banner.onclick = loadDataFile;
        }
        
        banner.classList.add('show');
    }

    function updateStatus(status, text) {
        const dot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        dot.className = `status-dot ${status}`;
        
        // Add cosmic flair to status messages
        const cosmicMessages = {
            'loading': 'üåå Initializing cosmic sensors...',
            'ready': '‚ú® Ready to explore the development universe',
            'Location outside Kigali area': 'üöÄ Signal detected outside Kigali galaxy',
            'Location permission denied': 'üì° Cosmic location access denied',
            'Location unavailable': 'üõ∏ Unable to detect cosmic coordinates',
            'Location timeout': '‚è∞ Cosmic location scan timed out',
            'Location error': '‚ùå Cosmic navigation error',
            'Getting your location...': 'üõ∞Ô∏è Scanning your cosmic coordinates...',
            'Analyzing your location...': 'üîç Analyzing development potential...'
        };
        
        statusText.textContent = cosmicMessages[text] || text;
    }

    function loadDataFile() {
        document.getElementById('fileUpload').click();
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoading(true, 'Loading zoning data...');
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            await processZoningData(data);
            cacheZoningData();
            
            showLoading(false);
            showDataBanner(true);
            updateStatus('ready', `${zoningFeatures.length} zones loaded`);
            
        } catch (error) {
            showLoading(false);
            alert('‚ùå Error loading file: ' + error.message);
        }
    }

    async function processZoningData(data) {
        let features = [];
        
        if (data.type === 'FeatureCollection') {
            features = data.features;
        } else if (Array.isArray(data)) {
            features = data;
        } else if (data.features) {
            features = data.features;
        }
        
        if (!features || features.length === 0) {
            throw new Error('No features found in JSON file');
        }
        
        zoningFeatures = [];
        spatialIndex = new Map();
        
        for (let i = 0; i < features.length; i++) {
            const feature = features[i];
            const props = feature.properties || feature.attributes || feature;
            const zoneName = extractZoneName(props);
            
            if (zoneName) {
                const processedFeature = {
                    id: i,
                    zoneName: zoneName,
                    properties: props,
                    bounds: calculateBounds(feature.geometry)
                };
                
                zoningFeatures.push(processedFeature);
                
                if (processedFeature.bounds) {
                    const gridKey = Math.floor(processedFeature.bounds.centerLat * 1000) + ',' + 
                                   Math.floor(processedFeature.bounds.centerLng * 1000);
                    if (!spatialIndex.has(gridKey)) {
                        spatialIndex.set(gridKey, []);
                    }
                    spatialIndex.get(gridKey).push(processedFeature);
                }
            }
        }
    }

    function cacheZoningData() {
        try {
            const cacheData = {
                version: CACHE_VERSION,
                timestamp: Date.now(),
                features: zoningFeatures,
                index: Array.from(spatialIndex.entries())
            };
            
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            console.log('üíæ Zoning data cached successfully');
        } catch (error) {
            console.warn('Failed to cache data:', error);
        }
    }

    function extractZoneName(properties) {
        const possibleFields = [
            'New_Zoning', 'new_zoning', 'Zone_Code', 'zone_code',
            'zoning', 'ZONING', 'zone_name', 'type'
        ];
        
        for (const field of possibleFields) {
            if (properties[field] && typeof properties[field] === 'string') {
                return properties[field].trim();
            }
        }
        return null;
    }

    function calculateBounds(geometry) {
        if (!geometry || !geometry.coordinates) return null;
        
        try {
            let minLng = Infinity, maxLng = -Infinity;
            let minLat = Infinity, maxLat = -Infinity;
            
            const processCoordinates = (coords) => {
                if (typeof coords[0] === 'number') {
                    minLng = Math.min(minLng, coords[0]);
                    maxLng = Math.max(maxLng, coords[0]);
                    minLat = Math.min(minLat, coords[1]);
                    maxLat = Math.max(maxLat, coords[1]);
                } else {
                    coords.forEach(processCoordinates);
                }
            };
            
            processCoordinates(geometry.coordinates);
            
            return {
                minLng, maxLng, minLat, maxLat,
                centerLng: (minLng + maxLng) / 2,
                centerLat: (minLat + maxLat) / 2
            };
        } catch (error) {
            return null;
        }
    }

    function showLoading(show, text = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        
        if (show) {
            loadingText.textContent = text;
            overlay.classList.add('show');
        } else {
            overlay.classList.remove('show');
        }
    }

    async function handleMapClick(event) {
        if (zoningFeatures.length === 0) {
            showDataBanner();
            return;
        }
        
        currentLocation = event.mapPoint;
        const zoningResult = queryZoningData(event.mapPoint);
        
        if (zoningResult) {
            currentZoning = zoningResult;
            displayLocationInfo(zoningResult);
            showBottomPanel();
            addLocationPin(event.mapPoint);
        } else {
            showNoDataMessage();
        }
    }

    function queryZoningData(point) {
        const lat = point.latitude;
        const lng = point.longitude;
        
        const gridKey = Math.floor(lat * 1000) + ',' + Math.floor(lng * 1000);
        const nearbyFeatures = spatialIndex.get(gridKey) || [];
        
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                if (i === 0 && j === 0) continue;
                const nearbyKey = (Math.floor(lat * 1000) + i) + ',' + (Math.floor(lng * 1000) + j);
                const features = spatialIndex.get(nearbyKey) || [];
                nearbyFeatures.push(...features);
            }
        }
        
        for (const feature of nearbyFeatures) {
            if (feature.bounds && 
                lat >= feature.bounds.minLat && lat <= feature.bounds.maxLat &&
                lng >= feature.bounds.minLng && lng <= feature.bounds.maxLng) {
                
                return {
                    zoneName: feature.zoneName,
                    properties: feature.properties,
                    source: 'official',
                    featureId: feature.id
                };
            }
        }
        
        let nearest = null;
        let minDistance = Infinity;
        
        for (const feature of zoningFeatures.slice(0, 500)) {
            if (!feature.bounds) continue;
            
            const distance = Math.sqrt(
                Math.pow(lat - feature.bounds.centerLat, 2) + 
                Math.pow(lng - feature.bounds.centerLng, 2)
            );
            
            if (distance < minDistance && distance < 0.005) {
                minDistance = distance;
                nearest = {
                    zoneName: feature.zoneName,
                    properties: feature.properties,
                    source: 'approximate',
                    distance: (distance * 111).toFixed(1),
                    featureId: feature.id
                };
            }
        }
        
        return nearest;
    }
</script>
