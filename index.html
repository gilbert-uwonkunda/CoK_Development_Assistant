<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>üåå TerraNebular | Spatial Intelligence</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --nebular-deep-blue: #0F172A;
            --nebular-space-blue: #1E3A8A;
            --nebular-cosmic-purple: #6366F1;
            --nebular-stellar-gold: #F59E0B;
            --nebular-plasma-pink: #EC4899;
            --nebular-stardust: #E2E8F0;
            --nebular-aurora-green: #10B981;
            --nebular-comet-white: #F8FAFC;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--nebular-deep-blue);
            overflow: hidden; height: 100vh;
            display: flex;
        }

        .app-container { display: flex; width: 100%; height: 100vh; z-index: 2; }

        /* Left Panel */
        #leftPanel {
            width: 400px; min-width: 350px;
            background: var(--nebular-comet-white);
            box-shadow: 4px 0 32px rgba(15, 23, 42, 0.2);
            z-index: 1000; display: flex; flex-direction: column;
            position: relative; transition: width 0.3s ease;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--nebular-deep-blue), var(--nebular-cosmic-purple));
            color: white; padding: 16px 20px;
        }

        .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .brand-section { display: flex; align-items: center; gap: 10px; }
        
        /* Language Buttons */
        .language-selector { display: flex; gap: 4px; background: rgba(255,255,255,0.1); padding: 4px; border-radius: 8px; }
        .lang-btn { 
            background: transparent; border: none; color: rgba(255,255,255,0.6); 
            padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; 
        }
        .lang-btn.active { background: var(--nebular-stellar-gold); color: var(--nebular-deep-blue); font-weight: bold; }

        .location-btn {
            background: linear-gradient(135deg, var(--nebular-stellar-gold), #F97316);
            color: white; border: none; padding: 8px 16px; border-radius: 20px;
            font-size: 12px; font-weight: 600; cursor: pointer;
        }

        /* Map Area */
        #mapContainer { flex: 1; position: relative; background: #eee; }
        #viewDiv { height: 100%; width: 100%; }

        /* Chat Elements */
        .panel-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .location-header { 
            display: flex; align-items: center; gap: 12px; padding: 15px; 
            background: #f1f5f9; border-radius: 12px; 
        }
        .zone-color-indicator { width: 24px; height: 24px; border-radius: 6px; flex-shrink: 0; border: 2px solid white; }
        
        .ai-response {
            background: white; padding: 16px; border-radius: 12px;
            font-size: 14px; line-height: 1.6; color: var(--nebular-deep-blue);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 1; overflow-y: auto;
            white-space: pre-wrap;
        }

        .chat-input-container { display: flex; gap: 8px; margin-top: auto; padding-top: 10px; }
        .chat-input { 
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; 
            outline: none; font-family: inherit; resize: none;
        }
        .send-btn { 
            background: var(--nebular-cosmic-purple); color: white; border: none; 
            width: 42px; height: 42px; border-radius: 50%; cursor: pointer; 
        }

        /* Splash Screen */
        .splash {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, var(--nebular-space-blue), var(--nebular-deep-blue));
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: opacity 0.5s ease;
        }
        .splash.hidden { opacity: 0; pointer-events: none; }
        .enter-btn {
            margin-top: 30px; padding: 15px 40px; border-radius: 30px;
            background: var(--nebular-stellar-gold); border: none; color: white;
            font-weight: bold; cursor: pointer; font-size: 18px;
        }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            #leftPanel { width: 100%; height: 45vh; }
        }
    </style>
</head>
<body>

    <div id="splash" class="splash">
        <h1 style="font-size: 3rem; margin-bottom: 0;">üåå TerraNebular</h1>
        <p style="opacity: 0.8; font-style: italic;">Kigali Spatial Intelligence Platform</p>
        <button class="enter-btn" onclick="enterApp()">‚ú® Launch Platform</button>
    </div>

    <div class="app-container">
        <div id="leftPanel">
            <div class="panel-header">
                <div class="header-top-row">
                    <div class="brand-section">
                        <span>üåå</span>
                        <h2 style="margin:0; font-size: 18px;">TerraNebular</h2>
                    </div>
                    <div class="language-selector">
                        <button class="lang-btn active" onclick="setLang('en', this)">EN</button>
                        <button class="lang-btn" onclick="setLang('rw', this)">RW</button>
                        <button class="lang-btn" onclick="setLang('fr', this)">FR</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button class="location-btn" onclick="useGPS()">üìç Use My Location</button>
                    <div id="status" style="font-size: 11px; opacity: 0.8;">Ready</div>
                </div>
            </div>

            <div class="panel-content">
                <div id="locationHeader" class="location-header" style="display:none;">
                    <div id="zoneColor" class="zone-color-indicator"></div>
                    <div>
                        <div id="zoneName" style="font-weight: bold; font-size: 15px;">Select a location</div>
                        <div id="zoneSub" style="font-size: 12px; color: #666;">Click map to begin</div>
                    </div>
                </div>

                <div id="aiResponse" class="ai-response">
                    Click anywhere on the map of Kigali to retrieve zoning regulations and start your AI analysis.
                </div>

                <div id="actionBtns" style="display:none; gap: 8px;">
                    <button onclick="downloadPDF()" style="flex:1; padding: 8px; cursor:pointer;">üìÑ Report</button>
                    <button onclick="share()" style="flex:1; padding: 8px; cursor:pointer;">üì§ Share</button>
                </div>

                <div class="chat-input-container">
                    <textarea id="chatInput" class="chat-input" placeholder="Ask about zoning..." rows="1"></textarea>
                    <button class="send-btn" onclick="sendMsg()">‚û§</button>
                </div>
            </div>
        </div>

        <div id="mapContainer">
            <div id="viewDiv"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let map, marker, currentData = null;
        let lang = 'en';
        const API_URL = 'https://cok-development-assistant.onrender.com/api';

        function enterApp() {
            document.getElementById('splash').classList.add('hidden');
            initMap();
        }

        function initMap() {
            // Initialize Leaflet
            map = L.map('viewDiv', { zoomControl: false }).setView([-1.9441, 30.0619], 13);

            // High-quality Esri Satellite Tiles (Free to use via Leaflet)
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);

            map.on('click', onMapClick);
        }

        async function onMapClick(e) {
            const { lat, lng } = e.latlng;
            
            // UI Feedback
            if (marker) map.removeLayer(marker);
            marker = L.circleMarker([lat, lng], { radius: 8, color: '#fff', fillColor: '#EC4899', fillOpacity: 1 }).addTo(map);
            
            document.getElementById('status').innerText = "Querying PostGIS...";
            document.getElementById('aiResponse').innerText = "Fetching zoning data from PostGIS database...";

            try {
                const res = await fetch(`${API_URL}/zoning/location?lat=${lat}&lng=${lng}`);
                const json = await res.json();
                
                if (json.success && json.data.zoneData) {
                    currentData = { lat, lng, ...json.data.zoneData };
                    updateUI(currentData);
                } else {
                    document.getElementById('aiResponse').innerText = "No zoning data found for this specific point.";
                }
            } catch (err) {
                document.getElementById('aiResponse').innerText = "Error connecting to Render backend.";
            }
            document.getElementById('status').innerText = "Connected";
        }

        function updateUI(data) {
            document.getElementById('locationHeader').style.display = 'flex';
            document.getElementById('zoneName').innerText = data.zone_name;
            document.getElementById('zoneSub').innerText = data.phase || "Master Plan 2030";
            document.getElementById('zoneColor').style.backgroundColor = getZoneColor(data.zone_name);
            
            const msg = `üìç Location Selected: ${data.zone_name}\n\nI have retrieved the official regulations from the PostGIS database. What would you like to know about development in this area?`;
            document.getElementById('aiResponse').innerText = msg;
            document.getElementById('actionBtns').style.display = 'none';
        }

        async function sendMsg() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            if (!question || !currentData) return;

            document.getElementById('aiResponse').innerText = "AI is analyzing regulations...";
            input.value = '';

            try {
                const res = await fetch(`${API_URL}/ai/question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question,
                        lat: currentData.lat,
                        lng: currentData.lng,
                        language: lang
                    })
                });
                const json = await res.json();
                document.getElementById('aiResponse').innerText = json.data.response;
                document.getElementById('actionBtns').style.display = 'flex';
            } catch (err) {
                document.getElementById('aiResponse').innerText = "AI Service currently unavailable.";
            }
        }

        function getZoneColor(name) {
            if (name.includes('R1')) return '#FFFFE0';
            if (name.includes('C')) return '#CD5626';
            if (name.includes('A')) return '#90EE90';
            return '#6366F1';
        }

        function setLang(l, btn) {
            lang = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function useGPS() {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 16);
                onMapClick({ latlng: { lat: latitude, lng: longitude } });
            });
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("TerraNebular Zoning Report", 10, 10);
            doc.text(`Zone: ${currentData.zone_name}`, 10, 20);
            doc.text(doc.splitTextToSize(document.getElementById('aiResponse').innerText, 180), 10, 30);
            doc.save("TerraNebular_Report.pdf");
        }
    </script>
</body>
</html>
